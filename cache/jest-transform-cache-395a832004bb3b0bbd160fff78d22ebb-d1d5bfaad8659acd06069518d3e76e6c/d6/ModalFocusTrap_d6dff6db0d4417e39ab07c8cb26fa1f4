29fbc11e48509bc2bad00a0700e842f0
"use strict";

exports.__esModule = true;
exports.default = void 0;

var React = _interopRequireWildcard(require("react"));

var _ExecutionEnvironment = require("fbjs/lib/ExecutionEnvironment");

var _View = _interopRequireDefault(require("../View"));

var _createElement = _interopRequireDefault(require("../createElement"));

var _StyleSheet = _interopRequireDefault(require("../StyleSheet"));

var _UIManager = _interopRequireDefault(require("../UIManager"));

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {
    default: obj
  };
}

function _getRequireWildcardCache() {
  if (typeof WeakMap !== "function") return null;
  var cache = new WeakMap();

  _getRequireWildcardCache = function _getRequireWildcardCache() {
    return cache;
  };

  return cache;
}

function _interopRequireWildcard(obj) {
  if (obj && obj.__esModule) {
    return obj;
  }

  if (obj === null || typeof obj !== "object" && typeof obj !== "function") {
    return {
      default: obj
    };
  }

  var cache = _getRequireWildcardCache();

  if (cache && cache.has(obj)) {
    return cache.get(obj);
  }

  var newObj = {};
  var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor;

  for (var key in obj) {
    if (Object.prototype.hasOwnProperty.call(obj, key)) {
      var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null;

      if (desc && (desc.get || desc.set)) {
        Object.defineProperty(newObj, key, desc);
      } else {
        newObj[key] = obj[key];
      }
    }
  }

  newObj.default = obj;

  if (cache) {
    cache.set(obj, newObj);
  }

  return newObj;
}

var FocusBracket = function FocusBracket() {
  return (0, _createElement.default)('div', {
    accessibilityRole: 'none',
    tabIndex: 0,
    style: styles.focusBracket
  });
};

function attemptFocus(element) {
  if (!_ExecutionEnvironment.canUseDOM) {
    return false;
  }

  try {
    element.focus();
  } catch (e) {}

  return document.activeElement === element;
}

function focusFirstDescendant(element) {
  for (var i = 0; i < element.childNodes.length; i++) {
    var child = element.childNodes[i];

    if (attemptFocus(child) || focusFirstDescendant(child)) {
      return true;
    }
  }

  return false;
}

function focusLastDescendant(element) {
  for (var i = element.childNodes.length - 1; i >= 0; i--) {
    var child = element.childNodes[i];

    if (attemptFocus(child) || focusLastDescendant(child)) {
      return true;
    }
  }

  return false;
}

var ModalFocusTrap = function ModalFocusTrap(_ref) {
  var active = _ref.active,
      children = _ref.children;
  var trapElementRef = React.useRef();
  var focusRef = React.useRef({
    trapFocusInProgress: false,
    lastFocusedElement: null
  });
  React.useEffect(function () {
    if (_ExecutionEnvironment.canUseDOM) {
      var trapFocus = function trapFocus() {
        if (trapElementRef.current == null || focusRef.current.trapFocusInProgress || !active) {
          return;
        }

        try {
          focusRef.current.trapFocusInProgress = true;

          if (document.activeElement instanceof Node && !trapElementRef.current.contains(document.activeElement)) {
            var hasFocused = focusFirstDescendant(trapElementRef.current);

            if (focusRef.current.lastFocusedElement === document.activeElement) {
              hasFocused = focusLastDescendant(trapElementRef.current);
            }

            if (!hasFocused && trapElementRef.current != null && document.activeElement) {
              _UIManager.default.focus(trapElementRef.current);
            }
          }
        } finally {
          focusRef.current.trapFocusInProgress = false;
        }

        focusRef.current.lastFocusedElement = document.activeElement;
      };

      trapFocus();
      document.addEventListener('focus', trapFocus, true);
      return function () {
        return document.removeEventListener('focus', trapFocus, true);
      };
    }
  }, [active]);
  React.useEffect(function () {
    if (_ExecutionEnvironment.canUseDOM) {
      var lastFocusedElementOutsideTrap = document.activeElement;
      return function () {
        if (lastFocusedElementOutsideTrap && document.contains(lastFocusedElementOutsideTrap)) {
          _UIManager.default.focus(lastFocusedElementOutsideTrap);
        }
      };
    }
  }, []);
  return React.createElement(React.Fragment, null, React.createElement(FocusBracket, null), React.createElement(_View.default, {
    ref: trapElementRef
  }, children), React.createElement(FocusBracket, null));
};

var _default = ModalFocusTrap;
exports.default = _default;

var styles = _StyleSheet.default.create({
  focusBracket: {
    outlineStyle: 'none'
  }
});

module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIk1vZGFsRm9jdXNUcmFwLmpzIl0sIm5hbWVzIjpbImV4cG9ydHMiLCJfX2VzTW9kdWxlIiwiZGVmYXVsdCIsIlJlYWN0IiwiX2ludGVyb3BSZXF1aXJlV2lsZGNhcmQiLCJyZXF1aXJlIiwiX0V4ZWN1dGlvbkVudmlyb25tZW50IiwiX1ZpZXciLCJfaW50ZXJvcFJlcXVpcmVEZWZhdWx0IiwiX2NyZWF0ZUVsZW1lbnQiLCJfU3R5bGVTaGVldCIsIl9VSU1hbmFnZXIiLCJvYmoiLCJfZ2V0UmVxdWlyZVdpbGRjYXJkQ2FjaGUiLCJXZWFrTWFwIiwiY2FjaGUiLCJoYXMiLCJnZXQiLCJuZXdPYmoiLCJoYXNQcm9wZXJ0eURlc2NyaXB0b3IiLCJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsImtleSIsInByb3RvdHlwZSIsImhhc093blByb3BlcnR5IiwiY2FsbCIsImRlc2MiLCJzZXQiLCJGb2N1c0JyYWNrZXQiLCJhY2Nlc3NpYmlsaXR5Um9sZSIsInRhYkluZGV4Iiwic3R5bGUiLCJzdHlsZXMiLCJmb2N1c0JyYWNrZXQiLCJhdHRlbXB0Rm9jdXMiLCJlbGVtZW50IiwiY2FuVXNlRE9NIiwiZm9jdXMiLCJlIiwiZG9jdW1lbnQiLCJhY3RpdmVFbGVtZW50IiwiZm9jdXNGaXJzdERlc2NlbmRhbnQiLCJpIiwiY2hpbGROb2RlcyIsImxlbmd0aCIsImNoaWxkIiwiZm9jdXNMYXN0RGVzY2VuZGFudCIsIk1vZGFsRm9jdXNUcmFwIiwiX3JlZiIsImFjdGl2ZSIsImNoaWxkcmVuIiwidHJhcEVsZW1lbnRSZWYiLCJ1c2VSZWYiLCJmb2N1c1JlZiIsInRyYXBGb2N1c0luUHJvZ3Jlc3MiLCJsYXN0Rm9jdXNlZEVsZW1lbnQiLCJ1c2VFZmZlY3QiLCJ0cmFwRm9jdXMiLCJjdXJyZW50IiwiTm9kZSIsImNvbnRhaW5zIiwiaGFzRm9jdXNlZCIsImFkZEV2ZW50TGlzdGVuZXIiLCJyZW1vdmVFdmVudExpc3RlbmVyIiwibGFzdEZvY3VzZWRFbGVtZW50T3V0c2lkZVRyYXAiLCJjcmVhdGVFbGVtZW50IiwiRnJhZ21lbnQiLCJyZWYiLCJfZGVmYXVsdCIsImNyZWF0ZSIsIm91dGxpbmVTdHlsZSIsIm1vZHVsZSJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUFBLE9BQU8sQ0FBQ0MsVUFBUixHQUFxQixJQUFyQjtBQUNBRCxPQUFPLENBQUNFLE9BQVIsR0FBa0IsS0FBSyxDQUF2Qjs7QUFFQSxJQUFJQyxLQUFLLEdBQUdDLHVCQUF1QixDQUFDQyxPQUFPLENBQUMsT0FBRCxDQUFSLENBQW5DOztBQUVBLElBQUlDLHFCQUFxQixHQUFHRCxPQUFPLENBQUMsK0JBQUQsQ0FBbkM7O0FBRUEsSUFBSUUsS0FBSyxHQUFHQyxzQkFBc0IsQ0FBQ0gsT0FBTyxXQUFSLENBQWxDOztBQUVBLElBQUlJLGNBQWMsR0FBR0Qsc0JBQXNCLENBQUNILE9BQU8sb0JBQVIsQ0FBM0M7O0FBRUEsSUFBSUssV0FBVyxHQUFHRixzQkFBc0IsQ0FBQ0gsT0FBTyxpQkFBUixDQUF4Qzs7QUFFQSxJQUFJTSxVQUFVLEdBQUdILHNCQUFzQixDQUFDSCxPQUFPLGdCQUFSLENBQXZDOztBQUVBLFNBQVNHLHNCQUFULENBQWdDSSxHQUFoQyxFQUFxQztBQUFFLFNBQU9BLEdBQUcsSUFBSUEsR0FBRyxDQUFDWCxVQUFYLEdBQXdCVyxHQUF4QixHQUE4QjtBQUFFVixJQUFBQSxPQUFPLEVBQUVVO0FBQVgsR0FBckM7QUFBd0Q7O0FBRS9GLFNBQVNDLHdCQUFULEdBQW9DO0FBQUUsTUFBSSxPQUFPQyxPQUFQLEtBQW1CLFVBQXZCLEVBQW1DLE9BQU8sSUFBUDtBQUFhLE1BQUlDLEtBQUssR0FBRyxJQUFJRCxPQUFKLEVBQVo7O0FBQTJCRCxFQUFBQSx3QkFBd0IsR0FBRyxTQUFTQSx3QkFBVCxHQUFvQztBQUFFLFdBQU9FLEtBQVA7QUFBZSxHQUFoRjs7QUFBa0YsU0FBT0EsS0FBUDtBQUFlOztBQUVsTixTQUFTWCx1QkFBVCxDQUFpQ1EsR0FBakMsRUFBc0M7QUFB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dHMuX19lc01vZHVsZSA9IHRydWU7XG5leHBvcnRzLmRlZmF1bHQgPSB2b2lkIDA7XG5cbnZhciBSZWFjdCA9IF9pbnRlcm9wUmVxdWlyZVdpbGRjYXJkKHJlcXVpcmUoXCJyZWFjdFwiKSk7XG5cbnZhciBfRXhlY3V0aW9uRW52aXJvbm1lbnQgPSByZXF1aXJlKFwiZmJqcy9saWIvRXhlY3V0aW9uRW52aXJvbm1lbnRcIik7XG5cbnZhciBfVmlldyA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZShcIi4uL1ZpZXdcIikpO1xuXG52YXIgX2NyZWF0ZUVsZW1lbnQgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoXCIuLi9jcmVhdGVFbGVtZW50XCIpKTtcblxudmFyIF9TdHlsZVNoZWV0ID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKFwiLi4vU3R5bGVTaGVldFwiKSk7XG5cbnZhciBfVUlNYW5hZ2VyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKFwiLi4vVUlNYW5hZ2VyXCIpKTtcblxuZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgZGVmYXVsdDogb2JqIH07IH1cblxuZnVuY3Rpb24gX2dldFJlcXVpcmVXaWxkY2FyZENhY2hlKCkgeyBpZiAodHlwZW9mIFdlYWtNYXAgIT09IFwiZnVuY3Rpb25cIikgcmV0dXJuIG51bGw7IHZhciBjYWNoZSA9IG5ldyBXZWFrTWFwKCk7IF9nZXRSZXF1aXJlV2lsZGNhcmRDYWNoZSA9IGZ1bmN0aW9uIF9nZXRSZXF1aXJlV2lsZGNhcmRDYWNoZSgpIHsgcmV0dXJuIGNhY2hlOyB9OyByZXR1cm4gY2FjaGU7IH1cblxuZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlV2lsZGNhcmQob2JqKSB7IGlmIChvYmogJiYgb2JqLl9fZXNNb2R1bGUpIHsgcmV0dXJuIG9iajsgfSBpZiAob2JqID09PSBudWxsIHx8IHR5cGVvZiBvYmogIT09IFwib2JqZWN0XCIgJiYgdHlwZW9mIG9iaiAhPT0gXCJmdW5jdGlvblwiKSB7IHJldHVybiB7IGRlZmF1bHQ6IG9iaiB9OyB9IHZhciBjYWNoZSA9IF9nZXRSZXF1aXJlV2lsZGNhcmRDYWNoZSgpOyBpZiAoY2FjaGUgJiYgY2FjaGUuaGFzKG9iaikpIHsgcmV0dXJuIGNhY2hlLmdldChvYmopOyB9IHZhciBuZXdPYmogPSB7fTsgdmFyIGhhc1Byb3BlcnR5RGVzY3JpcHRvciA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSAmJiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yOyBmb3IgKHZhciBrZXkgaW4gb2JqKSB7IGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqLCBrZXkpKSB7IHZhciBkZXNjID0gaGFzUHJvcGVydHlEZXNjcmlwdG9yID8gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihvYmosIGtleSkgOiBudWxsOyBpZiAoZGVzYyAmJiAoZGVzYy5nZXQgfHwgZGVzYy5zZXQpKSB7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShuZXdPYmosIGtleSwgZGVzYyk7IH0gZWxzZSB7IG5ld09ialtrZXldID0gb2JqW2tleV07IH0gfSB9IG5ld09iai5kZWZhdWx0ID0gb2JqOyBpZiAoY2FjaGUpIHsgY2FjaGUuc2V0KG9iaiwgbmV3T2JqKTsgfSByZXR1cm4gbmV3T2JqOyB9XG5cbi8qKlxuICogQ29weXJpZ2h0IChjKSBOaWNvbGFzIEdhbGxhZ2hlci5cbiAqIENvcHlyaWdodCAoYykgRmFjZWJvb2ssIEluYy4gYW5kIGl0cyBhZmZpbGlhdGVzLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZVxuICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICpcbiAqIFxuICovXG5cbi8qKlxuICogVGhpcyBDb21wb25lbnQgaXMgdXNlZCB0byBcIndyYXBcIiB0aGUgbW9kYWwgd2UncmUgb3BlbmluZ1xuICogc28gdGhhdCBjaGFuZ2luZyBmb2N1cyB2aWEgdGFiIHdpbGwgbmV2ZXIgbGVhdmUgdGhlIGRvY3VtZW50LlxuICpcbiAqIFRoaXMgYWxsb3dzIHVzIHRvIHByb3Blcmx5IHRyYXAgdGhlIGZvY3VzIHdpdGhpbiBhIG1vZGFsXG4gKiBldmVuIGlmIHRoZSBtb2RhbCBpcyBhdCB0aGUgc3RhcnQgb3IgZW5kIG9mIGEgZG9jdW1lbnQuXG4gKi9cbnZhciBGb2N1c0JyYWNrZXQgPSBmdW5jdGlvbiBGb2N1c0JyYWNrZXQoKSB7XG4gIHJldHVybiAoMCwgX2NyZWF0ZUVsZW1lbnQuZGVmYXVsdCkoJ2RpdicsIHtcbiAgICBhY2Nlc3NpYmlsaXR5Um9sZTogJ25vbmUnLFxuICAgIHRhYkluZGV4OiAwLFxuICAgIHN0eWxlOiBzdHlsZXMuZm9jdXNCcmFja2V0XG4gIH0pO1xufTtcblxuZnVuY3Rpb24gYXR0ZW1wdEZvY3VzKGVsZW1lbnQpIHtcbiAgaWYgKCFfRXhlY3V0aW9uRW52aXJvbm1lbnQuY2FuVXNlRE9NKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgdHJ5IHtcbiAgICBlbGVtZW50LmZvY3VzKCk7XG4gIH0gY2F0Y2ggKGUpIHsvLyBEbyBub3RoaW5nXG4gIH1cblxuICByZXR1cm4gZG9jdW1lbnQuYWN0aXZlRWxlbWVudCA9PT0gZWxlbWVudDtcbn1cblxuZnVuY3Rpb24gZm9jdXNGaXJzdERlc2NlbmRhbnQoZWxlbWVudCkge1xuICBmb3IgKHZhciBpID0gMDsgaSA8IGVsZW1lbnQuY2hpbGROb2Rlcy5sZW5ndGg7IGkrKykge1xuICAgIHZhciBjaGlsZCA9IGVsZW1lbnQuY2hpbGROb2Rlc1tpXTtcblxuICAgIGlmIChhdHRlbXB0Rm9jdXMoY2hpbGQpIHx8IGZvY3VzRmlyc3REZXNjZW5kYW50KGNoaWxkKSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGZhbHNlO1xufVxuXG5mdW5jdGlvbiBmb2N1c0xhc3REZXNjZW5kYW50KGVsZW1lbnQpIHtcbiAgZm9yICh2YXIgaSA9IGVsZW1lbnQuY2hpbGROb2Rlcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xuICAgIHZhciBjaGlsZCA9IGVsZW1lbnQuY2hpbGROb2Rlc1tpXTtcblxuICAgIGlmIChhdHRlbXB0Rm9jdXMoY2hpbGQpIHx8IGZvY3VzTGFzdERlc2NlbmRhbnQoY2hpbGQpKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gZmFsc2U7XG59XG5cbnZhciBNb2RhbEZvY3VzVHJhcCA9IGZ1bmN0aW9uIE1vZGFsRm9jdXNUcmFwKF9yZWYpIHtcbiAgdmFyIGFjdGl2ZSA9IF9yZWYuYWN0aXZlLFxuICAgICAgY2hpbGRyZW4gPSBfcmVmLmNoaWxkcmVuO1xuICB2YXIgdHJhcEVsZW1lbnRSZWYgPSBSZWFjdC51c2VSZWYoKTtcbiAgdmFyIGZvY3VzUmVmID0gUmVhY3QudXNlUmVmKHtcbiAgICB0cmFwRm9jdXNJblByb2dyZXNzOiBmYWxzZSxcbiAgICBsYXN0Rm9jdXNlZEVsZW1lbnQ6IG51bGxcbiAgfSk7XG4gIFJlYWN0LnVzZUVmZmVjdChmdW5jdGlvbiAoKSB7XG4gICAgaWYgKF9FeGVjdXRpb25FbnZpcm9ubWVudC5jYW5Vc2VET00pIHtcbiAgICAgIHZhciB0cmFwRm9jdXMgPSBmdW5jdGlvbiB0cmFwRm9jdXMoKSB7XG4gICAgICAgIC8vIFdlIHNob3VsZCBub3QgdHJhcCBmb2N1cyBpZjpcbiAgICAgICAgLy8gLSBUaGUgbW9kYWwgaGFzbid0IGZ1bGx5IGluaXRpYWxpemVkIHdpdGggYW4gSFRNTEVsZW1lbnQgcmVmXG4gICAgICAgIC8vIC0gRm9jdXMgaXMgYWxyZWFkeSBpbiB0aGUgcHJvY2VzcyBvZiBiZWluZyB0cmFwcGVkIChlLmcuLCB3ZSdyZSByZWZvY3VzaW5nKVxuICAgICAgICAvLyAtIGlzVHJhcEFjdGl2ZSBwcm9wIGJlaW5nIGZhbHNleSB0ZWxscyB1cyB0byBkbyBub3RoaW5nXG4gICAgICAgIGlmICh0cmFwRWxlbWVudFJlZi5jdXJyZW50ID09IG51bGwgfHwgZm9jdXNSZWYuY3VycmVudC50cmFwRm9jdXNJblByb2dyZXNzIHx8ICFhY3RpdmUpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICB0cnkge1xuICAgICAgICAgIGZvY3VzUmVmLmN1cnJlbnQudHJhcEZvY3VzSW5Qcm9ncmVzcyA9IHRydWU7XG5cbiAgICAgICAgICBpZiAoZG9jdW1lbnQuYWN0aXZlRWxlbWVudCBpbnN0YW5jZW9mIE5vZGUgJiYgIXRyYXBFbGVtZW50UmVmLmN1cnJlbnQuY29udGFpbnMoZG9jdW1lbnQuYWN0aXZlRWxlbWVudCkpIHtcbiAgICAgICAgICAgIC8vIFRvIGhhbmRsZSBrZXlib2FyZCBmb2N1c2luZyB3ZSBjYW4gbWFrZSBhbiBhc3N1bXB0aW9uIGhlcmUuXG4gICAgICAgICAgICAvLyBJZiB5b3UncmUgdGFiYmluZyB0aHJvdWdoIHRoZSBmb2N1c2FibGUgZWxlbWVudHMsIHRoZSBwcmV2aW91c2x5XG4gICAgICAgICAgICAvLyBhY3RpdmUgZWxlbWVudCB3aWxsIGVpdGhlciBiZSB0aGUgZmlyc3Qgb3IgdGhlIGxhc3QuXG4gICAgICAgICAgICAvLyBJZiB0aGUgcHJldmlvdXNseSBzZWxlY3RlZCBlbGVtZW50IGlzIHRoZSBcImZpcnN0XCIgZGVzY2VuZGFudFxuICAgICAgICAgICAgLy8gYW5kIHdlJ3JlIGxlYXZpbmcgaXQgLSB0aGlzIG1lYW5zIHRoYXQgd2Ugc2hvdWxkIGJlIGxvb3BpbmdcbiAgICAgICAgICAgIC8vIGFyb3VuZCB0byB0aGUgb3RoZXIgc2lkZSBvZiB0aGUgbW9kYWwuXG4gICAgICAgICAgICB2YXIgaGFzRm9jdXNlZCA9IGZvY3VzRmlyc3REZXNjZW5kYW50KHRyYXBFbGVtZW50UmVmLmN1cnJlbnQpO1xuXG4gICAgICAgICAgICBpZiAoZm9jdXNSZWYuY3VycmVudC5sYXN0Rm9jdXNlZEVsZW1lbnQgPT09IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQpIHtcbiAgICAgICAgICAgICAgaGFzRm9jdXNlZCA9IGZvY3VzTGFzdERlc2NlbmRhbnQodHJhcEVsZW1lbnRSZWYuY3VycmVudCk7XG4gICAgICAgICAgICB9IC8vIElmIHdlIGNvdWxkbid0IGZvY3VzIGEgbmV3IGVsZW1lbnQgdGhlbiB3ZSBuZWVkIHRvIGZvY3VzIG9udG8gdGhlIHRyYXAgdGFyZ2V0XG5cblxuICAgICAgICAgICAgaWYgKCFoYXNGb2N1c2VkICYmIHRyYXBFbGVtZW50UmVmLmN1cnJlbnQgIT0gbnVsbCAmJiBkb2N1bWVudC5hY3RpdmVFbGVtZW50KSB7XG4gICAgICAgICAgICAgIF9VSU1hbmFnZXIuZGVmYXVsdC5mb2N1cyh0cmFwRWxlbWVudFJlZi5jdXJyZW50KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgZm9jdXNSZWYuY3VycmVudC50cmFwRm9jdXNJblByb2dyZXNzID0gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICBmb2N1c1JlZi5jdXJyZW50Lmxhc3RGb2N1c2VkRWxlbWVudCA9IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQ7XG4gICAgICB9OyAvLyBDYWxsIHRoZSB0cmFwRm9jdXMgY2FsbGJhY2sgYXQgbGVhc3Qgb25jZSB3aGVuIHRoaXMgbW9kYWwgaGFzIGJlZW4gYWN0aXZhdGVkLlxuXG5cbiAgICAgIHRyYXBGb2N1cygpO1xuICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignZm9jdXMnLCB0cmFwRm9jdXMsIHRydWUpO1xuICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgcmV0dXJuIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2ZvY3VzJywgdHJhcEZvY3VzLCB0cnVlKTtcbiAgICAgIH07XG4gICAgfVxuICB9LCBbYWN0aXZlXSk7IC8vIFRvIGJlIGZ1bGx5IGNvbXBsaWFudCB3aXRoIFdDQUcgd2UgbmVlZCB0byByZWZvY3VzIGVsZW1lbnQgdGhhdCB0cmlnZ2VyZWQgb3BlbmluZyBtb2RhbFxuICAvLyBhZnRlciBjbG9zaW5nIGl0XG5cbiAgUmVhY3QudXNlRWZmZWN0KGZ1bmN0aW9uICgpIHtcbiAgICBpZiAoX0V4ZWN1dGlvbkVudmlyb25tZW50LmNhblVzZURPTSkge1xuICAgICAgdmFyIGxhc3RGb2N1c2VkRWxlbWVudE91dHNpZGVUcmFwID0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudDtcbiAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGlmIChsYXN0Rm9jdXNlZEVsZW1lbnRPdXRzaWRlVHJhcCAmJiBkb2N1bWVudC5jb250YWlucyhsYXN0Rm9jdXNlZEVsZW1lbnRPdXRzaWRlVHJhcCkpIHtcbiAgICAgICAgICBfVUlNYW5hZ2VyLmRlZmF1bHQuZm9jdXMobGFzdEZvY3VzZWRFbGVtZW50T3V0c2lkZVRyYXApO1xuICAgICAgICB9XG4gICAgICB9O1xuICAgIH1cbiAgfSwgW10pO1xuICByZXR1cm4gLyojX19QVVJFX18qL1JlYWN0LmNyZWF0ZUVsZW1lbnQoUmVhY3QuRnJhZ21lbnQsIG51bGwsIC8qI19fUFVSRV9fKi9SZWFjdC5jcmVhdGVFbGVtZW50KEZvY3VzQnJhY2tldCwgbnVsbCksIC8qI19fUFVSRV9fKi9SZWFjdC5jcmVhdGVFbGVtZW50KF9WaWV3LmRlZmF1bHQsIHtcbiAgICByZWY6IHRyYXBFbGVtZW50UmVmXG4gIH0sIGNoaWxkcmVuKSwgLyojX19QVVJFX18qL1JlYWN0LmNyZWF0ZUVsZW1lbnQoRm9jdXNCcmFja2V0LCBudWxsKSk7XG59O1xuXG52YXIgX2RlZmF1bHQgPSBNb2RhbEZvY3VzVHJhcDtcbmV4cG9ydHMuZGVmYXVsdCA9IF9kZWZhdWx0O1xuXG52YXIgc3R5bGVzID0gX1N0eWxlU2hlZXQuZGVmYXVsdC5jcmVhdGUoe1xuICBmb2N1c0JyYWNrZXQ6IHtcbiAgICBvdXRsaW5lU3R5bGU6ICdub25lJ1xuICB9XG59KTtcblxubW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzLmRlZmF1bHQ7Il19