fca0093f58b79d03d6b4649fafb736d6
'use strict';

exports.__esModule = true;
exports.default = void 0;

var _AnimatedValue = _interopRequireDefault(require("../nodes/AnimatedValue"));

var _AnimatedValueXY = _interopRequireDefault(require("../nodes/AnimatedValueXY"));

var _AnimatedInterpolation = _interopRequireDefault(require("../nodes/AnimatedInterpolation"));

var _Animation2 = _interopRequireDefault(require("./Animation"));

var _NativeAnimatedHelper = require("../NativeAnimatedHelper");

var _Easing = _interopRequireDefault(require("../../../../exports/Easing"));

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {
    default: obj
  };
}

function _inheritsLoose(subClass, superClass) {
  subClass.prototype = Object.create(superClass.prototype);
  subClass.prototype.constructor = subClass;

  _setPrototypeOf(subClass, superClass);
}

function _setPrototypeOf(o, p) {
  _setPrototypeOf = Object.setPrototypeOf || function _setPrototypeOf(o, p) {
    o.__proto__ = p;
    return o;
  };

  return _setPrototypeOf(o, p);
}

var _easeInOut;

function easeInOut() {
  if (!_easeInOut) {
    _easeInOut = _Easing.default.inOut(_Easing.default.ease);
  }

  return _easeInOut;
}

var TimingAnimation = function (_Animation) {
  _inheritsLoose(TimingAnimation, _Animation);

  function TimingAnimation(config) {
    var _config$easing, _config$duration, _config$delay, _config$iterations, _config$isInteraction;

    var _this;

    _this = _Animation.call(this) || this;
    _this._toValue = config.toValue;
    _this._easing = (_config$easing = config.easing) !== null && _config$easing !== void 0 ? _config$easing : easeInOut();
    _this._duration = (_config$duration = config.duration) !== null && _config$duration !== void 0 ? _config$duration : 500;
    _this._delay = (_config$delay = config.delay) !== null && _config$delay !== void 0 ? _config$delay : 0;
    _this.__iterations = (_config$iterations = config.iterations) !== null && _config$iterations !== void 0 ? _config$iterations : 1;
    _this._useNativeDriver = (0, _NativeAnimatedHelper.shouldUseNativeDriver)(config);
    _this.__isInteraction = (_config$isInteraction = config.isInteraction) !== null && _config$isInteraction !== void 0 ? _config$isInteraction : !_this._useNativeDriver;
    return _this;
  }

  var _proto = TimingAnimation.prototype;

  _proto.__getNativeAnimationConfig = function __getNativeAnimationConfig() {
    var frameDuration = 1000.0 / 60.0;
    var frames = [];
    var numFrames = Math.round(this._duration / frameDuration);

    for (var frame = 0; frame < numFrames; frame++) {
      frames.push(this._easing(frame / numFrames));
    }

    frames.push(this._easing(1));
    return {
      type: 'frames',
      frames: frames,
      toValue: this._toValue,
      iterations: this.__iterations
    };
  };

  _proto.start = function start(fromValue, onUpdate, onEnd, previousAnimation, animatedValue) {
    var _this2 = this;

    this.__active = true;
    this._fromValue = fromValue;
    this._onUpdate = onUpdate;
    this.__onEnd = onEnd;

    var start = function start() {
      if (_this2._duration === 0 && !_this2._useNativeDriver) {
        _this2._onUpdate(_this2._toValue);

        _this2.__debouncedOnEnd({
          finished: true
        });
      } else {
        _this2._startTime = Date.now();

        if (_this2._useNativeDriver) {
          _this2.__startNativeAnimation(animatedValue);
        } else {
          _this2._animationFrame = requestAnimationFrame(_this2.onUpdate.bind(_this2));
        }
      }
    };

    if (this._delay) {
      this._timeout = setTimeout(start, this._delay);
    } else {
      start();
    }
  };

  _proto.onUpdate = function onUpdate() {
    var now = Date.now();

    if (now >= this._startTime + this._duration) {
      if (this._duration === 0) {
        this._onUpdate(this._toValue);
      } else {
        this._onUpdate(this._fromValue + this._easing(1) * (this._toValue - this._fromValue));
      }

      this.__debouncedOnEnd({
        finished: true
      });

      return;
    }

    this._onUpdate(this._fromValue + this._easing((now - this._startTime) / this._duration) * (this._toValue - this._fromValue));

    if (this.__active) {
      this._animationFrame = requestAnimationFrame(this.onUpdate.bind(this));
    }
  };

  _proto.stop = function stop() {
    _Animation.prototype.stop.call(this);

    this.__active = false;
    clearTimeout(this._timeout);
    global.cancelAnimationFrame(this._animationFrame);

    this.__debouncedOnEnd({
      finished: false
    });
  };

  return TimingAnimation;
}(_Animation2.default);

var _default = TimingAnimation;
exports.default = _default;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlRpbWluZ0FuaW1hdGlvbi5qcyJdLCJuYW1lcyI6WyJleHBvcnRzIiwiX19lc01vZHVsZSIsImRlZmF1bHQiLCJfQW5pbWF0ZWRWYWx1ZSIsIl9pbnRlcm9wUmVxdWlyZURlZmF1bHQiLCJyZXF1aXJlIiwiX0FuaW1hdGVkVmFsdWVYWSIsIl9BbmltYXRlZEludGVycG9sYXRpb24iLCJfQW5pbWF0aW9uMiIsIl9OYXRpdmVBbmltYXRlZEhlbHBlciIsIl9FYXNpbmciLCJvYmoiLCJfaW5oZXJpdHNMb29zZSIsInN1YkNsYXNzIiwic3VwZXJDbGFzcyIsInByb3RvdHlwZSIsIk9iamVjdCIsImNyZWF0ZSIsImNvbnN0cnVjdG9yIiwiX3NldFByb3RvdHlwZU9mIiwibyIsInAiLCJzZXRQcm90b3R5cGVPZiIsIl9fcHJvdG9fXyIsIl9lYXNlSW5PdXQiLCJlYXNlSW5PdXQiLCJpbk91dCIsImVhc2UiLCJUaW1pbmdBbmltYXRpb24iLCJfQW5pbWF0aW9uIiwiY29uZmlnIiwiX2NvbmZpZyRlYXNpbmciLCJfY29uZmlnJGR1cmF0aW9uIiwiX2NvbmZpZyRkZWxheSIsIl9jb25maWckaXRlcmF0aW9ucyIsIl9jb25maWckaXNJbnRlcmFjdGlvbiIsIl90aGlzIiwiY2FsbCIsIl90b1ZhbHVlIiwidG9WYWx1ZSIsIl9lYXNpbmciLCJlYXNpbmciLCJfZHVyYXRpb24iLCJkdXJhdGlvbiIsIl9kZWxheSIsImRlbGF5IiwiX19pdGVyYXRpb25zIiwiaXRlcmF0aW9ucyIsIl91c2VOYXRpdmVEcml2ZXIiLCJzaG91bGRVc2VOYXRpdmVEcml2ZXIiLCJfX2lzSW50ZXJhY3Rpb24iLCJpc0ludGVyYWN0aW9uIiwiX3Byb3RvIiwiX19nZXROYXRpdmVBbmltYXRpb25Db25maWciLCJmcmFtZUR1cmF0aW9uIiwiZnJhbWVzIiwibnVtRnJhbWVzIiwiTWF0aCIsInJvdW5kIiwiZnJhbWUiLCJwdXNoIiwidHlwZSIsInN0YXJ0IiwiZnJvbVZhbHVlIiwib25VcGRhdGUiLCJvbkVuZCIsInByZXZpb3VzQW5pbWF0aW9uIiwiYW5pbWF0ZWRWYWx1ZSIsIl90aGlzMiIsIl9fYWN0aXZlIiwiX2Zyb21WYWx1ZSIsIl9vblVwZGF0ZSIsIl9fb25FbmQiLCJfX2RlYm91bmNlZE9uRW5kIiwiZmluaXNoZWQiLCJfc3RhcnRUaW1lIiwiRGF0ZSIsIm5vdyIsIl9fc3RhcnROYXRpdmVBbmltYXRpb24iLCJfYW5pbWF0aW9uRnJhbWUiLCJyZXF1ZXN0QW5pbWF0aW9uRnJhbWUiLCJiaW5kIiwiX3RpbWVvdXQiLCJzZXRUaW1lb3V0Iiwic3RvcCIsImNsZWFyVGltZW91dCIsImdsb2JhbCIsImNhbmNlbEFuaW1hdGlvbkZyYW1lIiwiX2RlZmF1bHQiLCJtb2R1bGUiXSwibWFwcGluZ3MiOiJBQVNBOztBQUVBQSxPQUFPLENBQUNDLFVBQVIsR0FBcUIsSUFBckI7QUFDQUQsT0FBTyxDQUFDRSxPQUFSLEdBQWtCLEtBQUssQ0FBdkI7O0FBRUEsSUFBSUMsY0FBYyxHQUFHQyxzQkFBc0IsQ0FBQ0MsT0FBTywwQkFBUixDQUEzQzs7QUFFQSxJQUFJQyxnQkFBZ0IsR0FBR0Ysc0JBQXNCLENBQUNDLE9BQU8sNEJBQVIsQ0FBN0M7O0FBRUEsSUFBSUUsc0JBQXNCLEdBQUdILHNCQUFzQixDQUFDQyxPQUFPLGtDQUFSLENBQW5EOztBQUVBLElBQUlHLFdBQVcsR0FBR0osc0JBQXNCLENBQUNDLE9BQU8sZUFBUixDQUF4Qzs7QUFFQSxJQUFJSSxxQkFBcUIsR0FBR0osT0FBTywyQkFBbkM7O0FBRUEsSUFBSUssT0FBTyxHQUFHTixzQkFBc0IsQ0FBQ0MsT0FBTyw4QkFBUixDQUFwQzs7QUFFQSxTQUFTRCxzQkFBVCxDQUFnQ08sR0FBaEMsRUFBcUM7QUFBRSxTQUFPQSxHQUFHLElBQUlBLEdBQUcsQ0FBQ1YsVUFBWCxHQUF3QlUsR0FBeEIsR0FBOEI7QUFBRVQsSUFBQUEsT0FBTyxFQUFFUztBQUFYLEdBQXJDO0FBQXdEOztBQUUvRixTQUFTQyxjQUFULENBQXdCQyxRQUF4QixFQUFrQ0MsVUFBbEMsRUFBOEM7QUFBRUQsRUFBQUEsUUFBUSxDQUFDRSxTQUFULEdBQXFCQyxNQUFNLENBQUNDLE1BQVAsQ0FBY0gsVUFBVSxDQUFDQyxTQUF6QixDQUFyQjtBQUEwREYsRUFBQUEsUUFBUSxDQUFDRSxTQUFULENBQW1CRyxXQUFuQixHQUFpQ0wsUUFBakM7O0FBQTJDTSxFQUFBQSxlQUFlLENBQUNOLFFBQUQsRUFBV0MsVUFBWCxDQUFmO0FBQXdDOztBQUU3TCxTQUFTSyxlQUFULENBQXlCQyxDQUF6QixFQUE0QkMsQ0FBNUIsRUFBK0I7QUFBRUYsRUFBQUEsZUFBZSxHQUFHSCxNQUFNLENBQUNNLGNBQVAsSUFBeUIsU0FBU0gsZUFBVCxDQUF5QkMsQ0FBekIsRUFBNEJDLENBQTVCLEVBQStCO0FBQUVELElBQUFBLENBQUMsQ0FBQ0csU0FBRixHQUFjRixDQUFkO0FBQWlCLFdBQU9ELENBQVA7QUFBVyxHQUF4Rzs7QUFBMEcsU0FBT0QsZUFBZSxDQUFDQyxDQUFELEVBQUlDLENBQUosQ0FBdEI7QUFBK0I7O0FBRTFLLElBQUlHLFVBQUo7O0FBRUEsU0FBU0MsU0FBVCxHQUFxQjtBQUNuQixNQUFJLENBQUNELFVBQUwsRUFBaUI7QUFDZkEsSUFBQUEsVUFBVSxHQUFHZCxPQUFPLENBQUNSLE9BQVIsQ0FBZ0J3QixLQUFoQixDQUFzQmhCLE9BQU8sQ0FBQ1IsT0FBUixDQUFnQnlCLElBQXRDLENBQWI7QUFDRDs7QUFFRCxTQUFPSCxVQUFQO0FBQ0Q7O0FBRUQsSUFBSUksZUFBZSxHQUFnQixVQUFVQyxVQUFWLEVBQXNCO0FBQ3ZEakIsRUFBQUEsY0FBYyxDQUFDZ0IsZUFBRCxFQUFrQkMsVUFBbEIsQ0FBZDs7QUFFQSxXQUFTRCxlQUFULENBQXlCRSxNQUF6QixFQUFpQztBQUMvQixRQUFJQyxjQUFKLEVBQW9CQyxnQkFBcEIsRUFBc0NDLGFBQXRDLEVBQXFEQyxrQkFBckQsRUFBeUVDLHFCQUF6RTs7QUFFQSxRQUFJQyxLQUFKOztBQUVBQSxJQUFBQSxLQUFLLEdBQUdQLFVBQVUsQ0FBQ1EsSUFBWCxDQUFnQixJQUFoQixLQUF5QixJQUFqQztBQUNBRCxJQUFBQSxLQUFLLENBQUNFLFFBQU4sR0FBaUJSLE1BQU0sQ0FBQ1MsT0FBeEI7QUFDQUgsSUFBQUEsS0FBSyxDQUFDSSxPQUFOLEdBQWdCLENBQUNULGNBQWMsR0FBR0QsTUFBTSxDQUFDVyxNQUF6QixNQUFxQyxJQUFyQyxJQUE2Q1YsY0FBYyxLQUFLLEtBQUssQ0FBckUsR0FBeUVBLGNBQXpFLEdBQTBGTixTQUFTLEVBQW5IO0FBQ0FXLElBQUFBLEtBQUssQ0FBQ00sU0FBTixHQUFrQixDQUFDVixnQkFBZ0IsR0FBR0YsTUFBTSxDQUFDYSxRQUEzQixNQUF5QyxJQUF6QyxJQUFpRFgsZ0JBQWdCLEtBQUssS0FBSyxDQUEzRSxHQUErRUEsZ0JBQS9FLEdBQWtHLEdBQXBIO0FBQ0FJLElBQUFBLEtBQUssQ0FBQ1EsTUFBTixHQUFlLENBQUNYLGFBQWEsR0FBR0gsTUFBTSxDQUFDZSxLQUF4QixNQUFtQyxJQUFuQyxJQUEyQ1osYUFBYSxLQUFLLEtBQUssQ0FBbEUsR0FBc0VBLGFBQXRFLEdBQXNGLENBQXJHO0FBQ0FHLElBQUFBLEtBQUssQ0FBQ1UsWUFBTixHQUFxQixDQUFDWixrQkFBa0IsR0FBR0osTUFBTSxDQUFDaUIsVUFBN0IsTUFBNkMsSUFBN0MsSUFBcURiLGtCQUFrQixLQUFLLEtBQUssQ0FBakYsR0FBcUZBLGtCQUFyRixHQUEwRyxDQUEvSDtBQUNBRSxJQUFBQSxLQUFLLENBQUNZLGdCQUFOLEdBQXlCLENBQUMsR0FBR3ZDLHFCQUFxQixDQUFDd0MscUJBQTFCLEVBQWlEbkIsTUFBakQsQ0FBekI7QUFDQU0sSUFBQUEsS0FBSyxDQUFDYyxlQUFOLEdBQXdCLENBQUNmLHFCQUFxQixHQUFHTCxNQUFNLENBQUNxQixhQUFoQyxNQUFtRCxJQUFuRCxJQUEyRGhCLHFCQUFxQixLQUFLLEtBQUssQ0FBMUYsR0FBOEZBLHFCQUE5RixHQUFzSCxDQUFDQyxLQUFLLENBQUNZLGdCQUFySjtBQUNBLFdBQU9aLEtBQVA7QUFDRDs7QUFFRCxNQUFJZ0IsTUFBTSxHQUFHeEIsZUFBZSxDQUFDYixTQUE3Qjs7QUFFQXFDLEVBQUFBLE1BQU0sQ0FBQ0MsMEJBQVAsR0FBb0MsU0FBU0EsMEJBQVQsR0FBc0M7QUFDeEUsUUFBSUMsYUFBYSxHQUFHLFNBQVMsSUFBN0I7QUFDQSxRQUFJQyxNQUFNLEdBQUcsRUFBYjtBQUNBLFFBQUlDLFNBQVMsR0FBR0MsSUFBSSxDQUFDQyxLQUFMLENBQVcsS0FBS2hCLFNBQUwsR0FBaUJZLGFBQTVCLENBQWhCOztBQUVBLFNBQUssSUFBSUssS0FBSyxHQUFHLENBQWpCLEVBQW9CQSxLQUFLLEdBQUdILFNBQTVCLEVBQXVDRyxLQUFLLEVBQTVDLEVBQWdEO0FBQzlDSixNQUFBQSxNQUFNLENBQUNLLElBQVAsQ0FBWSxLQUFLcEIsT0FBTCxDQUFhbUIsS0FBSyxHQUFHSCxTQUFyQixDQUFaO0FBQ0Q7O0FBRURELElBQUFBLE1BQU0sQ0FBQ0ssSUFBUCxDQUFZLEtBQUtwQixPQUFMLENBQWEsQ0FBYixDQUFaO0FBQ0EsV0FBTztBQUNMcUIsTUFBQUEsSUFBSSxFQUFFLFFBREQ7QUFFTE4sTUFBQUEsTUFBTSxFQUFFQSxNQUZIO0FBR0xoQixNQUFBQSxPQUFPLEVBQUUsS0FBS0QsUUFIVDtBQUlMUyxNQUFBQSxVQUFVLEVBQUUsS0FBS0Q7QUFKWixLQUFQO0FBTUQsR0FoQkQ7O0FBa0JBTSxFQUFBQSxNQUFNLENBQUNVLEtBQVAsR0FBZSxTQUFTQSxLQUFULENBQWVDLFNBQWYsRUFBMEJDLFFBQTFCLEVBQW9DQyxLQUFwQyxFQUEyQ0MsaUJBQTNDLEVBQThEQyxhQUE5RCxFQUE2RTtBQUMxRixRQUFJQyxNQUFNLEdBQUcsSUFBYjs7QUFFQSxTQUFLQyxRQUFMLEdBQWdCLElBQWhCO0FBQ0EsU0FBS0MsVUFBTCxHQUFrQlAsU0FBbEI7QUFDQSxTQUFLUSxTQUFMLEdBQWlCUCxRQUFqQjtBQUNBLFNBQUtRLE9BQUwsR0FBZVAsS0FBZjs7QUFFQSxRQUFJSCxLQUFLLEdBQUcsU0FBU0EsS0FBVCxHQUFpQjtBQUkzQixVQUFJTSxNQUFNLENBQUMxQixTQUFQLEtBQXFCLENBQXJCLElBQTBCLENBQUMwQixNQUFNLENBQUNwQixnQkFBdEMsRUFBd0Q7QUFDdERvQixRQUFBQSxNQUFNLENBQUNHLFNBQVAsQ0FBaUJILE1BQU0sQ0FBQzlCLFFBQXhCOztBQUVBOEIsUUFBQUEsTUFBTSxDQUFDSyxnQkFBUCxDQUF3QjtBQUN0QkMsVUFBQUEsUUFBUSxFQUFFO0FBRFksU0FBeEI7QUFHRCxPQU5ELE1BTU87QUFDTE4sUUFBQUEsTUFBTSxDQUFDTyxVQUFQLEdBQW9CQyxJQUFJLENBQUNDLEdBQUwsRUFBcEI7O0FBRUEsWUFBSVQsTUFBTSxDQUFDcEIsZ0JBQVgsRUFBNkI7QUFDM0JvQixVQUFBQSxNQUFNLENBQUNVLHNCQUFQLENBQThCWCxhQUE5QjtBQUNELFNBRkQsTUFFTztBQUNMQyxVQUFBQSxNQUFNLENBQUNXLGVBQVAsR0FBeUJDLHFCQUFxQixDQUFDWixNQUFNLENBQUNKLFFBQVAsQ0FBZ0JpQixJQUFoQixDQUFxQmIsTUFBckIsQ0FBRCxDQUE5QztBQUNEO0FBQ0Y7QUFDRixLQW5CRDs7QUFxQkEsUUFBSSxLQUFLeEIsTUFBVCxFQUFpQjtBQUNmLFdBQUtzQyxRQUFMLEdBQWdCQyxVQUFVLENBQUNyQixLQUFELEVBQVEsS0FBS2xCLE1BQWIsQ0FBMUI7QUFDRCxLQUZELE1BRU87QUFDTGtCLE1BQUFBLEtBQUs7QUFDTjtBQUNGLEdBbENEOztBQW9DQVYsRUFBQUEsTUFBTSxDQUFDWSxRQUFQLEdBQWtCLFNBQVNBLFFBQVQsR0FBb0I7QUFDcEMsUUFBSWEsR0FBRyxHQUFHRCxJQUFJLENBQUNDLEdBQUwsRUFBVjs7QUFFQSxRQUFJQSxHQUFHLElBQUksS0FBS0YsVUFBTCxHQUFrQixLQUFLakMsU0FBbEMsRUFBNkM7QUFDM0MsVUFBSSxLQUFLQSxTQUFMLEtBQW1CLENBQXZCLEVBQTBCO0FBQ3hCLGFBQUs2QixTQUFMLENBQWUsS0FBS2pDLFFBQXBCO0FBQ0QsT0FGRCxNQUVPO0FBQ0wsYUFBS2lDLFNBQUwsQ0FBZSxLQUFLRCxVQUFMLEdBQWtCLEtBQUs5QixPQUFMLENBQWEsQ0FBYixLQUFtQixLQUFLRixRQUFMLEdBQWdCLEtBQUtnQyxVQUF4QyxDQUFqQztBQUNEOztBQUVELFdBQUtHLGdCQUFMLENBQXNCO0FBQ3BCQyxRQUFBQSxRQUFRLEVBQUU7QUFEVSxPQUF0Qjs7QUFJQTtBQUNEOztBQUVELFNBQUtILFNBQUwsQ0FBZSxLQUFLRCxVQUFMLEdBQWtCLEtBQUs5QixPQUFMLENBQWEsQ0FBQ3FDLEdBQUcsR0FBRyxLQUFLRixVQUFaLElBQTBCLEtBQUtqQyxTQUE1QyxLQUEwRCxLQUFLSixRQUFMLEdBQWdCLEtBQUtnQyxVQUEvRSxDQUFqQzs7QUFFQSxRQUFJLEtBQUtELFFBQVQsRUFBbUI7QUFDakIsV0FBS1UsZUFBTCxHQUF1QkMscUJBQXFCLENBQUMsS0FBS2hCLFFBQUwsQ0FBY2lCLElBQWQsQ0FBbUIsSUFBbkIsQ0FBRCxDQUE1QztBQUNEO0FBQ0YsR0F0QkQ7O0FBd0JBN0IsRUFBQUEsTUFBTSxDQUFDZ0MsSUFBUCxHQUFjLFNBQVNBLElBQVQsR0FBZ0I7QUFDNUJ2RCxJQUFBQSxVQUFVLENBQUNkLFNBQVgsQ0FBcUJxRSxJQUFyQixDQUEwQi9DLElBQTFCLENBQStCLElBQS9COztBQUVBLFNBQUtnQyxRQUFMLEdBQWdCLEtBQWhCO0FBQ0FnQixJQUFBQSxZQUFZLENBQUMsS0FBS0gsUUFBTixDQUFaO0FBQ0FJLElBQUFBLE1BQU0sQ0FBQ0Msb0JBQVAsQ0FBNEIsS0FBS1IsZUFBakM7O0FBRUEsU0FBS04sZ0JBQUwsQ0FBc0I7QUFDcEJDLE1BQUFBLFFBQVEsRUFBRTtBQURVLEtBQXRCO0FBR0QsR0FWRDs7QUFZQSxTQUFPOUMsZUFBUDtBQUNELENBaEhrQyxDQWdIakNwQixXQUFXLENBQUNOLE9BaEhxQixDQUFuQzs7QUFrSEEsSUFBSXNGLFFBQVEsR0FBRzVELGVBQWY7QUFDQTVCLE9BQU8sQ0FBQ0UsT0FBUixHQUFrQnNGLFFBQWxCO0FBQ0FDLE1BQU0sQ0FBQ3pGLE9BQVAsR0FBaUJBLE9BQU8sQ0FBQ0UsT0FBekIiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENvcHlyaWdodCAoYykgRmFjZWJvb2ssIEluYy4gYW5kIGl0cyBhZmZpbGlhdGVzLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZVxuICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICpcbiAqIFxuICogQGZvcm1hdFxuICovXG4ndXNlIHN0cmljdCc7XG5cbmV4cG9ydHMuX19lc01vZHVsZSA9IHRydWU7XG5leHBvcnRzLmRlZmF1bHQgPSB2b2lkIDA7XG5cbnZhciBfQW5pbWF0ZWRWYWx1ZSA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZShcIi4uL25vZGVzL0FuaW1hdGVkVmFsdWVcIikpO1xuXG52YXIgX0FuaW1hdGVkVmFsdWVYWSA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZShcIi4uL25vZGVzL0FuaW1hdGVkVmFsdWVYWVwiKSk7XG5cbnZhciBfQW5pbWF0ZWRJbnRlcnBvbGF0aW9uID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKFwiLi4vbm9kZXMvQW5pbWF0ZWRJbnRlcnBvbGF0aW9uXCIpKTtcblxudmFyIF9BbmltYXRpb24yID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKFwiLi9BbmltYXRpb25cIikpO1xuXG52YXIgX05hdGl2ZUFuaW1hdGVkSGVscGVyID0gcmVxdWlyZShcIi4uL05hdGl2ZUFuaW1hdGVkSGVscGVyXCIpO1xuXG52YXIgX0Vhc2luZyA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZShcIi4uLy4uLy4uLy4uL2V4cG9ydHMvRWFzaW5nXCIpKTtcblxuZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgZGVmYXVsdDogb2JqIH07IH1cblxuZnVuY3Rpb24gX2luaGVyaXRzTG9vc2Uoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIHsgc3ViQ2xhc3MucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShzdXBlckNsYXNzLnByb3RvdHlwZSk7IHN1YkNsYXNzLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IHN1YkNsYXNzOyBfc2V0UHJvdG90eXBlT2Yoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpOyB9XG5cbmZ1bmN0aW9uIF9zZXRQcm90b3R5cGVPZihvLCBwKSB7IF9zZXRQcm90b3R5cGVPZiA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fCBmdW5jdGlvbiBfc2V0UHJvdG90eXBlT2YobywgcCkgeyBvLl9fcHJvdG9fXyA9IHA7IHJldHVybiBvOyB9OyByZXR1cm4gX3NldFByb3RvdHlwZU9mKG8sIHApOyB9XG5cbnZhciBfZWFzZUluT3V0O1xuXG5mdW5jdGlvbiBlYXNlSW5PdXQoKSB7XG4gIGlmICghX2Vhc2VJbk91dCkge1xuICAgIF9lYXNlSW5PdXQgPSBfRWFzaW5nLmRlZmF1bHQuaW5PdXQoX0Vhc2luZy5kZWZhdWx0LmVhc2UpO1xuICB9XG5cbiAgcmV0dXJuIF9lYXNlSW5PdXQ7XG59XG5cbnZhciBUaW1pbmdBbmltYXRpb24gPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKF9BbmltYXRpb24pIHtcbiAgX2luaGVyaXRzTG9vc2UoVGltaW5nQW5pbWF0aW9uLCBfQW5pbWF0aW9uKTtcblxuICBmdW5jdGlvbiBUaW1pbmdBbmltYXRpb24oY29uZmlnKSB7XG4gICAgdmFyIF9jb25maWckZWFzaW5nLCBfY29uZmlnJGR1cmF0aW9uLCBfY29uZmlnJGRlbGF5LCBfY29uZmlnJGl0ZXJhdGlvbnMsIF9jb25maWckaXNJbnRlcmFjdGlvbjtcblxuICAgIHZhciBfdGhpcztcblxuICAgIF90aGlzID0gX0FuaW1hdGlvbi5jYWxsKHRoaXMpIHx8IHRoaXM7XG4gICAgX3RoaXMuX3RvVmFsdWUgPSBjb25maWcudG9WYWx1ZTtcbiAgICBfdGhpcy5fZWFzaW5nID0gKF9jb25maWckZWFzaW5nID0gY29uZmlnLmVhc2luZykgIT09IG51bGwgJiYgX2NvbmZpZyRlYXNpbmcgIT09IHZvaWQgMCA/IF9jb25maWckZWFzaW5nIDogZWFzZUluT3V0KCk7XG4gICAgX3RoaXMuX2R1cmF0aW9uID0gKF9jb25maWckZHVyYXRpb24gPSBjb25maWcuZHVyYXRpb24pICE9PSBudWxsICYmIF9jb25maWckZHVyYXRpb24gIT09IHZvaWQgMCA/IF9jb25maWckZHVyYXRpb24gOiA1MDA7XG4gICAgX3RoaXMuX2RlbGF5ID0gKF9jb25maWckZGVsYXkgPSBjb25maWcuZGVsYXkpICE9PSBudWxsICYmIF9jb25maWckZGVsYXkgIT09IHZvaWQgMCA/IF9jb25maWckZGVsYXkgOiAwO1xuICAgIF90aGlzLl9faXRlcmF0aW9ucyA9IChfY29uZmlnJGl0ZXJhdGlvbnMgPSBjb25maWcuaXRlcmF0aW9ucykgIT09IG51bGwgJiYgX2NvbmZpZyRpdGVyYXRpb25zICE9PSB2b2lkIDAgPyBfY29uZmlnJGl0ZXJhdGlvbnMgOiAxO1xuICAgIF90aGlzLl91c2VOYXRpdmVEcml2ZXIgPSAoMCwgX05hdGl2ZUFuaW1hdGVkSGVscGVyLnNob3VsZFVzZU5hdGl2ZURyaXZlcikoY29uZmlnKTtcbiAgICBfdGhpcy5fX2lzSW50ZXJhY3Rpb24gPSAoX2NvbmZpZyRpc0ludGVyYWN0aW9uID0gY29uZmlnLmlzSW50ZXJhY3Rpb24pICE9PSBudWxsICYmIF9jb25maWckaXNJbnRlcmFjdGlvbiAhPT0gdm9pZCAwID8gX2NvbmZpZyRpc0ludGVyYWN0aW9uIDogIV90aGlzLl91c2VOYXRpdmVEcml2ZXI7XG4gICAgcmV0dXJuIF90aGlzO1xuICB9XG5cbiAgdmFyIF9wcm90byA9IFRpbWluZ0FuaW1hdGlvbi5wcm90b3R5cGU7XG5cbiAgX3Byb3RvLl9fZ2V0TmF0aXZlQW5pbWF0aW9uQ29uZmlnID0gZnVuY3Rpb24gX19nZXROYXRpdmVBbmltYXRpb25Db25maWcoKSB7XG4gICAgdmFyIGZyYW1lRHVyYXRpb24gPSAxMDAwLjAgLyA2MC4wO1xuICAgIHZhciBmcmFtZXMgPSBbXTtcbiAgICB2YXIgbnVtRnJhbWVzID0gTWF0aC5yb3VuZCh0aGlzLl9kdXJhdGlvbiAvIGZyYW1lRHVyYXRpb24pO1xuXG4gICAgZm9yICh2YXIgZnJhbWUgPSAwOyBmcmFtZSA8IG51bUZyYW1lczsgZnJhbWUrKykge1xuICAgICAgZnJhbWVzLnB1c2godGhpcy5fZWFzaW5nKGZyYW1lIC8gbnVtRnJhbWVzKSk7XG4gICAgfVxuXG4gICAgZnJhbWVzLnB1c2godGhpcy5fZWFzaW5nKDEpKTtcbiAgICByZXR1cm4ge1xuICAgICAgdHlwZTogJ2ZyYW1lcycsXG4gICAgICBmcmFtZXM6IGZyYW1lcyxcbiAgICAgIHRvVmFsdWU6IHRoaXMuX3RvVmFsdWUsXG4gICAgICBpdGVyYXRpb25zOiB0aGlzLl9faXRlcmF0aW9uc1xuICAgIH07XG4gIH07XG5cbiAgX3Byb3RvLnN0YXJ0ID0gZnVuY3Rpb24gc3RhcnQoZnJvbVZhbHVlLCBvblVwZGF0ZSwgb25FbmQsIHByZXZpb3VzQW5pbWF0aW9uLCBhbmltYXRlZFZhbHVlKSB7XG4gICAgdmFyIF90aGlzMiA9IHRoaXM7XG5cbiAgICB0aGlzLl9fYWN0aXZlID0gdHJ1ZTtcbiAgICB0aGlzLl9mcm9tVmFsdWUgPSBmcm9tVmFsdWU7XG4gICAgdGhpcy5fb25VcGRhdGUgPSBvblVwZGF0ZTtcbiAgICB0aGlzLl9fb25FbmQgPSBvbkVuZDtcblxuICAgIHZhciBzdGFydCA9IGZ1bmN0aW9uIHN0YXJ0KCkge1xuICAgICAgLy8gQW5pbWF0aW9ucyB0aGF0IHNvbWV0aW1lcyBoYXZlIDAgZHVyYXRpb24gYW5kIHNvbWV0aW1lcyBkbyBub3RcbiAgICAgIC8vIHN0aWxsIG5lZWQgdG8gdXNlIHRoZSBuYXRpdmUgZHJpdmVyIHdoZW4gZHVyYXRpb24gaXMgMCBzbyBhcyB0b1xuICAgICAgLy8gbm90IGNhdXNlIGludGVybWl4ZWQgSlMgYW5kIG5hdGl2ZSBhbmltYXRpb25zLlxuICAgICAgaWYgKF90aGlzMi5fZHVyYXRpb24gPT09IDAgJiYgIV90aGlzMi5fdXNlTmF0aXZlRHJpdmVyKSB7XG4gICAgICAgIF90aGlzMi5fb25VcGRhdGUoX3RoaXMyLl90b1ZhbHVlKTtcblxuICAgICAgICBfdGhpczIuX19kZWJvdW5jZWRPbkVuZCh7XG4gICAgICAgICAgZmluaXNoZWQ6IHRydWVcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBfdGhpczIuX3N0YXJ0VGltZSA9IERhdGUubm93KCk7XG5cbiAgICAgICAgaWYgKF90aGlzMi5fdXNlTmF0aXZlRHJpdmVyKSB7XG4gICAgICAgICAgX3RoaXMyLl9fc3RhcnROYXRpdmVBbmltYXRpb24oYW5pbWF0ZWRWYWx1ZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgX3RoaXMyLl9hbmltYXRpb25GcmFtZSA9IHJlcXVlc3RBbmltYXRpb25GcmFtZShfdGhpczIub25VcGRhdGUuYmluZChfdGhpczIpKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH07XG5cbiAgICBpZiAodGhpcy5fZGVsYXkpIHtcbiAgICAgIHRoaXMuX3RpbWVvdXQgPSBzZXRUaW1lb3V0KHN0YXJ0LCB0aGlzLl9kZWxheSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHN0YXJ0KCk7XG4gICAgfVxuICB9O1xuXG4gIF9wcm90by5vblVwZGF0ZSA9IGZ1bmN0aW9uIG9uVXBkYXRlKCkge1xuICAgIHZhciBub3cgPSBEYXRlLm5vdygpO1xuXG4gICAgaWYgKG5vdyA+PSB0aGlzLl9zdGFydFRpbWUgKyB0aGlzLl9kdXJhdGlvbikge1xuICAgICAgaWYgKHRoaXMuX2R1cmF0aW9uID09PSAwKSB7XG4gICAgICAgIHRoaXMuX29uVXBkYXRlKHRoaXMuX3RvVmFsdWUpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5fb25VcGRhdGUodGhpcy5fZnJvbVZhbHVlICsgdGhpcy5fZWFzaW5nKDEpICogKHRoaXMuX3RvVmFsdWUgLSB0aGlzLl9mcm9tVmFsdWUpKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5fX2RlYm91bmNlZE9uRW5kKHtcbiAgICAgICAgZmluaXNoZWQ6IHRydWVcbiAgICAgIH0pO1xuXG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5fb25VcGRhdGUodGhpcy5fZnJvbVZhbHVlICsgdGhpcy5fZWFzaW5nKChub3cgLSB0aGlzLl9zdGFydFRpbWUpIC8gdGhpcy5fZHVyYXRpb24pICogKHRoaXMuX3RvVmFsdWUgLSB0aGlzLl9mcm9tVmFsdWUpKTtcblxuICAgIGlmICh0aGlzLl9fYWN0aXZlKSB7XG4gICAgICB0aGlzLl9hbmltYXRpb25GcmFtZSA9IHJlcXVlc3RBbmltYXRpb25GcmFtZSh0aGlzLm9uVXBkYXRlLmJpbmQodGhpcykpO1xuICAgIH1cbiAgfTtcblxuICBfcHJvdG8uc3RvcCA9IGZ1bmN0aW9uIHN0b3AoKSB7XG4gICAgX0FuaW1hdGlvbi5wcm90b3R5cGUuc3RvcC5jYWxsKHRoaXMpO1xuXG4gICAgdGhpcy5fX2FjdGl2ZSA9IGZhbHNlO1xuICAgIGNsZWFyVGltZW91dCh0aGlzLl90aW1lb3V0KTtcbiAgICBnbG9iYWwuY2FuY2VsQW5pbWF0aW9uRnJhbWUodGhpcy5fYW5pbWF0aW9uRnJhbWUpO1xuXG4gICAgdGhpcy5fX2RlYm91bmNlZE9uRW5kKHtcbiAgICAgIGZpbmlzaGVkOiBmYWxzZVxuICAgIH0pO1xuICB9O1xuXG4gIHJldHVybiBUaW1pbmdBbmltYXRpb247XG59KF9BbmltYXRpb24yLmRlZmF1bHQpO1xuXG52YXIgX2RlZmF1bHQgPSBUaW1pbmdBbmltYXRpb247XG5leHBvcnRzLmRlZmF1bHQgPSBfZGVmYXVsdDtcbm1vZHVsZS5leHBvcnRzID0gZXhwb3J0cy5kZWZhdWx0OyJdfQ==