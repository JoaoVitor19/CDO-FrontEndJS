53475c7371a50d6225c25b3e0b3097a8
"use strict";

exports.__esModule = true;
exports.default = exports.ImageUriCache = void 0;
var dataUriPattern = /^data:/;

var ImageUriCache = function () {
  function ImageUriCache() {}

  ImageUriCache.has = function has(uri) {
    var entries = ImageUriCache._entries;
    var isDataUri = dataUriPattern.test(uri);
    return isDataUri || Boolean(entries[uri]);
  };

  ImageUriCache.add = function add(uri) {
    var entries = ImageUriCache._entries;
    var lastUsedTimestamp = Date.now();

    if (entries[uri]) {
      entries[uri].lastUsedTimestamp = lastUsedTimestamp;
      entries[uri].refCount += 1;
    } else {
      entries[uri] = {
        lastUsedTimestamp: lastUsedTimestamp,
        refCount: 1
      };
    }
  };

  ImageUriCache.remove = function remove(uri) {
    var entries = ImageUriCache._entries;

    if (entries[uri]) {
      entries[uri].refCount -= 1;
    }

    ImageUriCache._cleanUpIfNeeded();
  };

  ImageUriCache._cleanUpIfNeeded = function _cleanUpIfNeeded() {
    var entries = ImageUriCache._entries;
    var imageUris = Object.keys(entries);

    if (imageUris.length + 1 > ImageUriCache._maximumEntries) {
      var leastRecentlyUsedKey;
      var leastRecentlyUsedEntry;
      imageUris.forEach(function (uri) {
        var entry = entries[uri];

        if ((!leastRecentlyUsedEntry || entry.lastUsedTimestamp < leastRecentlyUsedEntry.lastUsedTimestamp) && entry.refCount === 0) {
          leastRecentlyUsedKey = uri;
          leastRecentlyUsedEntry = entry;
        }
      });

      if (leastRecentlyUsedKey) {
        delete entries[leastRecentlyUsedKey];
      }
    }
  };

  return ImageUriCache;
}();

exports.ImageUriCache = ImageUriCache;
ImageUriCache._maximumEntries = 256;
ImageUriCache._entries = {};
var id = 0;
var requests = {};
var ImageLoader = {
  abort: function abort(requestId) {
    var image = requests["" + requestId];

    if (image) {
      image.onerror = null;
      image.onload = null;
      image = null;
      delete requests["" + requestId];
    }
  },
  getSize: function getSize(uri, success, failure) {
    var complete = false;
    var interval = setInterval(callback, 16);
    var requestId = ImageLoader.load(uri, callback, errorCallback);

    function callback() {
      var image = requests["" + requestId];

      if (image) {
        var naturalHeight = image.naturalHeight,
            naturalWidth = image.naturalWidth;

        if (naturalHeight && naturalWidth) {
          success(naturalWidth, naturalHeight);
          complete = true;
        }
      }

      if (complete) {
        ImageLoader.abort(requestId);
        clearInterval(interval);
      }
    }

    function errorCallback() {
      if (typeof failure === 'function') {
        failure();
      }

      ImageLoader.abort(requestId);
      clearInterval(interval);
    }
  },
  has: function has(uri) {
    return ImageUriCache.has(uri);
  },
  load: function load(uri, onLoad, onError) {
    id += 1;
    var image = new window.Image();
    image.onerror = onError;

    image.onload = function (e) {
      var onDecode = function onDecode() {
        return onLoad({
          nativeEvent: e
        });
      };

      if (typeof image.decode === 'function') {
        image.decode().then(onDecode, onDecode);
      } else {
        setTimeout(onDecode, 0);
      }
    };

    image.src = uri;
    requests["" + id] = image;
    return id;
  },
  prefetch: function prefetch(uri) {
    return new Promise(function (resolve, reject) {
      ImageLoader.load(uri, function () {
        ImageUriCache.add(uri);
        ImageUriCache.remove(uri);
        resolve();
      }, reject);
    });
  },
  queryCache: function queryCache(uris) {
    var result = {};
    uris.forEach(function (u) {
      if (ImageUriCache.has(u)) {
        result[u] = 'disk/memory';
      }
    });
    return Promise.resolve(result);
  }
};
var _default = ImageLoader;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LmpzIl0sIm5hbWVzIjpbImV4cG9ydHMiLCJfX2VzTW9kdWxlIiwiZGVmYXVsdCIsIkltYWdlVXJpQ2FjaGUiLCJkYXRhVXJpUGF0dGVybiIsImhhcyIsInVyaSIsImVudHJpZXMiLCJfZW50cmllcyIsImlzRGF0YVVyaSIsInRlc3QiLCJCb29sZWFuIiwiYWRkIiwibGFzdFVzZWRUaW1lc3RhbXAiLCJEYXRlIiwibm93IiwicmVmQ291bnQiLCJyZW1vdmUiLCJfY2xlYW5VcElmTmVlZGVkIiwiaW1hZ2VVcmlzIiwiT2JqZWN0Iiwia2V5cyIsImxlbmd0aCIsIl9tYXhpbXVtRW50cmllcyIsImxlYXN0UmVjZW50bHlVc2VkS2V5IiwibGVhc3RSZWNlbnRseVVzZWRFbnRyeSIsImZvckVhY2giLCJlbnRyeSIsImlkIiwicmVxdWVzdHMiLCJJbWFnZUxvYWRlciIsImFib3J0IiwicmVxdWVzdElkIiwiaW1hZ2UiLCJvbmVycm9yIiwib25sb2FkIiwiZ2V0U2l6ZSIsInN1Y2Nlc3MiLCJmYWlsdXJlIiwiY29tcGxldGUiLCJpbnRlcnZhbCIsInNldEludGVydmFsIiwiY2FsbGJhY2siLCJsb2FkIiwiZXJyb3JDYWxsYmFjayIsIm5hdHVyYWxIZWlnaHQiLCJuYXR1cmFsV2lkdGgiLCJjbGVhckludGVydmFsIiwib25Mb2FkIiwib25FcnJvciIsIndpbmRvdyIsIkltYWdlIiwiZSIsIm9uRGVjb2RlIiwibmF0aXZlRXZlbnQiLCJkZWNvZGUiLCJ0aGVuIiwic2V0VGltZW91dCIsInNyYyIsInByZWZldGNoIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJxdWVyeUNhY2hlIiwidXJpcyIsInJlc3VsdCIsInUiLCJfZGVmYXVsdCJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUFBLE9BQU8sQ0FBQ0MsVUFBUixHQUFxQixJQUFyQjtBQUNBRCxPQUFPLENBQUNFLE9BQVIsR0FBa0JGLE9BQU8sQ0FBQ0csYUFBUixHQUF3QixLQUFLLENBQS9DO0FBVUEs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QUFDRixLQWhCRDs7QUFrQkFwQixJQUFBQSxLQUFLLENBQUN5QixHQUFOLEdBQVlwRCxHQUFaO0FBQ0F1QixJQUFBQSxRQUFRLENBQUMsS0FBS0QsRUFBTixDQUFSLEdBQW9CSyxLQUFwQjtBQUNBLFdBQU9MLEVBQVA7QUFDRCxHQXpFZTtBQTBFaEIrQixFQUFBQSxRQUFRLEVBQUUsU0FBU0EsUUFBVCxDQUFrQnJELEdBQWxCLEVBQXVCO0FBQy9CLFdBQU8sSUFBSXNELE9BQUosQ0FBWSxVQUFVQyxPQUFWLEVBQW1CQyxNQUFuQixFQUEyQjtBQUM1Q2hDLE1BQUFBLFdBQVcsQ0FBQ2EsSUFBWixDQUFpQnJDLEdBQWpCLEVBQXNCLFlBQVk7QUFHaENILFFBQUFBLGFBQWEsQ0FBQ1MsR0FBZCxDQUFrQk4sR0FBbEI7QUFDQUgsUUFBQUEsYUFBYSxDQUFDYyxNQUFkLENBQXFCWCxHQUFyQjtBQUNBdUQsUUFBQUEsT0FBTztBQUNSLE9BTkQsRUFNR0MsTUFOSDtBQU9ELEtBUk0sQ0FBUDtBQVNELEdBcEZlO0FBcUZoQkMsRUFBQUEsVUFBVSxFQUFFLFNBQVNBLFVBQVQsQ0FBb0JDLElBQXBCLEVBQTBCO0FBQ3BDLFFBQUlDLE1BQU0sR0FBRyxFQUFiO0FBQ0FELElBQUFBLElBQUksQ0FBQ3RDLE9BQUwsQ0FBYSxVQUFVd0MsQ0FBVixFQUFhO0FBQ3hCLFVBQUkvRCxhQUFhLENBQUNFLEdBQWQsQ0FBa0I2RCxDQUFsQixDQUFKLEVBQTBCO0FBQ3hCRCxRQUFBQSxNQUFNLENBQUNDLENBQUQsQ0FBTixHQUFZLGFBQVo7QUFDRDtBQUNGLEtBSkQ7QUFLQSxXQUFPTixPQUFPLENBQUNDLE9BQVIsQ0FBZ0JJLE1BQWhCLENBQVA7QUFDRDtBQTdGZSxDQUFsQjtBQStGQSxJQUFJRSxRQUFRLEdBQUdyQyxXQUFmO0FBQ0E5QixPQUFPLENBQUNFLE9BQVIsR0FBa0JpRSxRQUFsQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5leHBvcnRzLl9fZXNNb2R1bGUgPSB0cnVlO1xuZXhwb3J0cy5kZWZhdWx0ID0gZXhwb3J0cy5JbWFnZVVyaUNhY2hlID0gdm9pZCAwO1xuXG4vKipcbiAqIENvcHlyaWdodCAoYykgTmljb2xhcyBHYWxsYWdoZXIuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKlxuICogXG4gKi9cbnZhciBkYXRhVXJpUGF0dGVybiA9IC9eZGF0YTovO1xuXG52YXIgSW1hZ2VVcmlDYWNoZSA9IC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoKSB7XG4gIGZ1bmN0aW9uIEltYWdlVXJpQ2FjaGUoKSB7fVxuXG4gIEltYWdlVXJpQ2FjaGUuaGFzID0gZnVuY3Rpb24gaGFzKHVyaSkge1xuICAgIHZhciBlbnRyaWVzID0gSW1hZ2VVcmlDYWNoZS5fZW50cmllcztcbiAgICB2YXIgaXNEYXRhVXJpID0gZGF0YVVyaVBhdHRlcm4udGVzdCh1cmkpO1xuICAgIHJldHVybiBpc0RhdGFVcmkgfHwgQm9vbGVhbihlbnRyaWVzW3VyaV0pO1xuICB9O1xuXG4gIEltYWdlVXJpQ2FjaGUuYWRkID0gZnVuY3Rpb24gYWRkKHVyaSkge1xuICAgIHZhciBlbnRyaWVzID0gSW1hZ2VVcmlDYWNoZS5fZW50cmllcztcbiAgICB2YXIgbGFzdFVzZWRUaW1lc3RhbXAgPSBEYXRlLm5vdygpO1xuXG4gICAgaWYgKGVudHJpZXNbdXJpXSkge1xuICAgICAgZW50cmllc1t1cmldLmxhc3RVc2VkVGltZXN0YW1wID0gbGFzdFVzZWRUaW1lc3RhbXA7XG4gICAgICBlbnRyaWVzW3VyaV0ucmVmQ291bnQgKz0gMTtcbiAgICB9IGVsc2Uge1xuICAgICAgZW50cmllc1t1cmldID0ge1xuICAgICAgICBsYXN0VXNlZFRpbWVzdGFtcDogbGFzdFVzZWRUaW1lc3RhbXAsXG4gICAgICAgIHJlZkNvdW50OiAxXG4gICAgICB9O1xuICAgIH1cbiAgfTtcblxuICBJbWFnZVVyaUNhY2hlLnJlbW92ZSA9IGZ1bmN0aW9uIHJlbW92ZSh1cmkpIHtcbiAgICB2YXIgZW50cmllcyA9IEltYWdlVXJpQ2FjaGUuX2VudHJpZXM7XG5cbiAgICBpZiAoZW50cmllc1t1cmldKSB7XG4gICAgICBlbnRyaWVzW3VyaV0ucmVmQ291bnQgLT0gMTtcbiAgICB9IC8vIEZyZWUgdXAgZW50cmllcyB3aGVuIHRoZSBjYWNoZSBpcyBcImZ1bGxcIlxuXG5cbiAgICBJbWFnZVVyaUNhY2hlLl9jbGVhblVwSWZOZWVkZWQoKTtcbiAgfTtcblxuICBJbWFnZVVyaUNhY2hlLl9jbGVhblVwSWZOZWVkZWQgPSBmdW5jdGlvbiBfY2xlYW5VcElmTmVlZGVkKCkge1xuICAgIHZhciBlbnRyaWVzID0gSW1hZ2VVcmlDYWNoZS5fZW50cmllcztcbiAgICB2YXIgaW1hZ2VVcmlzID0gT2JqZWN0LmtleXMoZW50cmllcyk7XG5cbiAgICBpZiAoaW1hZ2VVcmlzLmxlbmd0aCArIDEgPiBJbWFnZVVyaUNhY2hlLl9tYXhpbXVtRW50cmllcykge1xuICAgICAgdmFyIGxlYXN0UmVjZW50bHlVc2VkS2V5O1xuICAgICAgdmFyIGxlYXN0UmVjZW50bHlVc2VkRW50cnk7XG4gICAgICBpbWFnZVVyaXMuZm9yRWFjaChmdW5jdGlvbiAodXJpKSB7XG4gICAgICAgIHZhciBlbnRyeSA9IGVudHJpZXNbdXJpXTtcblxuICAgICAgICBpZiAoKCFsZWFzdFJlY2VudGx5VXNlZEVudHJ5IHx8IGVudHJ5Lmxhc3RVc2VkVGltZXN0YW1wIDwgbGVhc3RSZWNlbnRseVVzZWRFbnRyeS5sYXN0VXNlZFRpbWVzdGFtcCkgJiYgZW50cnkucmVmQ291bnQgPT09IDApIHtcbiAgICAgICAgICBsZWFzdFJlY2VudGx5VXNlZEtleSA9IHVyaTtcbiAgICAgICAgICBsZWFzdFJlY2VudGx5VXNlZEVudHJ5ID0gZW50cnk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuXG4gICAgICBpZiAobGVhc3RSZWNlbnRseVVzZWRLZXkpIHtcbiAgICAgICAgZGVsZXRlIGVudHJpZXNbbGVhc3RSZWNlbnRseVVzZWRLZXldO1xuICAgICAgfVxuICAgIH1cbiAgfTtcblxuICByZXR1cm4gSW1hZ2VVcmlDYWNoZTtcbn0oKTtcblxuZXhwb3J0cy5JbWFnZVVyaUNhY2hlID0gSW1hZ2VVcmlDYWNoZTtcbkltYWdlVXJpQ2FjaGUuX21heGltdW1FbnRyaWVzID0gMjU2O1xuSW1hZ2VVcmlDYWNoZS5fZW50cmllcyA9IHt9O1xudmFyIGlkID0gMDtcbnZhciByZXF1ZXN0cyA9IHt9O1xudmFyIEltYWdlTG9hZGVyID0ge1xuICBhYm9ydDogZnVuY3Rpb24gYWJvcnQocmVxdWVzdElkKSB7XG4gICAgdmFyIGltYWdlID0gcmVxdWVzdHNbXCJcIiArIHJlcXVlc3RJZF07XG5cbiAgICBpZiAoaW1hZ2UpIHtcbiAgICAgIGltYWdlLm9uZXJyb3IgPSBudWxsO1xuICAgICAgaW1hZ2Uub25sb2FkID0gbnVsbDtcbiAgICAgIGltYWdlID0gbnVsbDtcbiAgICAgIGRlbGV0ZSByZXF1ZXN0c1tcIlwiICsgcmVxdWVzdElkXTtcbiAgICB9XG4gIH0sXG4gIGdldFNpemU6IGZ1bmN0aW9uIGdldFNpemUodXJpLCBzdWNjZXNzLCBmYWlsdXJlKSB7XG4gICAgdmFyIGNvbXBsZXRlID0gZmFsc2U7XG4gICAgdmFyIGludGVydmFsID0gc2V0SW50ZXJ2YWwoY2FsbGJhY2ssIDE2KTtcbiAgICB2YXIgcmVxdWVzdElkID0gSW1hZ2VMb2FkZXIubG9hZCh1cmksIGNhbGxiYWNrLCBlcnJvckNhbGxiYWNrKTtcblxuICAgIGZ1bmN0aW9uIGNhbGxiYWNrKCkge1xuICAgICAgdmFyIGltYWdlID0gcmVxdWVzdHNbXCJcIiArIHJlcXVlc3RJZF07XG5cbiAgICAgIGlmIChpbWFnZSkge1xuICAgICAgICB2YXIgbmF0dXJhbEhlaWdodCA9IGltYWdlLm5hdHVyYWxIZWlnaHQsXG4gICAgICAgICAgICBuYXR1cmFsV2lkdGggPSBpbWFnZS5uYXR1cmFsV2lkdGg7XG5cbiAgICAgICAgaWYgKG5hdHVyYWxIZWlnaHQgJiYgbmF0dXJhbFdpZHRoKSB7XG4gICAgICAgICAgc3VjY2VzcyhuYXR1cmFsV2lkdGgsIG5hdHVyYWxIZWlnaHQpO1xuICAgICAgICAgIGNvbXBsZXRlID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAoY29tcGxldGUpIHtcbiAgICAgICAgSW1hZ2VMb2FkZXIuYWJvcnQocmVxdWVzdElkKTtcbiAgICAgICAgY2xlYXJJbnRlcnZhbChpbnRlcnZhbCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gZXJyb3JDYWxsYmFjaygpIHtcbiAgICAgIGlmICh0eXBlb2YgZmFpbHVyZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICBmYWlsdXJlKCk7XG4gICAgICB9XG5cbiAgICAgIEltYWdlTG9hZGVyLmFib3J0KHJlcXVlc3RJZCk7XG4gICAgICBjbGVhckludGVydmFsKGludGVydmFsKTtcbiAgICB9XG4gIH0sXG4gIGhhczogZnVuY3Rpb24gaGFzKHVyaSkge1xuICAgIHJldHVybiBJbWFnZVVyaUNhY2hlLmhhcyh1cmkpO1xuICB9LFxuICBsb2FkOiBmdW5jdGlvbiBsb2FkKHVyaSwgb25Mb2FkLCBvbkVycm9yKSB7XG4gICAgaWQgKz0gMTtcbiAgICB2YXIgaW1hZ2UgPSBuZXcgd2luZG93LkltYWdlKCk7XG4gICAgaW1hZ2Uub25lcnJvciA9IG9uRXJyb3I7XG5cbiAgICBpbWFnZS5vbmxvYWQgPSBmdW5jdGlvbiAoZSkge1xuICAgICAgLy8gYXZvaWQgYmxvY2tpbmcgdGhlIG1haW4gdGhyZWFkXG4gICAgICB2YXIgb25EZWNvZGUgPSBmdW5jdGlvbiBvbkRlY29kZSgpIHtcbiAgICAgICAgcmV0dXJuIG9uTG9hZCh7XG4gICAgICAgICAgbmF0aXZlRXZlbnQ6IGVcbiAgICAgICAgfSk7XG4gICAgICB9O1xuXG4gICAgICBpZiAodHlwZW9mIGltYWdlLmRlY29kZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAvLyBTYWZhcmkgY3VycmVudGx5IHRocm93cyBleGNlcHRpb25zIHdoZW4gZGVjb2Rpbmcgc3Zncy5cbiAgICAgICAgLy8gV2Ugd2FudCB0byBjYXRjaCB0aGF0IGVycm9yIGFuZCBhbGxvdyB0aGUgbG9hZCBoYW5kbGVyXG4gICAgICAgIC8vIHRvIGJlIGZvcndhcmRlZCB0byB0aGUgb25Mb2FkIGhhbmRsZXIgaW4gdGhpcyBjYXNlXG4gICAgICAgIGltYWdlLmRlY29kZSgpLnRoZW4ob25EZWNvZGUsIG9uRGVjb2RlKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHNldFRpbWVvdXQob25EZWNvZGUsIDApO1xuICAgICAgfVxuICAgIH07XG5cbiAgICBpbWFnZS5zcmMgPSB1cmk7XG4gICAgcmVxdWVzdHNbXCJcIiArIGlkXSA9IGltYWdlO1xuICAgIHJldHVybiBpZDtcbiAgfSxcbiAgcHJlZmV0Y2g6IGZ1bmN0aW9uIHByZWZldGNoKHVyaSkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICBJbWFnZUxvYWRlci5sb2FkKHVyaSwgZnVuY3Rpb24gKCkge1xuICAgICAgICAvLyBBZGQgdGhlIHVyaSB0byB0aGUgY2FjaGUgc28gaXQgY2FuIGJlIGltbWVkaWF0ZWx5IGRpc3BsYXllZCB3aGVuIHVzZWRcbiAgICAgICAgLy8gYnV0IGFsc28gaW1tZWRpYXRlbHkgcmVtb3ZlIGl0IHRvIGNvcnJlY3RseSByZWZsZWN0IHRoYXQgaXQgaGFzIG5vIGFjdGl2ZSByZWZlcmVuY2VzXG4gICAgICAgIEltYWdlVXJpQ2FjaGUuYWRkKHVyaSk7XG4gICAgICAgIEltYWdlVXJpQ2FjaGUucmVtb3ZlKHVyaSk7XG4gICAgICAgIHJlc29sdmUoKTtcbiAgICAgIH0sIHJlamVjdCk7XG4gICAgfSk7XG4gIH0sXG4gIHF1ZXJ5Q2FjaGU6IGZ1bmN0aW9uIHF1ZXJ5Q2FjaGUodXJpcykge1xuICAgIHZhciByZXN1bHQgPSB7fTtcbiAgICB1cmlzLmZvckVhY2goZnVuY3Rpb24gKHUpIHtcbiAgICAgIGlmIChJbWFnZVVyaUNhY2hlLmhhcyh1KSkge1xuICAgICAgICByZXN1bHRbdV0gPSAnZGlzay9tZW1vcnknO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUocmVzdWx0KTtcbiAgfVxufTtcbnZhciBfZGVmYXVsdCA9IEltYWdlTG9hZGVyO1xuZXhwb3J0cy5kZWZhdWx0ID0gX2RlZmF1bHQ7Il19