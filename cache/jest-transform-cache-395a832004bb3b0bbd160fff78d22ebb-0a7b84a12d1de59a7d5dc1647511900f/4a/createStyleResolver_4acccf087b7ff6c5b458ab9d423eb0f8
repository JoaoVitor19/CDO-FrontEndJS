3d8fde05299b7265741165f7822fe4f9
"use strict";

exports.__esModule = true;
exports.default = createStyleResolver;

var _ExecutionEnvironment = require("fbjs/lib/ExecutionEnvironment");

var _createCSSStyleSheet = _interopRequireDefault(require("./createCSSStyleSheet"));

var _createCompileableStyle = _interopRequireDefault(require("./createCompileableStyle"));

var _createOrderedCSSStyleSheet = _interopRequireDefault(require("./createOrderedCSSStyleSheet"));

var _flattenArray = _interopRequireDefault(require("../../modules/flattenArray"));

var _flattenStyle = _interopRequireDefault(require("./flattenStyle"));

var _I18nManager = _interopRequireDefault(require("../I18nManager"));

var _i18nStyle = _interopRequireDefault(require("./i18nStyle"));

var _compile = require("./compile");

var _initialRules = _interopRequireDefault(require("./initialRules"));

var _modality = _interopRequireDefault(require("./modality"));

var _constants = require("./constants");

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {
    default: obj
  };
}

function createStyleResolver() {
  var inserted, sheet, cache;
  var resolved = {
    css: {},
    ltr: {},
    rtl: {},
    rtlNoSwap: {}
  };

  var init = function init() {
    inserted = {
      css: {},
      ltr: {},
      rtl: {},
      rtlNoSwap: {}
    };
    sheet = (0, _createOrderedCSSStyleSheet.default)((0, _createCSSStyleSheet.default)(_constants.STYLE_ELEMENT_ID));
    cache = {};
    (0, _modality.default)(function (rule) {
      return sheet.insert(rule, _constants.STYLE_GROUPS.modality);
    });

    _initialRules.default.forEach(function (rule) {
      sheet.insert(rule, _constants.STYLE_GROUPS.reset);
    });
  };

  init();

  function addToCache(className, prop, value) {
    if (!cache[prop]) {
      cache[prop] = {};
    }

    cache[prop][value] = className;
  }

  function getClassName(prop, value) {
    var val = (0, _compile.stringifyValueWithProperty)(value, prop);
    return cache[prop] && cache[prop].hasOwnProperty(val) && cache[prop][val];
  }

  function _injectRegisteredStyle(id) {
    var _I18nManager$getConst = _I18nManager.default.getConstants(),
        doLeftAndRightSwapInRTL = _I18nManager$getConst.doLeftAndRightSwapInRTL,
        isRTL = _I18nManager$getConst.isRTL;

    var dir = isRTL ? doLeftAndRightSwapInRTL ? 'rtl' : 'rtlNoSwap' : 'ltr';

    if (!inserted[dir][id]) {
      var style = (0, _createCompileableStyle.default)((0, _i18nStyle.default)((0, _flattenStyle.default)(id)));
      var results = (0, _compile.atomic)(style);
      Object.keys(results).forEach(function (key) {
        var _results$key = results[key],
            identifier = _results$key.identifier,
            property = _results$key.property,
            rules = _results$key.rules,
            value = _results$key.value;
        addToCache(identifier, property, value);
        rules.forEach(function (rule) {
          var group = _constants.STYLE_GROUPS.custom[property] || _constants.STYLE_GROUPS.atomic;
          sheet.insert(rule, group);
        });
      });
      inserted[dir][id] = true;
    }
  }

  function resolve(style, classList) {
    var nextClassList = [];
    var props = {};

    if (!style && !classList) {
      return props;
    }

    if (Array.isArray(classList)) {
      (0, _flattenArray.default)(classList).forEach(function (identifier) {
        if (identifier) {
          if (inserted.css[identifier] == null && resolved.css[identifier] != null) {
            var item = resolved.css[identifier];
            item.rules.forEach(function (rule) {
              sheet.insert(rule, item.group);
            });
            inserted.css[identifier] = true;
          }

          nextClassList.push(identifier);
        }
      });
    }

    if (typeof style === 'number') {
      _injectRegisteredStyle(style);

      var key = createCacheKey(style);
      props = _resolveStyle(style, key);
    } else if (!Array.isArray(style)) {
      props = _resolveStyle(style);
    } else {
      var flatArray = (0, _flattenArray.default)(style);
      var isArrayOfNumbers = true;
      var cacheKey = '';

      for (var i = 0; i < flatArray.length; i++) {
        var id = flatArray[i];

        if (typeof id !== 'number') {
          isArrayOfNumbers = false;
        } else {
          if (isArrayOfNumbers) {
            cacheKey += id + '-';
          }

          _injectRegisteredStyle(id);
        }
      }

      var _key = isArrayOfNumbers ? createCacheKey(cacheKey) : null;

      props = _resolveStyle(flatArray, _key);
    }

    nextClassList.push.apply(nextClassList, props.classList);
    var finalProps = {
      className: classListToString(nextClassList),
      classList: nextClassList
    };

    if (props.style) {
      finalProps.style = props.style;
    }

    return finalProps;
  }

  function _resolveStyle(style, key) {
    var _I18nManager$getConst2 = _I18nManager.default.getConstants(),
        doLeftAndRightSwapInRTL = _I18nManager$getConst2.doLeftAndRightSwapInRTL,
        isRTL = _I18nManager$getConst2.isRTL;

    var dir = isRTL ? doLeftAndRightSwapInRTL ? 'rtl' : 'rtlNoSwap' : 'ltr';

    if (key != null && resolved[dir][key] != null) {
      return resolved[dir][key];
    }

    var flatStyle = (0, _flattenStyle.default)(style);
    var localizedStyle = (0, _createCompileableStyle.default)((0, _i18nStyle.default)(flatStyle));
    var props = Object.keys(localizedStyle).sort().reduce(function (props, styleProp) {
      var value = localizedStyle[styleProp];

      if (value != null) {
        var className = getClassName(styleProp, value);

        if (className) {
          props.classList.push(className);
        } else {
          if (styleProp === 'animationKeyframes' || styleProp === 'placeholderTextColor' || styleProp === 'pointerEvents' || styleProp === 'scrollbarWidth') {
            var _atomic;

            var a = (0, _compile.atomic)((_atomic = {}, _atomic[styleProp] = value, _atomic));
            Object.keys(a).forEach(function (key) {
              var _a$key = a[key],
                  identifier = _a$key.identifier,
                  rules = _a$key.rules;
              props.classList.push(identifier);
              rules.forEach(function (rule) {
                sheet.insert(rule, _constants.STYLE_GROUPS.atomic);
              });
            });
          } else {
            if (!props.style) {
              props.style = {};
            }

            props.style[styleProp] = value;
          }
        }
      }

      return props;
    }, {
      classList: []
    });

    if (props.style) {
      props.style = (0, _compile.inline)(props.style);
    }

    if (key != null) {
      resolved[dir][key] = props;
    }

    return props;
  }

  return {
    getStyleSheet: function getStyleSheet() {
      var textContent = sheet.getTextContent();

      if (!_ExecutionEnvironment.canUseDOM) {
        init();
      }

      return {
        id: _constants.STYLE_ELEMENT_ID,
        textContent: textContent
      };
    },
    createCSS: function createCSS(rules, group) {
      var result = {};
      Object.keys(rules).forEach(function (name) {
        var style = rules[name];
        var compiled = (0, _compile.classic)(style, name);
        Object.keys(compiled).forEach(function (key) {
          var _compiled$key = compiled[key],
              identifier = _compiled$key.identifier,
              rules = _compiled$key.rules;
          resolved.css[identifier] = {
            group: group || _constants.STYLE_GROUPS.classic,
            rules: rules
          };
          result[name] = identifier;
        });
      });
      return result;
    },
    resolve: resolve,

    get sheet() {
      return sheet;
    }

  };
}

var createCacheKey = function createCacheKey(id) {
  var prefix = 'rn';
  return prefix + "-" + id;
};

var classListToString = function classListToString(list) {
  return list.join(' ').trim();
};

module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNyZWF0ZVN0eWxlUmVzb2x2ZXIuanMiXSwibmFtZXMiOlsiZXhwb3J0cyIsIl9fZXNNb2R1bGUiLCJkZWZhdWx0IiwiY3JlYXRlU3R5bGVSZXNvbHZlciIsIl9FeGVjdXRpb25FbnZpcm9ubWVudCIsInJlcXVpcmUiLCJfY3JlYXRlQ1NTU3R5bGVTaGVldCIsIl9pbnRlcm9wUmVxdWlyZURlZmF1bHQiLCJfY3JlYXRlQ29tcGlsZWFibGVTdHlsZSIsIl9jcmVhdGVPcmRlcmVkQ1NTU3R5bGVTaGVldCIsIl9mbGF0dGVuQXJyYXkiLCJfZmxhdHRlblN0eWxlIiwiX0kxOG5NYW5hZ2VyIiwiX2kxOG5TdHlsZSIsIl9jb21waWxlIiwiX2luaXRpYWxSdWxlcyIsIl9tb2RhbGl0eSIsIl9jb25zdGFudHMiLCJvYmoiLCJpbnNlcnRlZCIsInNoZWV0IiwiY2FjaGUiLCJyZXNvbHZlZCIsImNzcyIsImx0ciIsInJ0bCIsInJ0bE5vU3dhcCIsImluaXQiLCJTVFlMRV9FTEVNRU5UX0lEIiwicnVsZSIsImluc2VydCIsIlNUWUxFX0dST1VQUyIsIm1vZGFsaXR5IiwiZm9yRWFjaCIsInJlc2V0IiwiYWRkVG9DYWNoZSIsImNsYXNzTmFtZSIsInByb3AiLCJ2YWx1ZSIsImdldENsYXNzTmFtZSIsInZhbCIsInN0cmluZ2lmeVZhbHVlV2l0aFByb3BlcnR5IiwiaGFzT3duUHJvcGVydHkiLCJfaW5qZWN0UmVnaXN0ZXJlZFN0eWxlIiwiaWQiLCJfSTE4bk1hbmFnZXIkZ2V0Q29uc3QiLCJnZXRDb25zdGFudHMiLCJkb0xlZnRBbmRSaWdodFN3YXBJblJUTCIsImlzUlRMIiwiZGlyIiwic3R5bGUiLCJyZXN1bHRzIiwiYXRvbWljIiwiT2JqZWN0Iiwia2V5cyIsImtleSIsIl9yZXN1bHRzJGtleSIsImlkZW50aWZpZXIiLCJwcm9wZXJ0eSIsInJ1bGVzIiwiZ3JvdXAiLCJjdXN0b20iLCJyZXNvbHZlIiwiY2xhc3NMaXN0IiwibmV4dENsYXNzTGlzdCIsInByb3BzIiwiQXJyYXkiLCJpc0FycmF5IiwiaXRlbSIsInB1c2giLCJjcmVhdGVDYWNoZUtleSIsIl9yZXNvbHZlU3R5bGUiLCJmbGF0QXJyYXkiLCJpc0FycmF5T2ZOdW1iZXJzIiwiY2FjaGVLZXkiLCJpIiwibGVuZ3RoIiwiX2tleSIsImFwcGx5IiwiZmluYWxQcm9wcyIsImNsYXNzTGlzdFRvU3RyaW5nIiwiX0kxOG5NYW5hZ2VyJGdldENvbnN0MiIsImZsYXRTdHlsZSIsImxvY2FsaXplZFN0eWxlIiwic29ydCIsInJlZHVjZSIsInN0eWxlUHJvcCIsIl9hdG9taWMiLCJhIiwiX2Eka2V5IiwiaW5saW5lIiwiZ2V0U3R5bGVTaGVldCIsInRleHRDb250ZW50IiwiZ2V0VGV4dENvbnRlbnQiLCJjYW5Vc2VET00iLCJjcmVhdGVDU1MiLCJyZXN1bHQiLCJuYW1lIiwiY29tcGlsZWQiLCJjbGFzc2ljIiwiX2NvbXBpbGVkJGtleSIsInByZWZpeCIsImxpc3QiLCJqb2luIiwidHJpbSIsIm1vZHVsZSJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUFBLE9BQU8sQ0FBQ0MsVUFBUixHQUFxQixJQUFyQjtBQUNBRCxPQUFPLENBQUNFLE9BQVIsR0FBa0JDLG1CQUFsQjs7QUFFQSxJQUFJQyxxQkFBcUIsR0FBR0MsT0FBTyxDQUFDLCtCQUFELENBQW5DOztBQUVBLElBQUlDLG9CQUFvQixHQUFHQyxzQkFBc0IsQ0FBQ0YsT0FBTyx5QkFBUixDQUFqRDs7QUFFQSxJQUFJRyx1QkFBdUIsR0FBR0Qsc0JBQXNCLENBQUNGLE9BQU8sNEJBQVIsQ0FBcEQ7O0FBRUEsSUFBSUksMkJBQTJCLEdBQUdGLHNCQUFzQixDQUFDRixPQUFPLGdDQUFSLENBQXhEOztBQUVBLElBQUlLLGFBQWEsR0FBR0gsc0JBQXNCLENBQUNGLE9BQU8sOEJBQVIsQ0FBMUM7O0FBRUEsSUFBSU0sYUFBYSxHQUFHSixzQkFBc0IsQ0FBQ0YsT0FBTyxrQkFBUixDQUExQzs7QUFFQSxJQUFJTyxZQUFZLEdBQUdMLHNCQUFzQixDQUFDRixPQUFPLGtCQUFSLENB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LFNBQVNBLGNBQVQsQ0FBd0IxQixFQUF4QixFQUE0QjtBQUMvQyxNQUFJeUQsTUFBTSxHQUFHLElBQWI7QUFDQSxTQUFPQSxNQUFNLEdBQUcsR0FBVCxHQUFlekQsRUFBdEI7QUFDRCxDQUhEOztBQUtBLElBQUlvQyxpQkFBaUIsR0FBRyxTQUFTQSxpQkFBVCxDQUEyQnNCLElBQTNCLEVBQWlDO0FBQ3ZELFNBQU9BLElBQUksQ0FBQ0MsSUFBTCxDQUFVLEdBQVYsRUFBZUMsSUFBZixFQUFQO0FBQ0QsQ0FGRDs7QUFJQUMsTUFBTSxDQUFDekcsT0FBUCxHQUFpQkEsT0FBTyxDQUFDRSxPQUF6QiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5leHBvcnRzLl9fZXNNb2R1bGUgPSB0cnVlO1xuZXhwb3J0cy5kZWZhdWx0ID0gY3JlYXRlU3R5bGVSZXNvbHZlcjtcblxudmFyIF9FeGVjdXRpb25FbnZpcm9ubWVudCA9IHJlcXVpcmUoXCJmYmpzL2xpYi9FeGVjdXRpb25FbnZpcm9ubWVudFwiKTtcblxudmFyIF9jcmVhdGVDU1NTdHlsZVNoZWV0ID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKFwiLi9jcmVhdGVDU1NTdHlsZVNoZWV0XCIpKTtcblxudmFyIF9jcmVhdGVDb21waWxlYWJsZVN0eWxlID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKFwiLi9jcmVhdGVDb21waWxlYWJsZVN0eWxlXCIpKTtcblxudmFyIF9jcmVhdGVPcmRlcmVkQ1NTU3R5bGVTaGVldCA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZShcIi4vY3JlYXRlT3JkZXJlZENTU1N0eWxlU2hlZXRcIikpO1xuXG52YXIgX2ZsYXR0ZW5BcnJheSA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZShcIi4uLy4uL21vZHVsZXMvZmxhdHRlbkFycmF5XCIpKTtcblxudmFyIF9mbGF0dGVuU3R5bGUgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoXCIuL2ZsYXR0ZW5TdHlsZVwiKSk7XG5cbnZhciBfSTE4bk1hbmFnZXIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoXCIuLi9JMThuTWFuYWdlclwiKSk7XG5cbnZhciBfaTE4blN0eWxlID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKFwiLi9pMThuU3R5bGVcIikpO1xuXG52YXIgX2NvbXBpbGUgPSByZXF1aXJlKFwiLi9jb21waWxlXCIpO1xuXG52YXIgX2luaXRpYWxSdWxlcyA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZShcIi4vaW5pdGlhbFJ1bGVzXCIpKTtcblxudmFyIF9tb2RhbGl0eSA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZShcIi4vbW9kYWxpdHlcIikpO1xuXG52YXIgX2NvbnN0YW50cyA9IHJlcXVpcmUoXCIuL2NvbnN0YW50c1wiKTtcblxuZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgZGVmYXVsdDogb2JqIH07IH1cblxuLyoqXG4gKiBDb3B5cmlnaHQgKGMpIE5pY29sYXMgR2FsbGFnaGVyLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZVxuICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICpcbiAqIFxuICovXG5cbi8qKlxuICogV0FSTklORzogY2hhbmdlcyB0byB0aGlzIGZpbGUgaW4gcGFydGljdWxhciBjYW4gY2F1c2Ugc2lnbmlmaWNhbnQgY2hhbmdlcyB0b1xuICogdGhlIHJlc3VsdHMgb2YgcmVuZGVyIHBlcmZvcm1hbmNlIGJlbmNobWFya3MuXG4gKi9cbmZ1bmN0aW9uIGNyZWF0ZVN0eWxlUmVzb2x2ZXIoKSB7XG4gIHZhciBpbnNlcnRlZCwgc2hlZXQsIGNhY2hlO1xuICB2YXIgcmVzb2x2ZWQgPSB7XG4gICAgY3NzOiB7fSxcbiAgICBsdHI6IHt9LFxuICAgIHJ0bDoge30sXG4gICAgcnRsTm9Td2FwOiB7fVxuICB9O1xuXG4gIHZhciBpbml0ID0gZnVuY3Rpb24gaW5pdCgpIHtcbiAgICBpbnNlcnRlZCA9IHtcbiAgICAgIGNzczoge30sXG4gICAgICBsdHI6IHt9LFxuICAgICAgcnRsOiB7fSxcbiAgICAgIHJ0bE5vU3dhcDoge31cbiAgICB9O1xuICAgIHNoZWV0ID0gKDAsIF9jcmVhdGVPcmRlcmVkQ1NTU3R5bGVTaGVldC5kZWZhdWx0KSgoMCwgX2NyZWF0ZUNTU1N0eWxlU2hlZXQuZGVmYXVsdCkoX2NvbnN0YW50cy5TVFlMRV9FTEVNRU5UX0lEKSk7XG4gICAgY2FjaGUgPSB7fTtcbiAgICAoMCwgX21vZGFsaXR5LmRlZmF1bHQpKGZ1bmN0aW9uIChydWxlKSB7XG4gICAgICByZXR1cm4gc2hlZXQuaW5zZXJ0KHJ1bGUsIF9jb25zdGFudHMuU1RZTEVfR1JPVVBTLm1vZGFsaXR5KTtcbiAgICB9KTtcblxuICAgIF9pbml0aWFsUnVsZXMuZGVmYXVsdC5mb3JFYWNoKGZ1bmN0aW9uIChydWxlKSB7XG4gICAgICBzaGVldC5pbnNlcnQocnVsZSwgX2NvbnN0YW50cy5TVFlMRV9HUk9VUFMucmVzZXQpO1xuICAgIH0pO1xuICB9O1xuXG4gIGluaXQoKTtcblxuICBmdW5jdGlvbiBhZGRUb0NhY2hlKGNsYXNzTmFtZSwgcHJvcCwgdmFsdWUpIHtcbiAgICBpZiAoIWNhY2hlW3Byb3BdKSB7XG4gICAgICBjYWNoZVtwcm9wXSA9IHt9O1xuICAgIH1cblxuICAgIGNhY2hlW3Byb3BdW3ZhbHVlXSA9IGNsYXNzTmFtZTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldENsYXNzTmFtZShwcm9wLCB2YWx1ZSkge1xuICAgIHZhciB2YWwgPSAoMCwgX2NvbXBpbGUuc3RyaW5naWZ5VmFsdWVXaXRoUHJvcGVydHkpKHZhbHVlLCBwcm9wKTtcbiAgICByZXR1cm4gY2FjaGVbcHJvcF0gJiYgY2FjaGVbcHJvcF0uaGFzT3duUHJvcGVydHkodmFsKSAmJiBjYWNoZVtwcm9wXVt2YWxdO1xuICB9XG5cbiAgZnVuY3Rpb24gX2luamVjdFJlZ2lzdGVyZWRTdHlsZShpZCkge1xuICAgIHZhciBfSTE4bk1hbmFnZXIkZ2V0Q29uc3QgPSBfSTE4bk1hbmFnZXIuZGVmYXVsdC5nZXRDb25zdGFudHMoKSxcbiAgICAgICAgZG9MZWZ0QW5kUmlnaHRTd2FwSW5SVEwgPSBfSTE4bk1hbmFnZXIkZ2V0Q29uc3QuZG9MZWZ0QW5kUmlnaHRTd2FwSW5SVEwsXG4gICAgICAgIGlzUlRMID0gX0kxOG5NYW5hZ2VyJGdldENvbnN0LmlzUlRMO1xuXG4gICAgdmFyIGRpciA9IGlzUlRMID8gZG9MZWZ0QW5kUmlnaHRTd2FwSW5SVEwgPyAncnRsJyA6ICdydGxOb1N3YXAnIDogJ2x0cic7XG5cbiAgICBpZiAoIWluc2VydGVkW2Rpcl1baWRdKSB7XG4gICAgICB2YXIgc3R5bGUgPSAoMCwgX2NyZWF0ZUNvbXBpbGVhYmxlU3R5bGUuZGVmYXVsdCkoKDAsIF9pMThuU3R5bGUuZGVmYXVsdCkoKDAsIF9mbGF0dGVuU3R5bGUuZGVmYXVsdCkoaWQpKSk7XG4gICAgICB2YXIgcmVzdWx0cyA9ICgwLCBfY29tcGlsZS5hdG9taWMpKHN0eWxlKTtcbiAgICAgIE9iamVjdC5rZXlzKHJlc3VsdHMpLmZvckVhY2goZnVuY3Rpb24gKGtleSkge1xuICAgICAgICB2YXIgX3Jlc3VsdHMka2V5ID0gcmVzdWx0c1trZXldLFxuICAgICAgICAgICAgaWRlbnRpZmllciA9IF9yZXN1bHRzJGtleS5pZGVudGlmaWVyLFxuICAgICAgICAgICAgcHJvcGVydHkgPSBfcmVzdWx0cyRrZXkucHJvcGVydHksXG4gICAgICAgICAgICBydWxlcyA9IF9yZXN1bHRzJGtleS5ydWxlcyxcbiAgICAgICAgICAgIHZhbHVlID0gX3Jlc3VsdHMka2V5LnZhbHVlO1xuICAgICAgICBhZGRUb0NhY2hlKGlkZW50aWZpZXIsIHByb3BlcnR5LCB2YWx1ZSk7XG4gICAgICAgIHJ1bGVzLmZvckVhY2goZnVuY3Rpb24gKHJ1bGUpIHtcbiAgICAgICAgICB2YXIgZ3JvdXAgPSBfY29uc3RhbnRzLlNUWUxFX0dST1VQUy5jdXN0b21bcHJvcGVydHldIHx8IF9jb25zdGFudHMuU1RZTEVfR1JPVVBTLmF0b21pYztcbiAgICAgICAgICBzaGVldC5pbnNlcnQocnVsZSwgZ3JvdXApO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgICAgaW5zZXJ0ZWRbZGlyXVtpZF0gPSB0cnVlO1xuICAgIH1cbiAgfVxuICAvKipcbiAgICogUmVzb2x2ZXMgYSBSZWFjdCBOYXRpdmUgc3R5bGUgb2JqZWN0IHRvIERPTSBhdHRyaWJ1dGVzXG4gICAqL1xuXG5cbiAgZnVuY3Rpb24gcmVzb2x2ZShzdHlsZSwgY2xhc3NMaXN0KSB7XG4gICAgdmFyIG5leHRDbGFzc0xpc3QgPSBbXTtcbiAgICB2YXIgcHJvcHMgPSB7fTtcblxuICAgIGlmICghc3R5bGUgJiYgIWNsYXNzTGlzdCkge1xuICAgICAgcmV0dXJuIHByb3BzO1xuICAgIH1cblxuICAgIGlmIChBcnJheS5pc0FycmF5KGNsYXNzTGlzdCkpIHtcbiAgICAgICgwLCBfZmxhdHRlbkFycmF5LmRlZmF1bHQpKGNsYXNzTGlzdCkuZm9yRWFjaChmdW5jdGlvbiAoaWRlbnRpZmllcikge1xuICAgICAgICBpZiAoaWRlbnRpZmllcikge1xuICAgICAgICAgIGlmIChpbnNlcnRlZC5jc3NbaWRlbnRpZmllcl0gPT0gbnVsbCAmJiByZXNvbHZlZC5jc3NbaWRlbnRpZmllcl0gIT0gbnVsbCkge1xuICAgICAgICAgICAgdmFyIGl0ZW0gPSByZXNvbHZlZC5jc3NbaWRlbnRpZmllcl07XG4gICAgICAgICAgICBpdGVtLnJ1bGVzLmZvckVhY2goZnVuY3Rpb24gKHJ1bGUpIHtcbiAgICAgICAgICAgICAgc2hlZXQuaW5zZXJ0KHJ1bGUsIGl0ZW0uZ3JvdXApO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBpbnNlcnRlZC5jc3NbaWRlbnRpZmllcl0gPSB0cnVlO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIG5leHRDbGFzc0xpc3QucHVzaChpZGVudGlmaWVyKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKHR5cGVvZiBzdHlsZSA9PT0gJ251bWJlcicpIHtcbiAgICAgIC8vIGZhc3QgYW5kIGNhY2hhYmxlXG4gICAgICBfaW5qZWN0UmVnaXN0ZXJlZFN0eWxlKHN0eWxlKTtcblxuICAgICAgdmFyIGtleSA9IGNyZWF0ZUNhY2hlS2V5KHN0eWxlKTtcbiAgICAgIHByb3BzID0gX3Jlc29sdmVTdHlsZShzdHlsZSwga2V5KTtcbiAgICB9IGVsc2UgaWYgKCFBcnJheS5pc0FycmF5KHN0eWxlKSkge1xuICAgICAgLy8gcmVzb2x2ZSBhIHBsYWluIFJOIHN0eWxlIG9iamVjdFxuICAgICAgcHJvcHMgPSBfcmVzb2x2ZVN0eWxlKHN0eWxlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gZmxhdHRlbiB0aGUgc3R5bGUgYXJyYXlcbiAgICAgIC8vIGNhY2hlIHJlc29sdmVkIHByb3BzIHdoZW4gYWxsIHN0eWxlcyBhcmUgcmVnaXN0ZXJlZFxuICAgICAgLy8gb3RoZXJ3aXNlIGZhbGxiYWNrIHRvIHJlc29sdmluZ1xuICAgICAgdmFyIGZsYXRBcnJheSA9ICgwLCBfZmxhdHRlbkFycmF5LmRlZmF1bHQpKHN0eWxlKTtcbiAgICAgIHZhciBpc0FycmF5T2ZOdW1iZXJzID0gdHJ1ZTtcbiAgICAgIHZhciBjYWNoZUtleSA9ICcnO1xuXG4gICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGZsYXRBcnJheS5sZW5ndGg7IGkrKykge1xuICAgICAgICB2YXIgaWQgPSBmbGF0QXJyYXlbaV07XG5cbiAgICAgICAgaWYgKHR5cGVvZiBpZCAhPT0gJ251bWJlcicpIHtcbiAgICAgICAgICBpc0FycmF5T2ZOdW1iZXJzID0gZmFsc2U7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaWYgKGlzQXJyYXlPZk51bWJlcnMpIHtcbiAgICAgICAgICAgIGNhY2hlS2V5ICs9IGlkICsgJy0nO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIF9pbmplY3RSZWdpc3RlcmVkU3R5bGUoaWQpO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHZhciBfa2V5ID0gaXNBcnJheU9mTnVtYmVycyA/IGNyZWF0ZUNhY2hlS2V5KGNhY2hlS2V5KSA6IG51bGw7XG5cbiAgICAgIHByb3BzID0gX3Jlc29sdmVTdHlsZShmbGF0QXJyYXksIF9rZXkpO1xuICAgIH1cblxuICAgIG5leHRDbGFzc0xpc3QucHVzaC5hcHBseShuZXh0Q2xhc3NMaXN0LCBwcm9wcy5jbGFzc0xpc3QpO1xuICAgIHZhciBmaW5hbFByb3BzID0ge1xuICAgICAgY2xhc3NOYW1lOiBjbGFzc0xpc3RUb1N0cmluZyhuZXh0Q2xhc3NMaXN0KSxcbiAgICAgIGNsYXNzTGlzdDogbmV4dENsYXNzTGlzdFxuICAgIH07XG5cbiAgICBpZiAocHJvcHMuc3R5bGUpIHtcbiAgICAgIGZpbmFsUHJvcHMuc3R5bGUgPSBwcm9wcy5zdHlsZTtcbiAgICB9XG5cbiAgICByZXR1cm4gZmluYWxQcm9wcztcbiAgfVxuICAvKipcbiAgICogUmVzb2x2ZXMgYSBSZWFjdCBOYXRpdmUgc3R5bGUgb2JqZWN0XG4gICAqL1xuXG5cbiAgZnVuY3Rpb24gX3Jlc29sdmVTdHlsZShzdHlsZSwga2V5KSB7XG4gICAgdmFyIF9JMThuTWFuYWdlciRnZXRDb25zdDIgPSBfSTE4bk1hbmFnZXIuZGVmYXVsdC5nZXRDb25zdGFudHMoKSxcbiAgICAgICAgZG9MZWZ0QW5kUmlnaHRTd2FwSW5SVEwgPSBfSTE4bk1hbmFnZXIkZ2V0Q29uc3QyLmRvTGVmdEFuZFJpZ2h0U3dhcEluUlRMLFxuICAgICAgICBpc1JUTCA9IF9JMThuTWFuYWdlciRnZXRDb25zdDIuaXNSVEw7XG5cbiAgICB2YXIgZGlyID0gaXNSVEwgPyBkb0xlZnRBbmRSaWdodFN3YXBJblJUTCA/ICdydGwnIDogJ3J0bE5vU3dhcCcgOiAnbHRyJzsgLy8gZmFzdGVyOiBtZW1vaXplZFxuXG4gICAgaWYgKGtleSAhPSBudWxsICYmIHJlc29sdmVkW2Rpcl1ba2V5XSAhPSBudWxsKSB7XG4gICAgICByZXR1cm4gcmVzb2x2ZWRbZGlyXVtrZXldO1xuICAgIH1cblxuICAgIHZhciBmbGF0U3R5bGUgPSAoMCwgX2ZsYXR0ZW5TdHlsZS5kZWZhdWx0KShzdHlsZSk7XG4gICAgdmFyIGxvY2FsaXplZFN0eWxlID0gKDAsIF9jcmVhdGVDb21waWxlYWJsZVN0eWxlLmRlZmF1bHQpKCgwLCBfaTE4blN0eWxlLmRlZmF1bHQpKGZsYXRTdHlsZSkpOyAvLyBzbG93ZXI6IGNvbnZlcnQgc3R5bGUgb2JqZWN0IHRvIHByb3BzIGFuZCBjYWNoZVxuXG4gICAgdmFyIHByb3BzID0gT2JqZWN0LmtleXMobG9jYWxpemVkU3R5bGUpLnNvcnQoKS5yZWR1Y2UoZnVuY3Rpb24gKHByb3BzLCBzdHlsZVByb3ApIHtcbiAgICAgIHZhciB2YWx1ZSA9IGxvY2FsaXplZFN0eWxlW3N0eWxlUHJvcF07XG5cbiAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7XG4gICAgICAgIHZhciBjbGFzc05hbWUgPSBnZXRDbGFzc05hbWUoc3R5bGVQcm9wLCB2YWx1ZSk7XG5cbiAgICAgICAgaWYgKGNsYXNzTmFtZSkge1xuICAgICAgICAgIHByb3BzLmNsYXNzTGlzdC5wdXNoKGNsYXNzTmFtZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgLy8gQ2VydGFpbiBwcm9wZXJ0aWVzIGFuZCB2YWx1ZXMgYXJlIG5vdCB0cmFuc2Zvcm1lZCBieSAnY3JlYXRlUmVhY3RET01TdHlsZScgYXMgdGhleVxuICAgICAgICAgIC8vIHJlcXVpcmUgbW9yZSBjb21wbGV4IHRyYW5zZm9ybXMgaW50byBtdWx0aXBsZSBDU1MgcnVsZXMuIEhlcmUgd2UgYXNzdW1lIHRoYXQgU3R5bGVNYW5hZ2VyXG4gICAgICAgICAgLy8gY2FuIGJpbmQgdGhlc2Ugc3R5bGVzIHRvIGEgY2xhc3NOYW1lLCBhbmQgcHJldmVudCB0aGVtIGJlY29taW5nIGludmFsaWQgaW5saW5lLXN0eWxlcy5cbiAgICAgICAgICBpZiAoc3R5bGVQcm9wID09PSAnYW5pbWF0aW9uS2V5ZnJhbWVzJyB8fCBzdHlsZVByb3AgPT09ICdwbGFjZWhvbGRlclRleHRDb2xvcicgfHwgc3R5bGVQcm9wID09PSAncG9pbnRlckV2ZW50cycgfHwgc3R5bGVQcm9wID09PSAnc2Nyb2xsYmFyV2lkdGgnKSB7XG4gICAgICAgICAgICB2YXIgX2F0b21pYztcblxuICAgICAgICAgICAgdmFyIGEgPSAoMCwgX2NvbXBpbGUuYXRvbWljKSgoX2F0b21pYyA9IHt9LCBfYXRvbWljW3N0eWxlUHJvcF0gPSB2YWx1ZSwgX2F0b21pYykpO1xuICAgICAgICAgICAgT2JqZWN0LmtleXMoYSkuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7XG4gICAgICAgICAgICAgIHZhciBfYSRrZXkgPSBhW2tleV0sXG4gICAgICAgICAgICAgICAgICBpZGVudGlmaWVyID0gX2Eka2V5LmlkZW50aWZpZXIsXG4gICAgICAgICAgICAgICAgICBydWxlcyA9IF9hJGtleS5ydWxlcztcbiAgICAgICAgICAgICAgcHJvcHMuY2xhc3NMaXN0LnB1c2goaWRlbnRpZmllcik7XG4gICAgICAgICAgICAgIHJ1bGVzLmZvckVhY2goZnVuY3Rpb24gKHJ1bGUpIHtcbiAgICAgICAgICAgICAgICBzaGVldC5pbnNlcnQocnVsZSwgX2NvbnN0YW50cy5TVFlMRV9HUk9VUFMuYXRvbWljKTtcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKCFwcm9wcy5zdHlsZSkge1xuICAgICAgICAgICAgICBwcm9wcy5zdHlsZSA9IHt9O1xuICAgICAgICAgICAgfSAvLyA0eCBzbG93ZXIgcmVuZGVyXG5cblxuICAgICAgICAgICAgcHJvcHMuc3R5bGVbc3R5bGVQcm9wXSA9IHZhbHVlO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gcHJvcHM7XG4gICAgfSwge1xuICAgICAgY2xhc3NMaXN0OiBbXVxuICAgIH0pO1xuXG4gICAgaWYgKHByb3BzLnN0eWxlKSB7XG4gICAgICBwcm9wcy5zdHlsZSA9ICgwLCBfY29tcGlsZS5pbmxpbmUpKHByb3BzLnN0eWxlKTtcbiAgICB9XG5cbiAgICBpZiAoa2V5ICE9IG51bGwpIHtcbiAgICAgIHJlc29sdmVkW2Rpcl1ba2V5XSA9IHByb3BzO1xuICAgIH1cblxuICAgIHJldHVybiBwcm9wcztcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgZ2V0U3R5bGVTaGVldDogZnVuY3Rpb24gZ2V0U3R5bGVTaGVldCgpIHtcbiAgICAgIHZhciB0ZXh0Q29udGVudCA9IHNoZWV0LmdldFRleHRDb250ZW50KCk7IC8vIFJlc2V0IHN0YXRlIG9uIHRoZSBzZXJ2ZXIgc28gY3JpdGljYWwgY3NzIGlzIGFsd2F5cyB0aGUgcmVzdWx0XG5cbiAgICAgIGlmICghX0V4ZWN1dGlvbkVudmlyb25tZW50LmNhblVzZURPTSkge1xuICAgICAgICBpbml0KCk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIGlkOiBfY29uc3RhbnRzLlNUWUxFX0VMRU1FTlRfSUQsXG4gICAgICAgIHRleHRDb250ZW50OiB0ZXh0Q29udGVudFxuICAgICAgfTtcbiAgICB9LFxuICAgIGNyZWF0ZUNTUzogZnVuY3Rpb24gY3JlYXRlQ1NTKHJ1bGVzLCBncm91cCkge1xuICAgICAgdmFyIHJlc3VsdCA9IHt9O1xuICAgICAgT2JqZWN0LmtleXMocnVsZXMpLmZvckVhY2goZnVuY3Rpb24gKG5hbWUpIHtcbiAgICAgICAgdmFyIHN0eWxlID0gcnVsZXNbbmFtZV07XG4gICAgICAgIHZhciBjb21waWxlZCA9ICgwLCBfY29tcGlsZS5jbGFzc2ljKShzdHlsZSwgbmFtZSk7XG4gICAgICAgIE9iamVjdC5rZXlzKGNvbXBpbGVkKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHtcbiAgICAgICAgICB2YXIgX2NvbXBpbGVkJGtleSA9IGNvbXBpbGVkW2tleV0sXG4gICAgICAgICAgICAgIGlkZW50aWZpZXIgPSBfY29tcGlsZWQka2V5LmlkZW50aWZpZXIsXG4gICAgICAgICAgICAgIHJ1bGVzID0gX2NvbXBpbGVkJGtleS5ydWxlcztcbiAgICAgICAgICByZXNvbHZlZC5jc3NbaWRlbnRpZmllcl0gPSB7XG4gICAgICAgICAgICBncm91cDogZ3JvdXAgfHwgX2NvbnN0YW50cy5TVFlMRV9HUk9VUFMuY2xhc3NpYyxcbiAgICAgICAgICAgIHJ1bGVzOiBydWxlc1xuICAgICAgICAgIH07XG4gICAgICAgICAgcmVzdWx0W25hbWVdID0gaWRlbnRpZmllcjtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSxcbiAgICByZXNvbHZlOiByZXNvbHZlLFxuXG4gICAgZ2V0IHNoZWV0KCkge1xuICAgICAgcmV0dXJuIHNoZWV0O1xuICAgIH1cblxuICB9O1xufVxuLyoqXG4gKiBNaXNjIGhlbHBlcnNcbiAqL1xuXG5cbnZhciBjcmVhdGVDYWNoZUtleSA9IGZ1bmN0aW9uIGNyZWF0ZUNhY2hlS2V5KGlkKSB7XG4gIHZhciBwcmVmaXggPSAncm4nO1xuICByZXR1cm4gcHJlZml4ICsgXCItXCIgKyBpZDtcbn07XG5cbnZhciBjbGFzc0xpc3RUb1N0cmluZyA9IGZ1bmN0aW9uIGNsYXNzTGlzdFRvU3RyaW5nKGxpc3QpIHtcbiAgcmV0dXJuIGxpc3Quam9pbignICcpLnRyaW0oKTtcbn07XG5cbm1vZHVsZS5leHBvcnRzID0gZXhwb3J0cy5kZWZhdWx0OyJdfQ==