40ac790d50056fee75c8a2ce2afe7cd3
"use strict";

exports.__esModule = true;
exports.default = void 0;

var React = _interopRequireWildcard(require("react"));

var _ModalPortal = _interopRequireDefault(require("./ModalPortal"));

var _ModalAnimation = _interopRequireDefault(require("./ModalAnimation"));

var _ModalContent = _interopRequireDefault(require("./ModalContent"));

var _ModalFocusTrap = _interopRequireDefault(require("./ModalFocusTrap"));

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {
    default: obj
  };
}

function _getRequireWildcardCache() {
  if (typeof WeakMap !== "function") return null;
  var cache = new WeakMap();

  _getRequireWildcardCache = function _getRequireWildcardCache() {
    return cache;
  };

  return cache;
}

function _interopRequireWildcard(obj) {
  if (obj && obj.__esModule) {
    return obj;
  }

  if (obj === null || typeof obj !== "object" && typeof obj !== "function") {
    return {
      default: obj
    };
  }

  var cache = _getRequireWildcardCache();

  if (cache && cache.has(obj)) {
    return cache.get(obj);
  }

  var newObj = {};
  var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor;

  for (var key in obj) {
    if (Object.prototype.hasOwnProperty.call(obj, key)) {
      var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null;

      if (desc && (desc.get || desc.set)) {
        Object.defineProperty(newObj, key, desc);
      } else {
        newObj[key] = obj[key];
      }
    }
  }

  newObj.default = obj;

  if (cache) {
    cache.set(obj, newObj);
  }

  return newObj;
}

var uniqueModalIdentifier = 0;
var activeModalStack = [];
var activeModalListeners = {};

function notifyActiveModalListeners() {
  if (activeModalStack.length === 0) {
    return;
  }

  var activeModalId = activeModalStack[activeModalStack.length - 1];
  activeModalStack.forEach(function (modalId) {
    if (modalId in activeModalListeners) {
      activeModalListeners[modalId](modalId === activeModalId);
    }
  });
}

function removeActiveModal(modalId) {
  if (modalId in activeModalListeners) {
    activeModalListeners[modalId](false);
    delete activeModalListeners[modalId];
  }

  var index = activeModalStack.indexOf(modalId);

  if (index !== -1) {
    activeModalStack.splice(index, 1);
    notifyActiveModalListeners();
  }
}

function addActiveModal(modalId, listener) {
  removeActiveModal(modalId);
  activeModalStack.push(modalId);
  activeModalListeners[modalId] = listener;
  notifyActiveModalListeners();
}

var Modal = React.forwardRef(function (props, forwardedRef) {
  var animationType = props.animationType,
      children = props.children,
      onDismiss = props.onDismiss,
      onRequestClose = props.onRequestClose,
      onShow = props.onShow,
      transparent = props.transparent,
      _props$visible = props.visible,
      visible = _props$visible === void 0 ? true : _props$visible;
  var modalId = React.useMemo(function () {
    return uniqueModalIdentifier++;
  }, []);

  var _React$useState = React.useState(false),
      isActive = _React$useState[0],
      setIsActive = _React$useState[1];

  var onDismissCallback = React.useCallback(function () {
    removeActiveModal(modalId);

    if (onDismiss) {
      onDismiss();
    }
  }, [modalId, onDismiss]);
  var onShowCallback = React.useCallback(function () {
    addActiveModal(modalId, setIsActive);

    if (onShow) {
      onShow();
    }
  }, [modalId, onShow]);
  React.useEffect(function () {
    return function () {
      return removeActiveModal(modalId);
    };
  }, [modalId]);
  return React.createElement(_ModalPortal.default, null, React.createElement(_ModalAnimation.default, {
    animationType: animationType,
    onDismiss: onDismissCallback,
    onShow: onShowCallback,
    visible: visible
  }, React.createElement(_ModalFocusTrap.default, {
    active: isActive
  }, React.createElement(_ModalContent.default, {
    active: isActive,
    onRequestClose: onRequestClose,
    ref: forwardedRef,
    transparent: transparent
  }, children))));
});
var _default = Modal;
exports.default = _default;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LmpzIl0sIm5hbWVzIjpbImV4cG9ydHMiLCJfX2VzTW9kdWxlIiwiZGVmYXVsdCIsIlJlYWN0IiwiX2ludGVyb3BSZXF1aXJlV2lsZGNhcmQiLCJyZXF1aXJlIiwiX01vZGFsUG9ydGFsIiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsIl9Nb2RhbEFuaW1hdGlvbiIsIl9Nb2RhbENvbnRlbnQiLCJfTW9kYWxGb2N1c1RyYXAiLCJvYmoiLCJfZ2V0UmVxdWlyZVdpbGRjYXJkQ2FjaGUiLCJXZWFrTWFwIiwiY2FjaGUiLCJoYXMiLCJnZXQiLCJuZXdPYmoiLCJoYXNQcm9wZXJ0eURlc2NyaXB0b3IiLCJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsImtleSIsInByb3RvdHlwZSIsImhhc093blByb3BlcnR5IiwiY2FsbCIsImRlc2MiLCJzZXQiLCJ1bmlxdWVNb2RhbElkZW50aWZpZXIiLCJhY3RpdmVNb2RhbFN0YWNrIiwiYWN0aXZlTW9kYWxMaXN0ZW5lcnMiLCJub3RpZnlBY3RpdmVNb2RhbExpc3RlbmVycyIsImxlbmd0aCIsImFjdGl2ZU1vZGFsSWQiLCJmb3JFYWNoIiwibW9kYWxJZCIsInJlbW92ZUFjdGl2ZU1vZGFsIiwiaW5kZXgiLCJpbmRleE9mIiwic3BsaWNlIiwiYWRkQWN0aXZlTW9kYWwiLCJsaXN0ZW5lciIsInB1c2giLCJNb2RhbCIsImZvcndhcmRSZWYiLCJwcm9wcyIsImZvcndhcmRlZFJlZiIsImFuaW1hdGlvblR5cGUiLCJjaGlsZHJlbiIsIm9uRGlzbWlzcyIsIm9uUmVxdWVzdENsb3NlIiwib25TaG93IiwidHJhbnNwYXJlbnQiLCJfcHJvcHMkdmlzaWJsZSIsInZpc2libGUiLCJ1c2VNZW1vIiwiX1JlYWN0JHVzZVN0YXRlIiwidXNlU3RhdGUiLCJpc0FjdGl2ZSIsInNldElzQWN0aXZlIiwib25EaXNtaXNzQ2FsbGJhY2siLCJ1c2VDYWxsYmFjayIsIm9uU2hvd0NhbGxiYWNrIiwidXNlRWZmZWN0IiwiY3JlYXRlRWxlbWVudCIsImFjdGl2ZSIsInJlZiIsIl9kZWZhdWx0IiwibW9kdWxlIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQUEsT0FBTyxDQUFDQyxVQUFSLEdBQXFCLElBQXJCO0FBQ0FELE9BQU8sQ0FBQ0UsT0FBUixHQUFrQixLQUFLLENBQXZCOztBQUVBLElBQUlDLEtBQUssR0FBR0MsdUJBQXVCLENBQUNDLE9BQU8sQ0FBQyxPQUFELENBQVIsQ0FBbkM7O0FBRUEsSUFBSUMsWUFBWSxHQUFHQyxzQkFBc0IsQ0FBQ0YsT0FBTyxpQkFBUixDQUF6Qzs7QUFFQSxJQUFJRyxlQUFlLEdBQUdELHNCQUFzQixDQUFDRixPQUFPLG9CQUFSLENBQTVDOztBQUVBLElBQUlJLGFBQWEsR0FBR0Ysc0JBQXNCLENBQUNGLE9BQU8sa0JBQVIsQ0FBMUM7O0FBRUEsSUFBSUssZUFBZSxHQUFHSCxzQkFBc0IsQ0FBQ0YsT0FBTyxvQkFBUixDQUE1Qzs7QUFFQSxTQUFTRSxzQkFBVCxDQUFnQ0ksR0FBaEMsRUFBcUM7QUFBRSxTQUFPQSxHQUFHLElBQUlBLEdBQUcsQ0FBQ1YsVUFBWCxHQUF3QlUsR0FBeEIsR0FBOEI7QUFBRVQsSUFBQUEsT0FBTyxFQUFFUztBQUFYLEdBQXJDO0FBQXdEOztBQUUvRixTQUFTQyx3QkFBVCxHQUFvQztBQUFFLE1BQUksT0FBT0MsT0FBUCxLQUFtQixVQUF2QixFQUFtQyxPQUFPLElBQVA7QUFBYSxNQUFJQyxLQUFLLEdBQUcsSUFBSUQsT0FBSixFQUFaOztBQUEyQkQsRUFBQUEsd0JBQXdCLEdBQUcsU0FBU0Esd0JBQVQsR0FBb0M7QUFBRSxXQUFPRSxLQUFQO0FBQWUsR0FBaEY7O0FBQWtGLFNBQU9BLEtBQVA7QUFBZTs7QUFFbE4sU0FBU1YsdUJBQVQsQ0FBaUNPLEdBQWpDLEVBQXNDO0FBQUUsTUFBSUEsR0FBRyxJQUFJQSxHQUFHLENBQUNWLFVBQWYsRUFBMkI7QUFBRSxXQUFPVSxHQUFQO0FBQWE7O0FBQUMsTUFBSUEsR0FBRyxLQUFLLElBQVIsSUFBZ0IsT0FBT0EsR0FBUCxLQUFlLFFBQWYsSUFBMkIsT0FBT0EsR0FBUCxLQUFlLFVBQTlELEVBQTBFO0FBQUUsV0FBTztBQUFFVCxNQUFBQSxPQUFPLEVBQUVTO0FBQVgsS0FBUDtBQUEwQjs7QUFBQyxNQUFJRyxLQUFLLEdBQUdGLHdCQUF3QixFQUFwQzs7QUFBd0MsTUFBSUUsS0FBSyxJQUFJQSxLQUFLLENBQUNDLEdBQU4sQ0FBVUosR0FBVixDQUFiLEVBQTZCO0FBQUUsV0FBT0csS0FBSyxDQUFDRSxHQUFOLENBQVVMLEdBQVYsQ0FBUDtBQUF3Qjs7QUFBQyxNQUFJTSxNQUFNLEdBQUcsRUFBYjtBQUFpQixNQUFJQyxxQkFBcUIsR0FBR0MsTUFBTSxDQUFDQyxjQUFQLElBQXlCRCxNQUFNLENBQUNFLHdCQUE1RDs7QUFBc0YsT0FBSyxJQUFJQyxHQUFULElBQWdCWCxHQUFoQixFQUFxQjtBQUFFLFFBQUlRLE1BQU0sQ0FBQ0ksU0FBUCxDQUFpQkMsY0FBakIsQ0FBZ0NDLElBQWhDLENBQXFDZCxHQUFyQyxFQUEwQ1csR0FBMUMsQ0FBSixFQUFvRDtBQUFFLFVBQUlJLElBQUksR0FBR1IscUJBQXFCLEdBQUdDLE1BQU0sQ0FBQ0Usd0JBQVAsQ0FBZ0NWLEdBQWhDLEVBQXFDVyxHQUFyQyxDQUFILEdBQStDLElBQS9FOztBQUFxRixVQUFJSSxJQUFJLEtBQUtBLElBQUksQ0FBQ1YsR0FBTCxJQUFZVSxJQUFJLENBQUNDLEdBQXRCLENBQVIsRUFBb0M7QUFBRVIsUUFBQUEsTUFBTSxDQUFDQyxjQUFQLENBQXNCSCxNQUF0QixFQUE4QkssR0FBOUIsRUFBbUNJLElBQW5DO0FBQTJDLE9BQWpGLE1BQXVGO0FBQUVULFFBQUFBLE1BQU0sQ0FBQ0ssR0FBRCxDQUFOLEdBQWNYLEdBQUcsQ0FBQ1csR0FBRCxDQUFqQjtBQUF5QjtBQUFFO0FBQUU7O0FBQUNMLEVBQUFBLE1BQU0sQ0FBQ2YsT0FBUCxHQUFpQlMsR0FBakI7O0FBQXNCLE1BQUlHLEtBQUosRUFBVztBQUFFQSxJQUFBQSxLQUFLLENBQUNhLEdBQU4sQ0FBVWhCLEdBQVYsRUFBZU0sTUFBZjtBQUF5Qjs7QUFBQyxTQUFPQSxNQUFQO0FBQWdCOztBQVd2dUIsSUFBSVcscUJBQXFCLEdBQUcsQ0FBNUI7QUFDQSxJQUFJQyxnQkFBZ0IsR0FBRyxFQUF2QjtBQUNBLElBQUlDLG9CQUFvQixHQUFHLEVBQTNCOztBQUVBLFNBQVNDLDBCQUFULEdBQXNDO0FBQ3BDLE1BQUlGLGdCQUFnQixDQUFDRyxNQUFqQixLQUE0QixDQUFoQyxFQUFtQztBQUNqQztBQUNEOztBQUVELE1BQUlDLGFBQWEsR0FBR0osZ0JBQWdCLENBQUNBLGdCQUFnQixDQUFDRyxNQUFqQixHQUEwQixDQUEzQixDQUFwQztBQUNBSCxFQUFBQSxnQkFBZ0IsQ0FBQ0ssT0FBakIsQ0FBeUIsVUFBVUMsT0FBVixFQUFtQjtBQUMxQyxRQUFJQSxPQUFPLElBQUlMLG9CQUFmLEVBQXFDO0FBQ25DQSxNQUFBQSxvQkFBb0IsQ0FBQ0ssT0FBRCxDQUFwQixDQUE4QkEsT0FBTyxLQUFLRixhQUExQztBQUNEO0FBQ0YsR0FKRDtBQUtEOztBQUVELFNBQVNHLGlCQUFULENBQTJCRCxPQUEzQixFQUFvQztBQUNsQyxNQUFJQSxPQUFPLElBQUlMLG9CQUFmLEVBQXFDO0FBR25DQSxJQUFBQSxvQkFBb0IsQ0FBQ0ssT0FBRCxDQUFwQixDQUE4QixLQUE5QjtBQUNBLFdBQU9MLG9CQUFvQixDQUFDSyxPQUFELENBQTNCO0FBQ0Q7O0FBRUQsTUFBSUUsS0FBSyxHQUFHUixnQkFBZ0IsQ0FBQ1MsT0FBakIsQ0FBeUJILE9BQXpCLENBQVo7O0FBRUEsTUFBSUUsS0FBSyxLQUFLLENBQUMsQ0FBZixFQUFrQjtBQUNoQlIsSUFBQUEsZ0JBQWdCLENBQUNVLE1BQWpCLENBQXdCRixLQUF4QixFQUErQixDQUEvQjtBQUNBTixJQUFBQSwwQkFBMEI7QUFDM0I7QUFDRjs7QUFFRCxTQUFTUyxjQUFULENBQXdCTCxPQUF4QixFQUFpQ00sUUFBakMsRUFBMkM7QUFDekNMLEVBQUFBLGlCQUFpQixDQUFDRCxPQUFELENBQWpCO0FBQ0FOLEVBQUFBLGdCQUFnQixDQUFDYSxJQUFqQixDQUFzQlAsT0FBdEI7QUFDQUwsRUFBQUEsb0JBQW9CLENBQUNLLE9BQUQsQ0FBcEIsR0FBZ0NNLFFBQWhDO0FBQ0FWLEVBQUFBLDBCQUEwQjtBQUMzQjs7QUFFRCxJQUFJWSxLQUFLLEdBQWdCeEMsS0FBSyxDQUFDeUMsVUFBTixDQUFpQixVQUFVQyxLQUFWLEVBQWlCQyxZQUFqQixFQUErQjtBQUN2RSxNQUFJQyxhQUFhLEdBQUdGLEtBQUssQ0FBQ0UsYUFBMUI7QUFBQSxNQUNJQyxRQUFRLEdBQUdILEtBQUssQ0FBQ0csUUFEckI7QUFBQSxNQUVJQyxTQUFTLEdBQUdKLEtBQUssQ0FBQ0ksU0FGdEI7QUFBQSxNQUdJQyxjQUFjLEdBQUdMLEtBQUssQ0FBQ0ssY0FIM0I7QUFBQSxNQUlJQyxNQUFNLEdBQUdOLEtBQUssQ0FBQ00sTUFKbkI7QUFBQSxNQUtJQyxXQUFXLEdBQUdQLEtBQUssQ0FBQ08sV0FMeEI7QUFBQSxNQU1JQyxjQUFjLEdBQUdSLEtBQUssQ0FBQ1MsT0FOM0I7QUFBQSxNQU9JQSxPQUFPLEdBQUdELGNBQWMsS0FBSyxLQUFLLENBQXhCLEdBQTRCLElBQTVCLEdBQW1DQSxjQVBqRDtBQVVBLE1BQUlsQixPQUFPLEdBQUdoQyxLQUFLLENBQUNvRCxPQUFOLENBQWMsWUFBWTtBQUN0QyxXQUFPM0IscUJBQXFCLEVBQTVCO0FBQ0QsR0FGYSxFQUVYLEVBRlcsQ0FBZDs7QUFJQSxNQUFJNEIsZUFBZSxHQUFHckQsS0FBSyxDQUFDc0QsUUFBTixDQUFlLEtBQWYsQ0FBdEI7QUFBQSxNQUNJQyxRQUFRLEdBQUdGLGVBQWUsQ0FBQyxDQUFELENBRDlCO0FBQUEsTUFFSUcsV0FBVyxHQUFHSCxlQUFlLENBQUMsQ0FBRCxDQUZqQzs7QUFJQSxNQUFJSSxpQkFBaUIsR0FBR3pELEtBQUssQ0FBQzBELFdBQU4sQ0FBa0IsWUFBWTtBQUNwRHpCLElBQUFBLGlCQUFpQixDQUFDRCxPQUFELENBQWpCOztBQUVBLFFBQUljLFNBQUosRUFBZTtBQUNiQSxNQUFBQSxTQUFTO0FBQ1Y7QUFDRixHQU51QixFQU1yQixDQUFDZCxPQUFELEVBQVVjLFNBQVYsQ0FOcUIsQ0FBeEI7QUFPQSxNQUFJYSxjQUFjLEdBQUczRCxLQUFLLENBQUMwRCxXQUFOLENBQWtCLFlBQVk7QUFDakRyQixJQUFBQSxjQUFjLENBQUNMLE9BQUQsRUFBVXdCLFdBQVYsQ0FBZDs7QUFFQSxRQUFJUixNQUFKLEVBQVk7QUFDVkEsTUFBQUEsTUFBTTtBQUNQO0FBQ0YsR0FOb0IsRUFNbEIsQ0FBQ2hCLE9BQUQsRUFBVWdCLE1BQVYsQ0FOa0IsQ0FBckI7QUFPQWhELEVBQUFBLEtBQUssQ0FBQzRELFNBQU4sQ0FBZ0IsWUFBWTtBQUMxQixXQUFPLFlBQVk7QUFDakIsYUFBTzNCLGlCQUFpQixDQUFDRCxPQUFELENBQXhCO0FBQ0QsS0FGRDtBQUdELEdBSkQsRUFJRyxDQUFDQSxPQUFELENBSkg7QUFLQSxTQUFvQmhDLEtBQUssQ0FBQzZELGFBQU4sQ0FBb0IxRCxZQUFZLENBQUNKLE9BQWpDLEVBQTBDLElBQTFDLEVBQTZEQyxLQUFLLENBQUM2RCxhQUFOLENBQW9CeEQsZUFBZSxDQUFDTixPQUFwQyxFQUE2QztBQUM1SDZDLElBQUFBLGFBQWEsRUFBRUEsYUFENkc7QUFFNUhFLElBQUFBLFNBQVMsRUFBRVcsaUJBRmlIO0FBRzVIVCxJQUFBQSxNQUFNLEVBQUVXLGNBSG9IO0FBSTVIUixJQUFBQSxPQUFPLEVBQUVBO0FBSm1ILEdBQTdDLEVBS2pFbkQsS0FBSyxDQUFDNkQsYUFBTixDQUFvQnRELGVBQWUsQ0FBQ1IsT0FBcEMsRUFBNkM7QUFDM0QrRCxJQUFBQSxNQUFNLEVBQUVQO0FBRG1ELEdBQTdDLEVBRUF2RCxLQUFLLENBQUM2RCxhQUFOLENBQW9CdkQsYUFBYSxDQUFDUCxPQUFsQyxFQUEyQztBQUN6RCtELElBQUFBLE1BQU0sRUFBRVAsUUFEaUQ7QUFFekRSLElBQUFBLGNBQWMsRUFBRUEsY0FGeUM7QUFHekRnQixJQUFBQSxHQUFHLEVBQUVwQixZQUhvRDtBQUl6RE0sSUFBQUEsV0FBVyxFQUFFQTtBQUo0QyxHQUEzQyxFQUtiSixRQUxhLENBRkEsQ0FMaUUsQ0FBN0QsQ0FBcEI7QUFhRCxDQW5Ed0IsQ0FBekI7QUFvREEsSUFBSW1CLFFBQVEsR0FBR3hCLEtBQWY7QUFDQTNDLE9BQU8sQ0FBQ0UsT0FBUixHQUFrQmlFLFFBQWxCO0FBQ0FDLE1BQU0sQ0FBQ3BFLE9BQVAsR0FBaUJBLE9BQU8sQ0FBQ0UsT0FBekIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuZXhwb3J0cy5fX2VzTW9kdWxlID0gdHJ1ZTtcbmV4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDtcblxudmFyIFJlYWN0ID0gX2ludGVyb3BSZXF1aXJlV2lsZGNhcmQocmVxdWlyZShcInJlYWN0XCIpKTtcblxudmFyIF9Nb2RhbFBvcnRhbCA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZShcIi4vTW9kYWxQb3J0YWxcIikpO1xuXG52YXIgX01vZGFsQW5pbWF0aW9uID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKFwiLi9Nb2RhbEFuaW1hdGlvblwiKSk7XG5cbnZhciBfTW9kYWxDb250ZW50ID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKFwiLi9Nb2RhbENvbnRlbnRcIikpO1xuXG52YXIgX01vZGFsRm9jdXNUcmFwID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKFwiLi9Nb2RhbEZvY3VzVHJhcFwiKSk7XG5cbmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7IHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7IGRlZmF1bHQ6IG9iaiB9OyB9XG5cbmZ1bmN0aW9uIF9nZXRSZXF1aXJlV2lsZGNhcmRDYWNoZSgpIHsgaWYgKHR5cGVvZiBXZWFrTWFwICE9PSBcImZ1bmN0aW9uXCIpIHJldHVybiBudWxsOyB2YXIgY2FjaGUgPSBuZXcgV2Vha01hcCgpOyBfZ2V0UmVxdWlyZVdpbGRjYXJkQ2FjaGUgPSBmdW5jdGlvbiBfZ2V0UmVxdWlyZVdpbGRjYXJkQ2FjaGUoKSB7IHJldHVybiBjYWNoZTsgfTsgcmV0dXJuIGNhY2hlOyB9XG5cbmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZVdpbGRjYXJkKG9iaikgeyBpZiAob2JqICYmIG9iai5fX2VzTW9kdWxlKSB7IHJldHVybiBvYmo7IH0gaWYgKG9iaiA9PT0gbnVsbCB8fCB0eXBlb2Ygb2JqICE9PSBcIm9iamVjdFwiICYmIHR5cGVvZiBvYmogIT09IFwiZnVuY3Rpb25cIikgeyByZXR1cm4geyBkZWZhdWx0OiBvYmogfTsgfSB2YXIgY2FjaGUgPSBfZ2V0UmVxdWlyZVdpbGRjYXJkQ2FjaGUoKTsgaWYgKGNhY2hlICYmIGNhY2hlLmhhcyhvYmopKSB7IHJldHVybiBjYWNoZS5nZXQob2JqKTsgfSB2YXIgbmV3T2JqID0ge307IHZhciBoYXNQcm9wZXJ0eURlc2NyaXB0b3IgPSBPYmplY3QuZGVmaW5lUHJvcGVydHkgJiYgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcjsgZm9yICh2YXIga2V5IGluIG9iaikgeyBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwga2V5KSkgeyB2YXIgZGVzYyA9IGhhc1Byb3BlcnR5RGVzY3JpcHRvciA/IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob2JqLCBrZXkpIDogbnVsbDsgaWYgKGRlc2MgJiYgKGRlc2MuZ2V0IHx8IGRlc2Muc2V0KSkgeyBPYmplY3QuZGVmaW5lUHJvcGVydHkobmV3T2JqLCBrZXksIGRlc2MpOyB9IGVsc2UgeyBuZXdPYmpba2V5XSA9IG9ialtrZXldOyB9IH0gfSBuZXdPYmouZGVmYXVsdCA9IG9iajsgaWYgKGNhY2hlKSB7IGNhY2hlLnNldChvYmosIG5ld09iaik7IH0gcmV0dXJuIG5ld09iajsgfVxuXG4vKipcbiAqIENvcHlyaWdodCAoYykgTmljb2xhcyBHYWxsYWdoZXIuXG4gKiBDb3B5cmlnaHQgKGMpIEZhY2Vib29rLCBJbmMuIGFuZCBpdHMgYWZmaWxpYXRlcy5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGVcbiAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS5cbiAqXG4gKiBcbiAqL1xudmFyIHVuaXF1ZU1vZGFsSWRlbnRpZmllciA9IDA7XG52YXIgYWN0aXZlTW9kYWxTdGFjayA9IFtdO1xudmFyIGFjdGl2ZU1vZGFsTGlzdGVuZXJzID0ge307XG5cbmZ1bmN0aW9uIG5vdGlmeUFjdGl2ZU1vZGFsTGlzdGVuZXJzKCkge1xuICBpZiAoYWN0aXZlTW9kYWxTdGFjay5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm47XG4gIH1cblxuICB2YXIgYWN0aXZlTW9kYWxJZCA9IGFjdGl2ZU1vZGFsU3RhY2tbYWN0aXZlTW9kYWxTdGFjay5sZW5ndGggLSAxXTtcbiAgYWN0aXZlTW9kYWxTdGFjay5mb3JFYWNoKGZ1bmN0aW9uIChtb2RhbElkKSB7XG4gICAgaWYgKG1vZGFsSWQgaW4gYWN0aXZlTW9kYWxMaXN0ZW5lcnMpIHtcbiAgICAgIGFjdGl2ZU1vZGFsTGlzdGVuZXJzW21vZGFsSWRdKG1vZGFsSWQgPT09IGFjdGl2ZU1vZGFsSWQpO1xuICAgIH1cbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHJlbW92ZUFjdGl2ZU1vZGFsKG1vZGFsSWQpIHtcbiAgaWYgKG1vZGFsSWQgaW4gYWN0aXZlTW9kYWxMaXN0ZW5lcnMpIHtcbiAgICAvLyBCZWZvcmUgcmVtb3ZpbmcgdGhpcyBsaXN0ZW5lciB3ZSBzaG91bGQgcHJvYmFibHkgdGVsbCBpdFxuICAgIC8vIHRoYXQgaXQncyBubyBsb25nZXIgdGhlIGFjdGl2ZSBtb2RhbCBmb3Igc3VyZS5cbiAgICBhY3RpdmVNb2RhbExpc3RlbmVyc1ttb2RhbElkXShmYWxzZSk7XG4gICAgZGVsZXRlIGFjdGl2ZU1vZGFsTGlzdGVuZXJzW21vZGFsSWRdO1xuICB9XG5cbiAgdmFyIGluZGV4ID0gYWN0aXZlTW9kYWxTdGFjay5pbmRleE9mKG1vZGFsSWQpO1xuXG4gIGlmIChpbmRleCAhPT0gLTEpIHtcbiAgICBhY3RpdmVNb2RhbFN0YWNrLnNwbGljZShpbmRleCwgMSk7XG4gICAgbm90aWZ5QWN0aXZlTW9kYWxMaXN0ZW5lcnMoKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBhZGRBY3RpdmVNb2RhbChtb2RhbElkLCBsaXN0ZW5lcikge1xuICByZW1vdmVBY3RpdmVNb2RhbChtb2RhbElkKTtcbiAgYWN0aXZlTW9kYWxTdGFjay5wdXNoKG1vZGFsSWQpO1xuICBhY3RpdmVNb2RhbExpc3RlbmVyc1ttb2RhbElkXSA9IGxpc3RlbmVyO1xuICBub3RpZnlBY3RpdmVNb2RhbExpc3RlbmVycygpO1xufVxuXG52YXIgTW9kYWwgPSAvKiNfX1BVUkVfXyovUmVhY3QuZm9yd2FyZFJlZihmdW5jdGlvbiAocHJvcHMsIGZvcndhcmRlZFJlZikge1xuICB2YXIgYW5pbWF0aW9uVHlwZSA9IHByb3BzLmFuaW1hdGlvblR5cGUsXG4gICAgICBjaGlsZHJlbiA9IHByb3BzLmNoaWxkcmVuLFxuICAgICAgb25EaXNtaXNzID0gcHJvcHMub25EaXNtaXNzLFxuICAgICAgb25SZXF1ZXN0Q2xvc2UgPSBwcm9wcy5vblJlcXVlc3RDbG9zZSxcbiAgICAgIG9uU2hvdyA9IHByb3BzLm9uU2hvdyxcbiAgICAgIHRyYW5zcGFyZW50ID0gcHJvcHMudHJhbnNwYXJlbnQsXG4gICAgICBfcHJvcHMkdmlzaWJsZSA9IHByb3BzLnZpc2libGUsXG4gICAgICB2aXNpYmxlID0gX3Byb3BzJHZpc2libGUgPT09IHZvaWQgMCA/IHRydWUgOiBfcHJvcHMkdmlzaWJsZTsgLy8gU2V0IGEgdW5pcXVlIG1vZGVsIGlkZW50aWZpZXIgc28gd2UgY2FuIGNvcnJlY3RseSByb3V0ZVxuICAvLyBkaXNtaXNzYWxzIGFuZCBjaGVjayB0aGUgbGF5ZXJpbmcgb2YgbW9kYWxzLlxuXG4gIHZhciBtb2RhbElkID0gUmVhY3QudXNlTWVtbyhmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIHVuaXF1ZU1vZGFsSWRlbnRpZmllcisrO1xuICB9LCBbXSk7XG5cbiAgdmFyIF9SZWFjdCR1c2VTdGF0ZSA9IFJlYWN0LnVzZVN0YXRlKGZhbHNlKSxcbiAgICAgIGlzQWN0aXZlID0gX1JlYWN0JHVzZVN0YXRlWzBdLFxuICAgICAgc2V0SXNBY3RpdmUgPSBfUmVhY3QkdXNlU3RhdGVbMV07XG5cbiAgdmFyIG9uRGlzbWlzc0NhbGxiYWNrID0gUmVhY3QudXNlQ2FsbGJhY2soZnVuY3Rpb24gKCkge1xuICAgIHJlbW92ZUFjdGl2ZU1vZGFsKG1vZGFsSWQpO1xuXG4gICAgaWYgKG9uRGlzbWlzcykge1xuICAgICAgb25EaXNtaXNzKCk7XG4gICAgfVxuICB9LCBbbW9kYWxJZCwgb25EaXNtaXNzXSk7XG4gIHZhciBvblNob3dDYWxsYmFjayA9IFJlYWN0LnVzZUNhbGxiYWNrKGZ1bmN0aW9uICgpIHtcbiAgICBhZGRBY3RpdmVNb2RhbChtb2RhbElkLCBzZXRJc0FjdGl2ZSk7XG5cbiAgICBpZiAob25TaG93KSB7XG4gICAgICBvblNob3coKTtcbiAgICB9XG4gIH0sIFttb2RhbElkLCBvblNob3ddKTtcbiAgUmVhY3QudXNlRWZmZWN0KGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gZnVuY3Rpb24gKCkge1xuICAgICAgcmV0dXJuIHJlbW92ZUFjdGl2ZU1vZGFsKG1vZGFsSWQpO1xuICAgIH07XG4gIH0sIFttb2RhbElkXSk7XG4gIHJldHVybiAvKiNfX1BVUkVfXyovUmVhY3QuY3JlYXRlRWxlbWVudChfTW9kYWxQb3J0YWwuZGVmYXVsdCwgbnVsbCwgLyojX19QVVJFX18qL1JlYWN0LmNyZWF0ZUVsZW1lbnQoX01vZGFsQW5pbWF0aW9uLmRlZmF1bHQsIHtcbiAgICBhbmltYXRpb25UeXBlOiBhbmltYXRpb25UeXBlLFxuICAgIG9uRGlzbWlzczogb25EaXNtaXNzQ2FsbGJhY2ssXG4gICAgb25TaG93OiBvblNob3dDYWxsYmFjayxcbiAgICB2aXNpYmxlOiB2aXNpYmxlXG4gIH0sIC8qI19fUFVSRV9fKi9SZWFjdC5jcmVhdGVFbGVtZW50KF9Nb2RhbEZvY3VzVHJhcC5kZWZhdWx0LCB7XG4gICAgYWN0aXZlOiBpc0FjdGl2ZVxuICB9LCAvKiNfX1BVUkVfXyovUmVhY3QuY3JlYXRlRWxlbWVudChfTW9kYWxDb250ZW50LmRlZmF1bHQsIHtcbiAgICBhY3RpdmU6IGlzQWN0aXZlLFxuICAgIG9uUmVxdWVzdENsb3NlOiBvblJlcXVlc3RDbG9zZSxcbiAgICByZWY6IGZvcndhcmRlZFJlZixcbiAgICB0cmFuc3BhcmVudDogdHJhbnNwYXJlbnRcbiAgfSwgY2hpbGRyZW4pKSkpO1xufSk7XG52YXIgX2RlZmF1bHQgPSBNb2RhbDtcbmV4cG9ydHMuZGVmYXVsdCA9IF9kZWZhdWx0O1xubW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzLmRlZmF1bHQ7Il19