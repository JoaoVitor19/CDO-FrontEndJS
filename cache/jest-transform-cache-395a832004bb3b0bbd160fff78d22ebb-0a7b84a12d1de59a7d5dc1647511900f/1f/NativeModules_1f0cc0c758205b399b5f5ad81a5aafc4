d186af5fa75d4ca43a0aae43e5de05eb
'use strict';

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var BatchedBridge = require("./BatchedBridge");

var invariant = require('invariant');

function genModule(config, moduleID) {
  if (!config) {
    return null;
  }

  var _config = (0, _slicedToArray2.default)(config, 5),
      moduleName = _config[0],
      constants = _config[1],
      methods = _config[2],
      promiseMethods = _config[3],
      syncMethods = _config[4];

  invariant(!moduleName.startsWith('RCT') && !moduleName.startsWith('RK'), "Module name prefixes should've been stripped by the native side " + "but wasn't for " + moduleName);

  if (!constants && !methods) {
    return {
      name: moduleName
    };
  }

  var module = {};
  methods && methods.forEach(function (methodName, methodID) {
    var isPromise = promiseMethods && arrayContains(promiseMethods, methodID) || false;
    var isSync = syncMethods && arrayContains(syncMethods, methodID) || false;
    invariant(!isPromise || !isSync, 'Cannot have a method that is both async and a sync hook');
    var methodType = isPromise ? 'promise' : isSync ? 'sync' : 'async';
    module[methodName] = genMethod(moduleID, methodID, methodType);
  });
  (0, _extends2.default)(module, constants);

  if (module.getConstants == null) {
    module.getConstants = function () {
      return constants || Object.freeze({});
    };
  } else {
    console.warn("Unable to define method 'getConstants()' on NativeModule '" + moduleName + "'. NativeModule '" + moduleName + "' already has a constant or method called 'getConstants'. Please remove it.");
  }

  if (__DEV__) {
    BatchedBridge.createDebugLookup(moduleID, moduleName, methods);
  }

  return {
    name: moduleName,
    module: module
  };
}

global.__fbGenNativeModule = genModule;

function loadModule(name, moduleID) {
  invariant(global.nativeRequireModuleConfig, "Can't lazily create module without nativeRequireModuleConfig");
  var config = global.nativeRequireModuleConfig(name);
  var info = genModule(config, moduleID);
  return info && info.module;
}

function genMethod(moduleID, methodID, type) {
  var fn = null;

  if (type === 'promise') {
    fn = function promiseMethodWrapper() {
      for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
        args[_key] = arguments[_key];
      }

      var enqueueingFrameError = new Error();
      return new Promise(function (resolve, reject) {
        BatchedBridge.enqueueNativeCall(moduleID, methodID, args, function (data) {
          return resolve(data);
        }, function (errorData) {
          return reject(updateErrorWithErrorData(errorData, enqueueingFrameError));
        });
      });
    };
  } else {
    fn = function nonPromiseMethodWrapper() {
      for (var _len2 = arguments.length, args = new Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {
        args[_key2] = arguments[_key2];
      }

      var lastArg = args.length > 0 ? args[args.length - 1] : null;
      var secondLastArg = args.length > 1 ? args[args.length - 2] : null;
      var hasSuccessCallback = typeof lastArg === 'function';
      var hasErrorCallback = typeof secondLastArg === 'function';
      hasErrorCallback && invariant(hasSuccessCallback, 'Cannot have a non-function arg after a function arg.');
      var onSuccess = hasSuccessCallback ? lastArg : null;
      var onFail = hasErrorCallback ? secondLastArg : null;
      var callbackCount = hasSuccessCallback + hasErrorCallback;
      var newArgs = args.slice(0, args.length - callbackCount);

      if (type === 'sync') {
        return BatchedBridge.callNativeSyncHook(moduleID, methodID, newArgs, onFail, onSuccess);
      } else {
        BatchedBridge.enqueueNativeCall(moduleID, methodID, newArgs, onFail, onSuccess);
      }
    };
  }

  fn.type = type;
  return fn;
}

function arrayContains(array, value) {
  return array.indexOf(value) !== -1;
}

function updateErrorWithErrorData(errorData, error) {
  return (0, _extends2.default)(error, errorData || {});
}

var NativeModules = {};

if (global.nativeModuleProxy) {
  NativeModules = global.nativeModuleProxy;
} else if (!global.nativeExtensions) {
  var bridgeConfig = global.__fbBatchedBridgeConfig;
  invariant(bridgeConfig, '__fbBatchedBridgeConfig is not set, cannot invoke native modules');

  var defineLazyObjectProperty = require("../Utilities/defineLazyObjectProperty");

  (bridgeConfig.remoteModuleConfig || []).forEach(function (config, moduleID) {
    var info = genModule(config, moduleID);

    if (!info) {
      return;
    }

    if (info.module) {
      NativeModules[info.name] = info.module;
    } else {
      defineLazyObjectProperty(NativeModules, info.name, {
        get: function get() {
          return loadModule(info.name, moduleID);
        }
      });
    }
  });
}

module.exports = NativeModules;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIk5hdGl2ZU1vZHVsZXMuanMiXSwibmFtZXMiOlsiQmF0Y2hlZEJyaWRnZSIsInJlcXVpcmUiLCJpbnZhcmlhbnQiLCJnZW5Nb2R1bGUiLCJjb25maWciLCJtb2R1bGVJRCIsIm1vZHVsZU5hbWUiLCJjb25zdGFudHMiLCJtZXRob2RzIiwicHJvbWlzZU1ldGhvZHMiLCJzeW5jTWV0aG9kcyIsInN0YXJ0c1dpdGgiLCJuYW1lIiwibW9kdWxlIiwiZm9yRWFjaCIsIm1ldGhvZE5hbWUiLCJtZXRob2RJRCIsImlzUHJvbWlzZSIsImFycmF5Q29udGFpbnMiLCJpc1N5bmMiLCJtZXRob2RUeXBlIiwiZ2VuTWV0aG9kIiwiZ2V0Q29uc3RhbnRzIiwiT2JqZWN0IiwiZnJlZXplIiwiY29uc29sZSIsIndhcm4iLCJfX0RFVl9fIiwiY3JlYXRlRGVidWdMb29rdXAiLCJnbG9iYWwiLCJfX2ZiR2VuTmF0aXZlTW9kdWxlIiwibG9hZE1vZHVsZSIsIm5hdGl2ZVJlcXVpcmVNb2R1bGVDb25maWciLCJpbmZvIiwidHlwZSIsImZuIiwicHJvbWlzZU1ldGhvZFdyYXBwZXIiLCJhcmdzIiwiZW5xdWV1ZWluZ0ZyYW1lRXJyb3IiLCJFcnJvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZW5xdWV1ZU5hdGl2ZUNhbGwiLCJkYXRhIiwiZXJyb3JEYXRhIiwidXBkYXRlRXJyb3JXaXRoRXJyb3JEYXRhIiwibm9uUHJvbWlzZU1ldGhvZFdyYXBwZXIiLCJsYXN0QXJnIiwibGVuZ3RoIiwic2Vjb25kTGFzdEFyZyIsImhhc1N1Y2Nlc3NDYWxsYmFjayIsImhhc0Vycm9yQ2FsbGJhY2siLCJvblN1Y2Nlc3MiLCJvbkZhaWwiLCJjYWxsYmFja0NvdW50IiwibmV3QXJncyIsInNsaWNlIiwiY2FsbE5hdGl2ZVN5bmNIb29rIiwiYXJyYXkiLCJ2YWx1ZSIsImluZGV4T2YiLCJlcnJvciIsIk5hdGl2ZU1vZHVsZXMiLCJuYXRpdmVNb2R1bGVQcm94eSIsIm5hdGl2ZUV4dGVuc2lvbnMiLCJicmlkZ2VDb25maWciLCJfX2ZiQmF0Y2hlZEJyaWRnZUNvbmZpZyIsImRlZmluZUxhenlPYmplY3RQcm9wZXJ0eSIsInJlbW90ZU1vZHVsZUNvbmZpZyIsImdldCIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQVVBOzs7Ozs7OztBQUVBLElBQU1BLGFBQWEsR0FBR0MsT0FBTyxtQkFBN0I7O0FBRUEsSUFBTUMsU0FBUyxHQUFHRCxPQUFPLENBQUMsV0FBRCxDQUF6Qjs7QUFjQSxTQUFTRSxTQUFULENBQ0VDLE1BREYsRUFFRUMsUUFGRixFQU9FO0FBQ0EsTUFBSSxDQUFDRCxNQUFMLEVBQWE7QUFDWCxXQUFPLElBQVA7QUFDRDs7QUFFRCw2Q0FBc0VBLE1BQXRFO0FBQUEsTUFBT0UsVUFBUDtBQUFBLE1BQW1CQyxTQUFuQjtBQUFBLE1BQThCQyxPQUE5QjtBQUFBLE1BQXVDQyxjQUF2QztBQUFBLE1BQXVEQyxXQUF2RDs7QUFDQVIsRUFBQUEsU0FBUyxDQUNQLENBQUNJLFVBQVUsQ0FBQ0ssVUFBWCxDQUFzQixLQUF0QixDQUFELElBQWlDLENBQUNMLFVBQVUsQ0FBQ0ssVUFBWCxDQUFzQixJQUF0QixDQUQzQixFQUVQLHFFQUNFLGlCQURGLEdBRUVMLFVBSkssQ0FBVDs7QUFPQSxNQUFJLENBQUNDLFNBQUQsSUFBYyxDQUFDQyxPQUFuQixFQUE0QjtBQUUxQixXQUFPO0FBQUNJLE1BQUFBLElBQUksRUFBRU47QUFBUCxLQUFQO0FBQ0Q7O0FBRUQsTUFBTU8sTUFBTSxHQUFHLEVBQWY7QUFDQUwsRUFBQUEsT0FBTyxJQUNMQSxPQUFPLENBQUNNLE9BQVIsQ0FBZ0IsVUFBQ0MsVUFBRCxFQUFhQyxRQUFiLEVBQTBCO0FBQ3hDLFFBQU1DLFNBQVMsR0FDWlIsY0FBYyxJQUFJUyxhQUFhLENBQUNULGNBQUQsRUFBaUJPLFFBQWpCLENBQWhDLElBQStELEtBRGpFO0FBRUEsUUFBTUcsTUFBTSxHQUNUVCxXQUFXLElBQUlRLGFBQWEsQ0FBQ1IsV0FBRCxFQUFjTSxRQUFkLENBQTdCLElBQXlE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QWpCIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgKGMpIEZhY2Vib29rLCBJbmMuIGFuZCBpdHMgYWZmaWxpYXRlcy5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGVcbiAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS5cbiAqXG4gKiBAZm9ybWF0XG4gKiBAZmxvdyBzdHJpY3RcbiAqL1xuXG4ndXNlIHN0cmljdCc7XG5cbmNvbnN0IEJhdGNoZWRCcmlkZ2UgPSByZXF1aXJlKCcuL0JhdGNoZWRCcmlkZ2UnKTtcblxuY29uc3QgaW52YXJpYW50ID0gcmVxdWlyZSgnaW52YXJpYW50Jyk7XG5cbmltcG9ydCB0eXBlIHtFeHRlbmRlZEVycm9yfSBmcm9tICcuLi9Db3JlL0RldnRvb2xzL3BhcnNlRXJyb3JTdGFjayc7XG5cbmV4cG9ydCB0eXBlIE1vZHVsZUNvbmZpZyA9IFtcbiAgc3RyaW5nIC8qIG5hbWUgKi8sXG4gID97Li4ufSAvKiBjb25zdGFudHMgKi8sXG4gID8kUmVhZE9ubHlBcnJheTxzdHJpbmc+IC8qIGZ1bmN0aW9ucyAqLyxcbiAgPyRSZWFkT25seUFycmF5PG51bWJlcj4gLyogcHJvbWlzZSBtZXRob2QgSURzICovLFxuICA/JFJlYWRPbmx5QXJyYXk8bnVtYmVyPiAvKiBzeW5jIG1ldGhvZCBJRHMgKi8sXG5dO1xuXG5leHBvcnQgdHlwZSBNZXRob2RUeXBlID0gJ2FzeW5jJyB8ICdwcm9taXNlJyB8ICdzeW5jJztcblxuZnVuY3Rpb24gZ2VuTW9kdWxlKFxuICBjb25maWc6ID9Nb2R1bGVDb25maWcsXG4gIG1vZHVsZUlEOiBudW1iZXIsXG4pOiA/e1xuICBuYW1lOiBzdHJpbmcsXG4gIG1vZHVsZT86IHsuLi59LFxuICAuLi5cbn0ge1xuICBpZiAoIWNvbmZpZykge1xuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgY29uc3QgW21vZHVsZU5hbWUsIGNvbnN0YW50cywgbWV0aG9kcywgcHJvbWlzZU1ldGhvZHMsIHN5bmNNZXRob2RzXSA9IGNvbmZpZztcbiAgaW52YXJpYW50KFxuICAgICFtb2R1bGVOYW1lLnN0YXJ0c1dpdGgoJ1JDVCcpICYmICFtb2R1bGVOYW1lLnN0YXJ0c1dpdGgoJ1JLJyksXG4gICAgXCJNb2R1bGUgbmFtZSBwcmVmaXhlcyBzaG91bGQndmUgYmVlbiBzdHJpcHBlZCBieSB0aGUgbmF0aXZlIHNpZGUgXCIgK1xuICAgICAgXCJidXQgd2Fzbid0IGZvciBcIiArXG4gICAgICBtb2R1bGVOYW1lLFxuICApO1xuXG4gIGlmICghY29uc3RhbnRzICYmICFtZXRob2RzKSB7XG4gICAgLy8gTW9kdWxlIGNvbnRlbnRzIHdpbGwgYmUgZmlsbGVkIGluIGxhemlseSBsYXRlclxuICAgIHJldHVybiB7bmFtZTogbW9kdWxlTmFtZX07XG4gIH1cblxuICBjb25zdCBtb2R1bGUgPSB7fTtcbiAgbWV0aG9kcyAmJlxuICAgIG1ldGhvZHMuZm9yRWFjaCgobWV0aG9kTmFtZSwgbWV0aG9kSUQpID0+IHtcbiAgICAgIGNvbnN0IGlzUHJvbWlzZSA9XG4gICAgICAgIChwcm9taXNlTWV0aG9kcyAmJiBhcnJheUNvbnRhaW5zKHByb21pc2VNZXRob2RzLCBtZXRob2RJRCkpIHx8IGZhbHNlO1xuICAgICAgY29uc3QgaXNTeW5jID1cbiAgICAgICAgKHN5bmNNZXRob2RzICYmIGFycmF5Q29udGFpbnMoc3luY01ldGhvZHMsIG1ldGhvZElEKSkgfHwgZmFsc2U7XG4gICAgICBpbnZhcmlhbnQoXG4gICAgICAgICFpc1Byb21pc2UgfHwgIWlzU3luYyxcbiAgICAgICAgJ0Nhbm5vdCBoYXZlIGEgbWV0aG9kIHRoYXQgaXMgYm90aCBhc3luYyBhbmQgYSBzeW5jIGhvb2snLFxuICAgICAgKTtcbiAgICAgIGNvbnN0IG1ldGhvZFR5cGUgPSBpc1Byb21pc2UgPyAncHJvbWlzZScgOiBpc1N5bmMgPyAnc3luYycgOiAnYXN5bmMnO1xuICAgICAgbW9kdWxlW21ldGhvZE5hbWVdID0gZ2VuTWV0aG9kKG1vZHVsZUlELCBtZXRob2RJRCwgbWV0aG9kVHlwZSk7XG4gICAgfSk7XG5cbiAgT2JqZWN0LmFzc2lnbihtb2R1bGUsIGNvbnN0YW50cyk7XG5cbiAgaWYgKG1vZHVsZS5nZXRDb25zdGFudHMgPT0gbnVsbCkge1xuICAgIG1vZHVsZS5nZXRDb25zdGFudHMgPSAoKSA9PiBjb25zdGFudHMgfHwgT2JqZWN0LmZyZWV6ZSh7fSk7XG4gIH0gZWxzZSB7XG4gICAgY29uc29sZS53YXJuKFxuICAgICAgYFVuYWJsZSB0byBkZWZpbmUgbWV0aG9kICdnZXRDb25zdGFudHMoKScgb24gTmF0aXZlTW9kdWxlICcke21vZHVsZU5hbWV9Jy4gTmF0aXZlTW9kdWxlICcke21vZHVsZU5hbWV9JyBhbHJlYWR5IGhhcyBhIGNvbnN0YW50IG9yIG1ldGhvZCBjYWxsZWQgJ2dldENvbnN0YW50cycuIFBsZWFzZSByZW1vdmUgaXQuYCxcbiAgICApO1xuICB9XG5cbiAgaWYgKF9fREVWX18pIHtcbiAgICBCYXRjaGVkQnJpZGdlLmNyZWF0ZURlYnVnTG9va3VwKG1vZHVsZUlELCBtb2R1bGVOYW1lLCBtZXRob2RzKTtcbiAgfVxuXG4gIHJldHVybiB7bmFtZTogbW9kdWxlTmFtZSwgbW9kdWxlfTtcbn1cblxuLy8gZXhwb3J0IHRoaXMgbWV0aG9kIGFzIGEgZ2xvYmFsIHNvIHdlIGNhbiBjYWxsIGl0IGZyb20gbmF0aXZlXG5nbG9iYWwuX19mYkdlbk5hdGl2ZU1vZHVsZSA9IGdlbk1vZHVsZTtcblxuZnVuY3Rpb24gbG9hZE1vZHVsZShuYW1lOiBzdHJpbmcsIG1vZHVsZUlEOiBudW1iZXIpOiA/ey4uLn0ge1xuICBpbnZhcmlhbnQoXG4gICAgZ2xvYmFsLm5hdGl2ZVJlcXVpcmVNb2R1bGVDb25maWcsXG4gICAgXCJDYW4ndCBsYXppbHkgY3JlYXRlIG1vZHVsZSB3aXRob3V0IG5hdGl2ZVJlcXVpcmVNb2R1bGVDb25maWdcIixcbiAgKTtcbiAgY29uc3QgY29uZmlnID0gZ2xvYmFsLm5hdGl2ZVJlcXVpcmVNb2R1bGVDb25maWcobmFtZSk7XG4gIGNvbnN0IGluZm8gPSBnZW5Nb2R1bGUoY29uZmlnLCBtb2R1bGVJRCk7XG4gIHJldHVybiBpbmZvICYmIGluZm8ubW9kdWxlO1xufVxuXG5mdW5jdGlvbiBnZW5NZXRob2QobW9kdWxlSUQ6IG51bWJlciwgbWV0aG9kSUQ6IG51bWJlciwgdHlwZTogTWV0aG9kVHlwZSkge1xuICBsZXQgZm4gPSBudWxsO1xuICBpZiAodHlwZSA9PT0gJ3Byb21pc2UnKSB7XG4gICAgZm4gPSBmdW5jdGlvbiBwcm9taXNlTWV0aG9kV3JhcHBlciguLi5hcmdzOiBBcnJheTxtaXhlZD4pIHtcbiAgICAgIC8vIEluIGNhc2Ugd2UgcmVqZWN0LCBjYXB0dXJlIGEgdXNlZnVsIHN0YWNrIHRyYWNlIGhlcmUuXG4gICAgICBjb25zdCBlbnF1ZXVlaW5nRnJhbWVFcnJvcjogRXh0ZW5kZWRFcnJvciA9IG5ldyBFcnJvcigpO1xuICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgQmF0Y2hlZEJyaWRnZS5lbnF1ZXVlTmF0aXZlQ2FsbChcbiAgICAgICAgICBtb2R1bGVJRCxcbiAgICAgICAgICBtZXRob2RJRCxcbiAgICAgICAgICBhcmdzLFxuICAgICAgICAgIGRhdGEgPT4gcmVzb2x2ZShkYXRhKSxcbiAgICAgICAgICBlcnJvckRhdGEgPT5cbiAgICAgICAgICAgIHJlamVjdChcbiAgICAgICAgICAgICAgdXBkYXRlRXJyb3JXaXRoRXJyb3JEYXRhKFxuICAgICAgICAgICAgICAgIChlcnJvckRhdGE6ICRGbG93Rml4TWUpLFxuICAgICAgICAgICAgICAgIGVucXVldWVpbmdGcmFtZUVycm9yLFxuICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgKSxcbiAgICAgICAgKTtcbiAgICAgIH0pO1xuICAgIH07XG4gIH0gZWxzZSB7XG4gICAgZm4gPSBmdW5jdGlvbiBub25Qcm9taXNlTWV0aG9kV3JhcHBlciguLi5hcmdzOiBBcnJheTxtaXhlZD4pIHtcbiAgICAgIGNvbnN0IGxhc3RBcmcgPSBhcmdzLmxlbmd0aCA+IDAgPyBhcmdzW2FyZ3MubGVuZ3RoIC0gMV0gOiBudWxsO1xuICAgICAgY29uc3Qgc2Vjb25kTGFzdEFyZyA9IGFyZ3MubGVuZ3RoID4gMSA/IGFyZ3NbYXJncy5sZW5ndGggLSAyXSA6IG51bGw7XG4gICAgICBjb25zdCBoYXNTdWNjZXNzQ2FsbGJhY2sgPSB0eXBlb2YgbGFzdEFyZyA9PT0gJ2Z1bmN0aW9uJztcbiAgICAgIGNvbnN0IGhhc0Vycm9yQ2FsbGJhY2sgPSB0eXBlb2Ygc2Vjb25kTGFzdEFyZyA9PT0gJ2Z1bmN0aW9uJztcbiAgICAgIGhhc0Vycm9yQ2FsbGJhY2sgJiZcbiAgICAgICAgaW52YXJpYW50KFxuICAgICAgICAgIGhhc1N1Y2Nlc3NDYWxsYmFjayxcbiAgICAgICAgICAnQ2Fubm90IGhhdmUgYSBub24tZnVuY3Rpb24gYXJnIGFmdGVyIGEgZnVuY3Rpb24gYXJnLicsXG4gICAgICAgICk7XG4gICAgICAvLyAkRmxvd0ZpeE1lW2luY29tcGF0aWJsZS10eXBlXVxuICAgICAgY29uc3Qgb25TdWNjZXNzOiA/KG1peGVkKSA9PiB2b2lkID0gaGFzU3VjY2Vzc0NhbGxiYWNrID8gbGFzdEFyZyA6IG51bGw7XG4gICAgICAvLyAkRmxvd0ZpeE1lW2luY29tcGF0aWJsZS10eXBlXVxuICAgICAgY29uc3Qgb25GYWlsOiA/KG1peGVkKSA9PiB2b2lkID0gaGFzRXJyb3JDYWxsYmFjayA/IHNlY29uZExhc3RBcmcgOiBudWxsO1xuICAgICAgY29uc3QgY2FsbGJhY2tDb3VudCA9IGhhc1N1Y2Nlc3NDYWxsYmFjayArIGhhc0Vycm9yQ2FsbGJhY2s7XG4gICAgICBjb25zdCBuZXdBcmdzID0gYXJncy5zbGljZSgwLCBhcmdzLmxlbmd0aCAtIGNhbGxiYWNrQ291bnQpO1xuICAgICAgaWYgKHR5cGUgPT09ICdzeW5jJykge1xuICAgICAgICByZXR1cm4gQmF0Y2hlZEJyaWRnZS5jYWxsTmF0aXZlU3luY0hvb2soXG4gICAgICAgICAgbW9kdWxlSUQsXG4gICAgICAgICAgbWV0aG9kSUQsXG4gICAgICAgICAgbmV3QXJncyxcbiAgICAgICAgICBvbkZhaWwsXG4gICAgICAgICAgb25TdWNjZXNzLFxuICAgICAgICApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgQmF0Y2hlZEJyaWRnZS5lbnF1ZXVlTmF0aXZlQ2FsbChcbiAgICAgICAgICBtb2R1bGVJRCxcbiAgICAgICAgICBtZXRob2RJRCxcbiAgICAgICAgICBuZXdBcmdzLFxuICAgICAgICAgIG9uRmFpbCxcbiAgICAgICAgICBvblN1Y2Nlc3MsXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfTtcbiAgfVxuICBmbi50eXBlID0gdHlwZTtcbiAgcmV0dXJuIGZuO1xufVxuXG5mdW5jdGlvbiBhcnJheUNvbnRhaW5zPFQ+KGFycmF5OiAkUmVhZE9ubHlBcnJheTxUPiwgdmFsdWU6IFQpOiBib29sZWFuIHtcbiAgcmV0dXJuIGFycmF5LmluZGV4T2YodmFsdWUpICE9PSAtMTtcbn1cblxuZnVuY3Rpb24gdXBkYXRlRXJyb3JXaXRoRXJyb3JEYXRhKFxuICBlcnJvckRhdGE6IHttZXNzYWdlOiBzdHJpbmcsIC4uLn0sXG4gIGVycm9yOiBFeHRlbmRlZEVycm9yLFxuKTogRXh0ZW5kZWRFcnJvciB7XG4gIHJldHVybiBPYmplY3QuYXNzaWduKGVycm9yLCBlcnJvckRhdGEgfHwge30pO1xufVxuXG5sZXQgTmF0aXZlTW9kdWxlczoge1ttb2R1bGVOYW1lOiBzdHJpbmddOiAkRmxvd0ZpeE1lLCAuLi59ID0ge307XG5pZiAoZ2xvYmFsLm5hdGl2ZU1vZHVsZVByb3h5KSB7XG4gIE5hdGl2ZU1vZHVsZXMgPSBnbG9iYWwubmF0aXZlTW9kdWxlUHJveHk7XG59IGVsc2UgaWYgKCFnbG9iYWwubmF0aXZlRXh0ZW5zaW9ucykge1xuICBjb25zdCBicmlkZ2VDb25maWcgPSBnbG9iYWwuX19mYkJhdGNoZWRCcmlkZ2VDb25maWc7XG4gIGludmFyaWFudChcbiAgICBicmlkZ2VDb25maWcsXG4gICAgJ19fZmJCYXRjaGVkQnJpZGdlQ29uZmlnIGlzIG5vdCBzZXQsIGNhbm5vdCBpbnZva2UgbmF0aXZlIG1vZHVsZXMnLFxuICApO1xuXG4gIGNvbnN0IGRlZmluZUxhenlPYmplY3RQcm9wZXJ0eSA9IHJlcXVpcmUoJy4uL1V0aWxpdGllcy9kZWZpbmVMYXp5T2JqZWN0UHJvcGVydHknKTtcbiAgKGJyaWRnZUNvbmZpZy5yZW1vdGVNb2R1bGVDb25maWcgfHwgW10pLmZvckVhY2goXG4gICAgKGNvbmZpZzogTW9kdWxlQ29uZmlnLCBtb2R1bGVJRDogbnVtYmVyKSA9PiB7XG4gICAgICAvLyBJbml0aWFsbHkgdGhpcyBjb25maWcgd2lsbCBvbmx5IGNvbnRhaW4gdGhlIG1vZHVsZSBuYW1lIHdoZW4gcnVubmluZyBpbiBKU0MuIFRoZSBhY3R1YWxcbiAgICAgIC8vIGNvbmZpZ3VyYXRpb24gb2YgdGhlIG1vZHVsZSB3aWxsIGJlIGxhemlseSBsb2FkZWQuXG4gICAgICBjb25zdCBpbmZvID0gZ2VuTW9kdWxlKGNvbmZpZywgbW9kdWxlSUQpO1xuICAgICAgaWYgKCFpbmZvKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgaWYgKGluZm8ubW9kdWxlKSB7XG4gICAgICAgIE5hdGl2ZU1vZHVsZXNbaW5mby5uYW1lXSA9IGluZm8ubW9kdWxlO1xuICAgICAgfVxuICAgICAgLy8gSWYgdGhlcmUncyBubyBtb2R1bGUgY29uZmlnLCBkZWZpbmUgYSBsYXp5IGdldHRlclxuICAgICAgZWxzZSB7XG4gICAgICAgIGRlZmluZUxhenlPYmplY3RQcm9wZXJ0eShOYXRpdmVNb2R1bGVzLCBpbmZvLm5hbWUsIHtcbiAgICAgICAgICBnZXQ6ICgpID0+IGxvYWRNb2R1bGUoaW5mby5uYW1lLCBtb2R1bGVJRCksXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0sXG4gICk7XG59XG5cbm1vZHVsZS5leHBvcnRzID0gTmF0aXZlTW9kdWxlcztcbiJdfQ==