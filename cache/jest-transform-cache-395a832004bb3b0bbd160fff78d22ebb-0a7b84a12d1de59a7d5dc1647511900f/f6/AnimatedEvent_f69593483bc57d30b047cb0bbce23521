f9da61a932e53fb3ce2f9f25f6afce33
'use strict';

exports.__esModule = true;
exports.attachNativeEvent = attachNativeEvent;
exports.AnimatedEvent = void 0;

var _AnimatedValue = _interopRequireDefault(require("./nodes/AnimatedValue"));

var _NativeAnimatedHelper = _interopRequireWildcard(require("./NativeAnimatedHelper"));

var _findNodeHandle = _interopRequireDefault(require("../../../exports/findNodeHandle"));

var _invariant = _interopRequireDefault(require("fbjs/lib/invariant"));

function _getRequireWildcardCache() {
  if (typeof WeakMap !== "function") return null;
  var cache = new WeakMap();

  _getRequireWildcardCache = function _getRequireWildcardCache() {
    return cache;
  };

  return cache;
}

function _interopRequireWildcard(obj) {
  if (obj && obj.__esModule) {
    return obj;
  }

  if (obj === null || typeof obj !== "object" && typeof obj !== "function") {
    return {
      default: obj
    };
  }

  var cache = _getRequireWildcardCache();

  if (cache && cache.has(obj)) {
    return cache.get(obj);
  }

  var newObj = {};
  var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor;

  for (var key in obj) {
    if (Object.prototype.hasOwnProperty.call(obj, key)) {
      var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null;

      if (desc && (desc.get || desc.set)) {
        Object.defineProperty(newObj, key, desc);
      } else {
        newObj[key] = obj[key];
      }
    }
  }

  newObj.default = obj;

  if (cache) {
    cache.set(obj, newObj);
  }

  return newObj;
}

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {
    default: obj
  };
}

var __DEV__ = process.env.NODE_ENV !== 'production';

function attachNativeEvent(viewRef, eventName, argMapping) {
  var eventMappings = [];

  var traverse = function traverse(value, path) {
    if (value instanceof _AnimatedValue.default) {
      value.__makeNative();

      eventMappings.push({
        nativeEventPath: path,
        animatedValueTag: value.__getNativeTag()
      });
    } else if (typeof value === 'object') {
      for (var _key in value) {
        traverse(value[_key], path.concat(_key));
      }
    }
  };

  (0, _invariant.default)(argMapping[0] && argMapping[0].nativeEvent, 'Native driven events only support animated values contained inside `nativeEvent`.');
  traverse(argMapping[0].nativeEvent, []);
  var viewTag = (0, _findNodeHandle.default)(viewRef);

  if (viewTag != null) {
    eventMappings.forEach(function (mapping) {
      _NativeAnimatedHelper.default.API.addAnimatedEventToView(viewTag, eventName, mapping);
    });
  }

  return {
    detach: function detach() {
      if (viewTag != null) {
        eventMappings.forEach(function (mapping) {
          _NativeAnimatedHelper.default.API.removeAnimatedEventFromView(viewTag, eventName, mapping.animatedValueTag);
        });
      }
    }
  };
}

function validateMapping(argMapping, args) {
  var validate = function validate(recMapping, recEvt, key) {
    if (recMapping instanceof _AnimatedValue.default) {
      (0, _invariant.default)(typeof recEvt === 'number', 'Bad mapping of event key ' + key + ', should be number but got ' + typeof recEvt);
      return;
    }

    if (typeof recEvt === 'number') {
      (0, _invariant.default)(recMapping instanceof _AnimatedValue.default, 'Bad mapping of type ' + typeof recMapping + ' for key ' + key + ', event value must map to AnimatedValue');
      return;
    }

    (0, _invariant.default)(typeof recMapping === 'object', 'Bad mapping of type ' + typeof recMapping + ' for key ' + key);
    (0, _invariant.default)(typeof recEvt === 'object', 'Bad event of type ' + typeof recEvt + ' for key ' + key);

    for (var mappingKey in recMapping) {
      validate(recMapping[mappingKey], recEvt[mappingKey], mappingKey);
    }
  };

  (0, _invariant.default)(args.length >= argMapping.length, 'Event has less arguments than mapping');
  argMapping.forEach(function (mapping, idx) {
    validate(mapping, args[idx], 'arg' + idx);
  });
}

var AnimatedEvent = function () {
  function AnimatedEvent(argMapping, config) {
    this._listeners = [];
    this._argMapping = argMapping;

    if (config == null) {
      console.warn('Animated.event now requires a second argument for options');
      config = {
        useNativeDriver: false
      };
    }

    if (config.listener) {
      this.__addListener(config.listener);
    }

    this._callListeners = this._callListeners.bind(this);
    this._attachedEvent = null;
    this.__isNative = (0, _NativeAnimatedHelper.shouldUseNativeDriver)(config);
  }

  var _proto = AnimatedEvent.prototype;

  _proto.__addListener = function __addListener(callback) {
    this._listeners.push(callback);
  };

  _proto.__removeListener = function __removeListener(callback) {
    this._listeners = this._listeners.filter(function (listener) {
      return listener !== callback;
    });
  };

  _proto.__attach = function __attach(viewRef, eventName) {
    (0, _invariant.default)(this.__isNative, 'Only native driven events need to be attached.');
    this._attachedEvent = attachNativeEvent(viewRef, eventName, this._argMapping);
  };

  _proto.__detach = function __detach(viewTag, eventName) {
    (0, _invariant.default)(this.__isNative, 'Only native driven events need to be detached.');
    this._attachedEvent && this._attachedEvent.detach();
  };

  _proto.__getHandler = function __getHandler() {
    var _this = this;

    if (this.__isNative) {
      if (__DEV__) {
        var _validatedMapping = false;
        return function () {
          for (var _len = arguments.length, args = new Array(_len), _key2 = 0; _key2 < _len; _key2++) {
            args[_key2] = arguments[_key2];
          }

          if (!_validatedMapping) {
            validateMapping(_this._argMapping, args);
            _validatedMapping = true;
          }

          _this._callListeners.apply(_this, args);
        };
      } else {
        return this._callListeners;
      }
    }

    var validatedMapping = false;
    return function () {
      for (var _len2 = arguments.length, args = new Array(_len2), _key3 = 0; _key3 < _len2; _key3++) {
        args[_key3] = arguments[_key3];
      }

      if (__DEV__ && !validatedMapping) {
        validateMapping(_this._argMapping, args);
        validatedMapping = true;
      }

      var traverse = function traverse(recMapping, recEvt, key) {
        if (recMapping instanceof _AnimatedValue.default) {
          if (typeof recEvt === 'number') {
            recMapping.setValue(recEvt);
          }
        } else if (typeof recMapping === 'object') {
          for (var mappingKey in recMapping) {
            traverse(recMapping[mappingKey], recEvt[mappingKey], mappingKey);
          }
        }
      };

      _this._argMapping.forEach(function (mapping, idx) {
        traverse(mapping, args[idx], 'arg' + idx);
      });

      _this._callListeners.apply(_this, args);
    };
  };

  _proto._callListeners = function _callListeners() {
    for (var _len3 = arguments.length, args = new Array(_len3), _key4 = 0; _key4 < _len3; _key4++) {
      args[_key4] = arguments[_key4];
    }

    this._listeners.forEach(function (listener) {
      return listener.apply(void 0, args);
    });
  };

  return AnimatedEvent;
}();

exports.AnimatedEvent = AnimatedEvent;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkFuaW1hdGVkRXZlbnQuanMiXSwibmFtZXMiOlsiZXhwb3J0cyIsIl9fZXNNb2R1bGUiLCJhdHRhY2hOYXRpdmVFdmVudCIsIkFuaW1hdGVkRXZlbnQiLCJfQW5pbWF0ZWRWYWx1ZSIsIl9pbnRlcm9wUmVxdWlyZURlZmF1bHQiLCJyZXF1aXJlIiwiX05hdGl2ZUFuaW1hdGVkSGVscGVyIiwiX2ludGVyb3BSZXF1aXJlV2lsZGNhcmQiLCJfZmluZE5vZGVIYW5kbGUiLCJfaW52YXJpYW50IiwiX2dldFJlcXVpcmVXaWxkY2FyZENhY2hlIiwiV2Vha01hcCIsImNhY2hlIiwib2JqIiwiZGVmYXVsdCIsImhhcyIsImdldCIsIm5ld09iaiIsImhhc1Byb3BlcnR5RGVzY3JpcHRvciIsIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwia2V5IiwicHJvdG90eXBlIiwiaGFzT3duUHJvcGVydHkiLCJjYWxsIiwiZGVzYyIsInNldCIsIl9fREVWX18iLCJwcm9jZXNzIiwiZW52IiwiTk9ERV9FTlYiLCJ2aWV3UmVmIiwiZXZlbnROYW1lIiwiYXJnTWFwcGluZyIsImV2ZW50TWFwcGluZ3MiLCJ0cmF2ZXJzZSIsInZhbHVlIiwicGF0aCIsIl9fbWFrZU5hdGl2ZSIsInB1c2giLCJuYXRpdmVFdmVudFBhdGgiLCJhbmltYXRlZFZhbHVlVGFnIiwiX19nZXROYXRpdmVUYWciLCJfa2V5IiwiY29uY2F0IiwibmF0aXZlRXZlbnQiLCJ2aWV3VGFnIiwiZm9yRWFjaCIsIm1hcHBpbmciLCJBUEkiLCJhZGRBbmltYXRlZEV2ZW50VG9WaWV3IiwiZGV0YWNoIiwicmVtb3ZlQW5pbWF0ZWRFdmVudEZyb21WaWV3IiwidmFsaWRhdGVNYXBwaW5nIiwiYXJncyIsInZhbGlkYXRlIiwicmVjTWFwcGluZyIsInJlY0V2dCIsIm1hcHBpbmdLZXkiLCJsZW5ndGgiLCJpZHgiLCJjb25maWciLCJfbGlzdGVuZXJzIiwiX2FyZ01hcHBpbmciLCJjb25zb2xlIiwid2FybiIsInVzZU5hdGl2ZURyaXZlciIsImxpc3RlbmVyIiwiX19hZGRMaXN0ZW5lciIsIl9jYWxsTGlzdGVuZXJzIiwiYmluZCIsIl9hdHRhY2hlZEV2ZW50IiwiX19pc05hdGl2ZSIsInNob3VsZFVzZU5hdGl2ZURyaXZlciIsIl9wcm90byIsImNhbGxiYWNrIiwiX19yZW1vdmVMaXN0ZW5lciIsImZpbHRlciIsIl9fYXR0YWNoIiwiX19kZXRhY2giLCJfX2dldEhhbmRsZXIiLCJfdGhpcyIsIl92YWxpZGF0ZWRNYXBwaW5nIiwiX2xlbiIsImFyZ3VtZW50cyIsIkFycmF5IiwiX2tleTIiLCJhcHBseSIsInZhbGlkYXRlZE1hcHBpbmciLCJfbGVuMiIsIl9rZXkzIiwic2V0VmFsdWUiLCJfbGVuMyIsIl9rZXk0Il0sIm1hcHBpbmdzIjoiQUFTQTs7QUFFQUEsT0FBTyxDQUFDQyxVQUFSLEdBQXFCLElBQXJCO0FBQ0FELE9BQU8sQ0FBQ0UsaUJBQVIsR0FBNEJBLGlCQUE1QjtBQUNBRixPQUFPLENBQUNHLGFBQVIsR0FBd0IsS0FBSyxDQUE3Qjs7QUFFQSxJQUFJQyxjQUFjLEdBQUdDLHNCQUFzQixDQUFDQyxPQUFPLHlCQUFSLENBQTNDOztBQUVBLElBQUlDLHFCQUFxQixHQUFHQyx1QkFBdUIsQ0FBQ0YsT0FBTywwQkFBUixDQUFuRDs7QUFFQSxJQUFJRyxlQUFlLEdBQUdKLHNCQUFzQixDQUFDQyxPQUFPLG1DQUFSLENBQTVDOztBQUVBLElBQUlJLFVBQVUsR0FBR0wsc0JBQXNCLENBQUNDLE9BQU8sQ0FBQyxvQkFBRCxDQUFSLENBQXZDOztBQUVBLFNBQVNLLHdCQUFULEdBQW9DO0FBQUUsTUFBSSxPQUFPQyxPQUFQLEtBQW1CLFVBQXZCLEVBQW1DLE9BQU8sSUFBUDtBQUFhLE1BQUlDLEtBQUssR0FBRyxJQUFJRCxPQUFKLEVBQVo7O0FBQTJCRCxFQUFBQSx3QkFBd0IsR0FBRyxTQUFTQSx3QkFBVCxHQUFvQztBQUFFLFdBQU9FLEtBQVA7QUFBZSxHQUFoRjs7QUFBa0Ys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Q0FBUDtBQUNELEtBRkQ7QUFHRCxHQVJEOztBQVVBLFNBQU9yRCxhQUFQO0FBQ0QsQ0EvR2dDLEVBQWpDOztBQWlIQUgsT0FBTyxDQUFDRyxhQUFSLEdBQXdCQSxhQUF4QiIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IChjKSBGYWNlYm9vaywgSW5jLiBhbmQgaXRzIGFmZmlsaWF0ZXMuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKlxuICogXG4gKiBAZm9ybWF0XG4gKi9cbid1c2Ugc3RyaWN0JztcblxuZXhwb3J0cy5fX2VzTW9kdWxlID0gdHJ1ZTtcbmV4cG9ydHMuYXR0YWNoTmF0aXZlRXZlbnQgPSBhdHRhY2hOYXRpdmVFdmVudDtcbmV4cG9ydHMuQW5pbWF0ZWRFdmVudCA9IHZvaWQgMDtcblxudmFyIF9BbmltYXRlZFZhbHVlID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKFwiLi9ub2Rlcy9BbmltYXRlZFZhbHVlXCIpKTtcblxudmFyIF9OYXRpdmVBbmltYXRlZEhlbHBlciA9IF9pbnRlcm9wUmVxdWlyZVdpbGRjYXJkKHJlcXVpcmUoXCIuL05hdGl2ZUFuaW1hdGVkSGVscGVyXCIpKTtcblxudmFyIF9maW5kTm9kZUhhbmRsZSA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZShcIi4uLy4uLy4uL2V4cG9ydHMvZmluZE5vZGVIYW5kbGVcIikpO1xuXG52YXIgX2ludmFyaWFudCA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZShcImZianMvbGliL2ludmFyaWFudFwiKSk7XG5cbmZ1bmN0aW9uIF9nZXRSZXF1aXJlV2lsZGNhcmRDYWNoZSgpIHsgaWYgKHR5cGVvZiBXZWFrTWFwICE9PSBcImZ1bmN0aW9uXCIpIHJldHVybiBudWxsOyB2YXIgY2FjaGUgPSBuZXcgV2Vha01hcCgpOyBfZ2V0UmVxdWlyZVdpbGRjYXJkQ2FjaGUgPSBmdW5jdGlvbiBfZ2V0UmVxdWlyZVdpbGRjYXJkQ2FjaGUoKSB7IHJldHVybiBjYWNoZTsgfTsgcmV0dXJuIGNhY2hlOyB9XG5cbmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZVdpbGRjYXJkKG9iaikgeyBpZiAob2JqICYmIG9iai5fX2VzTW9kdWxlKSB7IHJldHVybiBvYmo7IH0gaWYgKG9iaiA9PT0gbnVsbCB8fCB0eXBlb2Ygb2JqICE9PSBcIm9iamVjdFwiICYmIHR5cGVvZiBvYmogIT09IFwiZnVuY3Rpb25cIikgeyByZXR1cm4geyBkZWZhdWx0OiBvYmogfTsgfSB2YXIgY2FjaGUgPSBfZ2V0UmVxdWlyZVdpbGRjYXJkQ2FjaGUoKTsgaWYgKGNhY2hlICYmIGNhY2hlLmhhcyhvYmopKSB7IHJldHVybiBjYWNoZS5nZXQob2JqKTsgfSB2YXIgbmV3T2JqID0ge307IHZhciBoYXNQcm9wZXJ0eURlc2NyaXB0b3IgPSBPYmplY3QuZGVmaW5lUHJvcGVydHkgJiYgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcjsgZm9yICh2YXIga2V5IGluIG9iaikgeyBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwga2V5KSkgeyB2YXIgZGVzYyA9IGhhc1Byb3BlcnR5RGVzY3JpcHRvciA/IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob2JqLCBrZXkpIDogbnVsbDsgaWYgKGRlc2MgJiYgKGRlc2MuZ2V0IHx8IGRlc2Muc2V0KSkgeyBPYmplY3QuZGVmaW5lUHJvcGVydHkobmV3T2JqLCBrZXksIGRlc2MpOyB9IGVsc2UgeyBuZXdPYmpba2V5XSA9IG9ialtrZXldOyB9IH0gfSBuZXdPYmouZGVmYXVsdCA9IG9iajsgaWYgKGNhY2hlKSB7IGNhY2hlLnNldChvYmosIG5ld09iaik7IH0gcmV0dXJuIG5ld09iajsgfVxuXG5mdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyBkZWZhdWx0OiBvYmogfTsgfVxuXG52YXIgX19ERVZfXyA9IHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbic7XG5cbmZ1bmN0aW9uIGF0dGFjaE5hdGl2ZUV2ZW50KHZpZXdSZWYsIGV2ZW50TmFtZSwgYXJnTWFwcGluZykge1xuICAvLyBGaW5kIGFuaW1hdGVkIHZhbHVlcyBpbiBgYXJnTWFwcGluZ2AgYW5kIGNyZWF0ZSBhbiBhcnJheSByZXByZXNlbnRpbmcgdGhlaXJcbiAgLy8ga2V5IHBhdGggaW5zaWRlIHRoZSBgbmF0aXZlRXZlbnRgIG9iamVjdC4gRXguOiBbJ2NvbnRlbnRPZmZzZXQnLCAneCddLlxuICB2YXIgZXZlbnRNYXBwaW5ncyA9IFtdO1xuXG4gIHZhciB0cmF2ZXJzZSA9IGZ1bmN0aW9uIHRyYXZlcnNlKHZhbHVlLCBwYXRoKSB7XG4gICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgX0FuaW1hdGVkVmFsdWUuZGVmYXVsdCkge1xuICAgICAgdmFsdWUuX19tYWtlTmF0aXZlKCk7XG5cbiAgICAgIGV2ZW50TWFwcGluZ3MucHVzaCh7XG4gICAgICAgIG5hdGl2ZUV2ZW50UGF0aDogcGF0aCxcbiAgICAgICAgYW5pbWF0ZWRWYWx1ZVRhZzogdmFsdWUuX19nZXROYXRpdmVUYWcoKVxuICAgICAgfSk7XG4gICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnKSB7XG4gICAgICBmb3IgKHZhciBfa2V5IGluIHZhbHVlKSB7XG4gICAgICAgIHRyYXZlcnNlKHZhbHVlW19rZXldLCBwYXRoLmNvbmNhdChfa2V5KSk7XG4gICAgICB9XG4gICAgfVxuICB9O1xuXG4gICgwLCBfaW52YXJpYW50LmRlZmF1bHQpKGFyZ01hcHBpbmdbMF0gJiYgYXJnTWFwcGluZ1swXS5uYXRpdmVFdmVudCwgJ05hdGl2ZSBkcml2ZW4gZXZlbnRzIG9ubHkgc3VwcG9ydCBhbmltYXRlZCB2YWx1ZXMgY29udGFpbmVkIGluc2lkZSBgbmF0aXZlRXZlbnRgLicpOyAvLyBBc3N1bWUgdGhhdCB0aGUgZXZlbnQgY29udGFpbmluZyBgbmF0aXZlRXZlbnRgIGlzIGFsd2F5cyB0aGUgZmlyc3QgYXJndW1lbnQuXG5cbiAgdHJhdmVyc2UoYXJnTWFwcGluZ1swXS5uYXRpdmVFdmVudCwgW10pO1xuICB2YXIgdmlld1RhZyA9ICgwLCBfZmluZE5vZGVIYW5kbGUuZGVmYXVsdCkodmlld1JlZik7XG5cbiAgaWYgKHZpZXdUYWcgIT0gbnVsbCkge1xuICAgIGV2ZW50TWFwcGluZ3MuZm9yRWFjaChmdW5jdGlvbiAobWFwcGluZykge1xuICAgICAgX05hdGl2ZUFuaW1hdGVkSGVscGVyLmRlZmF1bHQuQVBJLmFkZEFuaW1hdGVkRXZlbnRUb1ZpZXcodmlld1RhZywgZXZlbnROYW1lLCBtYXBwaW5nKTtcbiAgICB9KTtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgZGV0YWNoOiBmdW5jdGlvbiBkZXRhY2goKSB7XG4gICAgICBpZiAodmlld1RhZyAhPSBudWxsKSB7XG4gICAgICAgIGV2ZW50TWFwcGluZ3MuZm9yRWFjaChmdW5jdGlvbiAobWFwcGluZykge1xuICAgICAgICAgIF9OYXRpdmVBbmltYXRlZEhlbHBlci5kZWZhdWx0LkFQSS5yZW1vdmVBbmltYXRlZEV2ZW50RnJvbVZpZXcodmlld1RhZywgZXZlbnROYW1lLCAvLyAkRmxvd0ZpeE1lW2luY29tcGF0aWJsZS1jYWxsXVxuICAgICAgICAgIG1hcHBpbmcuYW5pbWF0ZWRWYWx1ZVRhZyk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cbiAgfTtcbn1cblxuZnVuY3Rpb24gdmFsaWRhdGVNYXBwaW5nKGFyZ01hcHBpbmcsIGFyZ3MpIHtcbiAgdmFyIHZhbGlkYXRlID0gZnVuY3Rpb24gdmFsaWRhdGUocmVjTWFwcGluZywgcmVjRXZ0LCBrZXkpIHtcbiAgICBpZiAocmVjTWFwcGluZyBpbnN0YW5jZW9mIF9BbmltYXRlZFZhbHVlLmRlZmF1bHQpIHtcbiAgICAgICgwLCBfaW52YXJpYW50LmRlZmF1bHQpKHR5cGVvZiByZWNFdnQgPT09ICdudW1iZXInLCAnQmFkIG1hcHBpbmcgb2YgZXZlbnQga2V5ICcgKyBrZXkgKyAnLCBzaG91bGQgYmUgbnVtYmVyIGJ1dCBnb3QgJyArIHR5cGVvZiByZWNFdnQpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICh0eXBlb2YgcmVjRXZ0ID09PSAnbnVtYmVyJykge1xuICAgICAgKDAsIF9pbnZhcmlhbnQuZGVmYXVsdCkocmVjTWFwcGluZyBpbnN0YW5jZW9mIF9BbmltYXRlZFZhbHVlLmRlZmF1bHQsICdCYWQgbWFwcGluZyBvZiB0eXBlICcgKyB0eXBlb2YgcmVjTWFwcGluZyArICcgZm9yIGtleSAnICsga2V5ICsgJywgZXZlbnQgdmFsdWUgbXVzdCBtYXAgdG8gQW5pbWF0ZWRWYWx1ZScpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgICgwLCBfaW52YXJpYW50LmRlZmF1bHQpKHR5cGVvZiByZWNNYXBwaW5nID09PSAnb2JqZWN0JywgJ0JhZCBtYXBwaW5nIG9mIHR5cGUgJyArIHR5cGVvZiByZWNNYXBwaW5nICsgJyBmb3Iga2V5ICcgKyBrZXkpO1xuICAgICgwLCBfaW52YXJpYW50LmRlZmF1bHQpKHR5cGVvZiByZWNFdnQgPT09ICdvYmplY3QnLCAnQmFkIGV2ZW50IG9mIHR5cGUgJyArIHR5cGVvZiByZWNFdnQgKyAnIGZvciBrZXkgJyArIGtleSk7XG5cbiAgICBmb3IgKHZhciBtYXBwaW5nS2V5IGluIHJlY01hcHBpbmcpIHtcbiAgICAgIHZhbGlkYXRlKHJlY01hcHBpbmdbbWFwcGluZ0tleV0sIHJlY0V2dFttYXBwaW5nS2V5XSwgbWFwcGluZ0tleSk7XG4gICAgfVxuICB9O1xuXG4gICgwLCBfaW52YXJpYW50LmRlZmF1bHQpKGFyZ3MubGVuZ3RoID49IGFyZ01hcHBpbmcubGVuZ3RoLCAnRXZlbnQgaGFzIGxlc3MgYXJndW1lbnRzIHRoYW4gbWFwcGluZycpO1xuICBhcmdNYXBwaW5nLmZvckVhY2goZnVuY3Rpb24gKG1hcHBpbmcsIGlkeCkge1xuICAgIHZhbGlkYXRlKG1hcHBpbmcsIGFyZ3NbaWR4XSwgJ2FyZycgKyBpZHgpO1xuICB9KTtcbn1cblxudmFyIEFuaW1hdGVkRXZlbnQgPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkge1xuICBmdW5jdGlvbiBBbmltYXRlZEV2ZW50KGFyZ01hcHBpbmcsIGNvbmZpZykge1xuICAgIHRoaXMuX2xpc3RlbmVycyA9IFtdO1xuICAgIHRoaXMuX2FyZ01hcHBpbmcgPSBhcmdNYXBwaW5nO1xuXG4gICAgaWYgKGNvbmZpZyA9PSBudWxsKSB7XG4gICAgICBjb25zb2xlLndhcm4oJ0FuaW1hdGVkLmV2ZW50IG5vdyByZXF1aXJlcyBhIHNlY29uZCBhcmd1bWVudCBmb3Igb3B0aW9ucycpO1xuICAgICAgY29uZmlnID0ge1xuICAgICAgICB1c2VOYXRpdmVEcml2ZXI6IGZhbHNlXG4gICAgICB9O1xuICAgIH1cblxuICAgIGlmIChjb25maWcubGlzdGVuZXIpIHtcbiAgICAgIHRoaXMuX19hZGRMaXN0ZW5lcihjb25maWcubGlzdGVuZXIpO1xuICAgIH1cblxuICAgIHRoaXMuX2NhbGxMaXN0ZW5lcnMgPSB0aGlzLl9jYWxsTGlzdGVuZXJzLmJpbmQodGhpcyk7XG4gICAgdGhpcy5fYXR0YWNoZWRFdmVudCA9IG51bGw7XG4gICAgdGhpcy5fX2lzTmF0aXZlID0gKDAsIF9OYXRpdmVBbmltYXRlZEhlbHBlci5zaG91bGRVc2VOYXRpdmVEcml2ZXIpKGNvbmZpZyk7XG4gIH1cblxuICB2YXIgX3Byb3RvID0gQW5pbWF0ZWRFdmVudC5wcm90b3R5cGU7XG5cbiAgX3Byb3RvLl9fYWRkTGlzdGVuZXIgPSBmdW5jdGlvbiBfX2FkZExpc3RlbmVyKGNhbGxiYWNrKSB7XG4gICAgdGhpcy5fbGlzdGVuZXJzLnB1c2goY2FsbGJhY2spO1xuICB9O1xuXG4gIF9wcm90by5fX3JlbW92ZUxpc3RlbmVyID0gZnVuY3Rpb24gX19yZW1vdmVMaXN0ZW5lcihjYWxsYmFjaykge1xuICAgIHRoaXMuX2xpc3RlbmVycyA9IHRoaXMuX2xpc3RlbmVycy5maWx0ZXIoZnVuY3Rpb24gKGxpc3RlbmVyKSB7XG4gICAgICByZXR1cm4gbGlzdGVuZXIgIT09IGNhbGxiYWNrO1xuICAgIH0pO1xuICB9O1xuXG4gIF9wcm90by5fX2F0dGFjaCA9IGZ1bmN0aW9uIF9fYXR0YWNoKHZpZXdSZWYsIGV2ZW50TmFtZSkge1xuICAgICgwLCBfaW52YXJpYW50LmRlZmF1bHQpKHRoaXMuX19pc05hdGl2ZSwgJ09ubHkgbmF0aXZlIGRyaXZlbiBldmVudHMgbmVlZCB0byBiZSBhdHRhY2hlZC4nKTtcbiAgICB0aGlzLl9hdHRhY2hlZEV2ZW50ID0gYXR0YWNoTmF0aXZlRXZlbnQodmlld1JlZiwgZXZlbnROYW1lLCB0aGlzLl9hcmdNYXBwaW5nKTtcbiAgfTtcblxuICBfcHJvdG8uX19kZXRhY2ggPSBmdW5jdGlvbiBfX2RldGFjaCh2aWV3VGFnLCBldmVudE5hbWUpIHtcbiAgICAoMCwgX2ludmFyaWFudC5kZWZhdWx0KSh0aGlzLl9faXNOYXRpdmUsICdPbmx5IG5hdGl2ZSBkcml2ZW4gZXZlbnRzIG5lZWQgdG8gYmUgZGV0YWNoZWQuJyk7XG4gICAgdGhpcy5fYXR0YWNoZWRFdmVudCAmJiB0aGlzLl9hdHRhY2hlZEV2ZW50LmRldGFjaCgpO1xuICB9O1xuXG4gIF9wcm90by5fX2dldEhhbmRsZXIgPSBmdW5jdGlvbiBfX2dldEhhbmRsZXIoKSB7XG4gICAgdmFyIF90aGlzID0gdGhpcztcblxuICAgIGlmICh0aGlzLl9faXNOYXRpdmUpIHtcbiAgICAgIGlmIChfX0RFVl9fKSB7XG4gICAgICAgIHZhciBfdmFsaWRhdGVkTWFwcGluZyA9IGZhbHNlO1xuICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkge1xuICAgICAgICAgIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4pLCBfa2V5MiA9IDA7IF9rZXkyIDwgX2xlbjsgX2tleTIrKykge1xuICAgICAgICAgICAgYXJnc1tfa2V5Ml0gPSBhcmd1bWVudHNbX2tleTJdO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGlmICghX3ZhbGlkYXRlZE1hcHBpbmcpIHtcbiAgICAgICAgICAgIHZhbGlkYXRlTWFwcGluZyhfdGhpcy5fYXJnTWFwcGluZywgYXJncyk7XG4gICAgICAgICAgICBfdmFsaWRhdGVkTWFwcGluZyA9IHRydWU7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgX3RoaXMuX2NhbGxMaXN0ZW5lcnMuYXBwbHkoX3RoaXMsIGFyZ3MpO1xuICAgICAgICB9O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2NhbGxMaXN0ZW5lcnM7XG4gICAgICB9XG4gICAgfVxuXG4gICAgdmFyIHZhbGlkYXRlZE1hcHBpbmcgPSBmYWxzZTtcbiAgICByZXR1cm4gZnVuY3Rpb24gKCkge1xuICAgICAgZm9yICh2YXIgX2xlbjIgPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4yKSwgX2tleTMgPSAwOyBfa2V5MyA8IF9sZW4yOyBfa2V5MysrKSB7XG4gICAgICAgIGFyZ3NbX2tleTNdID0gYXJndW1lbnRzW19rZXkzXTtcbiAgICAgIH1cblxuICAgICAgaWYgKF9fREVWX18gJiYgIXZhbGlkYXRlZE1hcHBpbmcpIHtcbiAgICAgICAgdmFsaWRhdGVNYXBwaW5nKF90aGlzLl9hcmdNYXBwaW5nLCBhcmdzKTtcbiAgICAgICAgdmFsaWRhdGVkTWFwcGluZyA9IHRydWU7XG4gICAgICB9XG5cbiAgICAgIHZhciB0cmF2ZXJzZSA9IGZ1bmN0aW9uIHRyYXZlcnNlKHJlY01hcHBpbmcsIHJlY0V2dCwga2V5KSB7XG4gICAgICAgIGlmIChyZWNNYXBwaW5nIGluc3RhbmNlb2YgX0FuaW1hdGVkVmFsdWUuZGVmYXVsdCkge1xuICAgICAgICAgIGlmICh0eXBlb2YgcmVjRXZ0ID09PSAnbnVtYmVyJykge1xuICAgICAgICAgICAgcmVjTWFwcGluZy5zZXRWYWx1ZShyZWNFdnQpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgcmVjTWFwcGluZyA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgICBmb3IgKHZhciBtYXBwaW5nS2V5IGluIHJlY01hcHBpbmcpIHtcbiAgICAgICAgICAgIC8qICRGbG93Rml4TWUoPj0wLjEyMC4wKSBUaGlzIGNvbW1lbnQgc3VwcHJlc3NlcyBhbiBlcnJvciBmb3VuZFxuICAgICAgICAgICAgICogd2hlbiBGbG93IHYwLjEyMCB3YXMgZGVwbG95ZWQuIFRvIHNlZSB0aGUgZXJyb3IsIGRlbGV0ZSB0aGlzXG4gICAgICAgICAgICAgKiBjb21tZW50IGFuZCBydW4gRmxvdy4gKi9cbiAgICAgICAgICAgIHRyYXZlcnNlKHJlY01hcHBpbmdbbWFwcGluZ0tleV0sIHJlY0V2dFttYXBwaW5nS2V5XSwgbWFwcGluZ0tleSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9O1xuXG4gICAgICBfdGhpcy5fYXJnTWFwcGluZy5mb3JFYWNoKGZ1bmN0aW9uIChtYXBwaW5nLCBpZHgpIHtcbiAgICAgICAgdHJhdmVyc2UobWFwcGluZywgYXJnc1tpZHhdLCAnYXJnJyArIGlkeCk7XG4gICAgICB9KTtcblxuICAgICAgX3RoaXMuX2NhbGxMaXN0ZW5lcnMuYXBwbHkoX3RoaXMsIGFyZ3MpO1xuICAgIH07XG4gIH07XG5cbiAgX3Byb3RvLl9jYWxsTGlzdGVuZXJzID0gZnVuY3Rpb24gX2NhbGxMaXN0ZW5lcnMoKSB7XG4gICAgZm9yICh2YXIgX2xlbjMgPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4zKSwgX2tleTQgPSAwOyBfa2V5NCA8IF9sZW4zOyBfa2V5NCsrKSB7XG4gICAgICBhcmdzW19rZXk0XSA9IGFyZ3VtZW50c1tfa2V5NF07XG4gICAgfVxuXG4gICAgdGhpcy5fbGlzdGVuZXJzLmZvckVhY2goZnVuY3Rpb24gKGxpc3RlbmVyKSB7XG4gICAgICByZXR1cm4gbGlzdGVuZXIuYXBwbHkodm9pZCAwLCBhcmdzKTtcbiAgICB9KTtcbiAgfTtcblxuICByZXR1cm4gQW5pbWF0ZWRFdmVudDtcbn0oKTtcblxuZXhwb3J0cy5BbmltYXRlZEV2ZW50ID0gQW5pbWF0ZWRFdmVudDsiXX0=